<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Prometheus内容详解Prometheus 监控系统的架构图 官方文档：https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;introduction&#x2F;overview&#x2F;exporters:官方&#x2F;第三方提供的exporters： https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;instrumenting&#x2F;exporters&#x2F;自定义eporters：https:&#x2F;&#x2F;promet">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus内容详解">
<meta property="og:url" content="http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/index.html">
<meta property="og:site_name" content="LightningJie 的博客">
<meta property="og:description" content="Prometheus内容详解Prometheus 监控系统的架构图 官方文档：https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;introduction&#x2F;overview&#x2F;exporters:官方&#x2F;第三方提供的exporters： https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;instrumenting&#x2F;exporters&#x2F;自定义eporters：https:&#x2F;&#x2F;promet">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/architecture.jpg">
<meta property="article:published_time" content="2025-12-28T02:00:00.000Z">
<meta property="article:modified_time" content="2025-12-30T12:10:02.490Z">
<meta property="article:author" content="LightningJie">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/architecture.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Prometheus内容详解</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="LightningJie 的博客" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 8.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/LightningJie">GitHub</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2025/12/29/c++/cmake/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&text=Prometheus内容详解"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&is_video=false&description=Prometheus内容详解"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Prometheus内容详解&body=Check out this article: http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&name=Prometheus内容详解&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&t=Prometheus内容详解"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus%E5%86%85%E5%AE%B9%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">Prometheus内容详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.1.</span> <span class="toc-text">Prometheus 监控系统的架构图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E6%A8%A1%E5%9D%97"><span class="toc-number">1.1.1.</span> <span class="toc-text">框架模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Short-lived-jobs%EF%BC%88%E7%9F%AD%E6%9C%9F%E4%BD%9C%E4%B8%9A%EF%BC%89"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">Short - lived jobs（短期作业）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pushgateway"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Pushgateway</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service-discovery%EF%BC%88%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%89"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">Service discovery（服务发现）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.1.4.1.</span> <span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.1.4.2.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.1.4.3.</span> <span class="toc-text">关键组件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%97%A5%E5%BF%97"><span class="toc-number">1.1.1.4.4.</span> <span class="toc-text">监控与日志</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.1.4.5.</span> <span class="toc-text">实际应用场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file-sd"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">file_sd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus-server"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">Prometheus server</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Retrieval"><span class="toc-number">1.1.1.6.1.</span> <span class="toc-text">Retrieval</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TSDB%EF%BC%88Time-Series-Database%EF%BC%8C%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89"><span class="toc-number">1.1.1.6.2.</span> <span class="toc-text">TSDB（Time Series Database，时间序列数据库）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HTTP-server"><span class="toc-number">1.1.1.6.3.</span> <span class="toc-text">HTTP server</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exporter"><span class="toc-number">1.1.1.7.</span> <span class="toc-text">Exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">1.1.1.7.1.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.1.1.7.2.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.1.7.3.</span> <span class="toc-text">常见类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Exporter"><span class="toc-number">1.1.1.7.4.</span> <span class="toc-text">自定义 Exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#blackbox-exporter"><span class="toc-number">1.1.1.7.5.</span> <span class="toc-text">blackbox_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#consul-exporter"><span class="toc-number">1.1.1.7.6.</span> <span class="toc-text">consul_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#graphite-exporter"><span class="toc-number">1.1.1.7.7.</span> <span class="toc-text">graphite_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#memcached-exporter"><span class="toc-number">1.1.1.7.8.</span> <span class="toc-text">memcached_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mysqld-exporter"><span class="toc-number">1.1.1.7.9.</span> <span class="toc-text">mysqld_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#node-exporter"><span class="toc-number">1.1.1.7.10.</span> <span class="toc-text">node_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#statsd-exporter"><span class="toc-number">1.1.1.7.11.</span> <span class="toc-text">statsd_exporter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jobs-exporters%EF%BC%88%E4%BD%9C%E4%B8%9A-%E5%AF%BC%E5%87%BA%E5%99%A8%EF%BC%89"><span class="toc-number">1.1.1.8.</span> <span class="toc-text">Jobs&#x2F;exporters（作业 &#x2F; 导出器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node%EF%BC%88%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">1.1.1.9.</span> <span class="toc-text">Node（节点）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus-alerting"><span class="toc-number">1.1.1.10.</span> <span class="toc-text">Prometheus alerting</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AD%A6%E6%8A%A5%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.1.10.1.</span> <span class="toc-text">警报规则配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Alertmanager-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.1.10.2.</span> <span class="toc-text">Alertmanager 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AD%A6%E6%8A%A5%E6%8E%A5%E6%94%B6%E6%96%B9%E5%BC%8F"><span class="toc-number">1.1.1.10.3.</span> <span class="toc-text">警报接收方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PromQL"><span class="toc-number">1.1.1.11.</span> <span class="toc-text">PromQL</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.1.11.1.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.1.11.2.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">1.1.1.11.3.</span> <span class="toc-text">操作符</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.1.11.4.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.1.11.5.</span> <span class="toc-text">查询示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus-web-UI"><span class="toc-number">1.1.1.12.</span> <span class="toc-text">Prometheus web UI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Grafana"><span class="toc-number">1.1.1.13.</span> <span class="toc-text">Grafana</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API-clients%EF%BC%88API-%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89"><span class="toc-number">1.1.1.14.</span> <span class="toc-text">API clients（API 客户端）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8-1"><span class="toc-number">1.1.1.14.1.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84-API-%E5%AE%A2%E6%88%B7%E7%AB%AF8888"><span class="toc-number">1.1.1.14.2.</span> <span class="toc-text">常用的 API 客户端8888</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">1.1.1.14.3.</span> <span class="toc-text">优势</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E6%9D%A1%E9%83%A8%E5%88%86"><span class="toc-number">1.1.2.</span> <span class="toc-text">线条部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">Prometheus的数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E5%90%8D%E7%A7%B0%E5%92%8C%E6%A0%87%E7%AD%BE"><span class="toc-number">1.2.1.</span> <span class="toc-text">指标名称和标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E7%9A%84%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%EF%BC%884%E7%A7%8D%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">Prometheus的指标类型（4种）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Counter"><span class="toc-number">1.3.1.</span> <span class="toc-text">Counter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gauge"><span class="toc-number">1.3.2.</span> <span class="toc-text">Gauge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Histogram"><span class="toc-number">1.3.3.</span> <span class="toc-text">Histogram</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">举例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E8%A7%82%E6%B5%8B%E4%B8%8E%E6%A1%B6%E8%AE%A1%E6%95%B0"><span class="toc-number">1.3.3.1.1.</span> <span class="toc-text">样本观测与桶计数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E6%9A%B4%E9%9C%B2%E7%9A%84%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97"><span class="toc-number">1.3.3.1.2.</span> <span class="toc-text">直方图暴露的时间序列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%B8%B8%E8%A7%81%E7%94%A8%E9%80%94"><span class="toc-number">1.3.3.1.3.</span> <span class="toc-text">直方图的常见用途</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary-1888%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E9%BB%98%E8%AE%A4%E5%80%BC%EF%BC%8C%E3%80%90%E3%80%91"><span class="toc-number">1.3.4.</span> <span class="toc-text">Summary (1888滑动时间默认值，【】)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%98%E8%A6%81%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E7%94%A8%E9%80%94"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">摘要的定义和用途</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%98%E8%A6%81%E6%9A%B4%E9%9C%B2%E7%9A%84%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">摘要暴露的时间序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%CF%86-%E5%88%86%E4%BD%8D%E6%95%B0"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">φ-分位数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%98%E8%A6%81%E4%B8%8E%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">摘要与直方图的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%91%98%E8%A6%81"><span class="toc-number">1.3.4.5.</span> <span class="toc-text">使用摘要</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AA%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.5.</span> <span class="toc-text">指标类型为什么只在客户端分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%9C%E5%AE%89%E8%A3%85%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%E2%80%9D-%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">“安装指标类型” 的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E6%97%B6%E4%B8%8D%E5%8C%BA%E5%88%86%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">内部存储时不区分指标类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="toc-number">1.4.2.</span> <span class="toc-text">指标类型信息的记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E5%85%B3%E8%81%94"><span class="toc-number">1.4.3.</span> <span class="toc-text">元数据的存储与关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%92%8C%E5%B1%95%E7%A4%BA%E6%97%B6%E5%88%A9%E7%94%A8%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.4.</span> <span class="toc-text">查询和展示时利用类型信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E7%B1%BB%E6%AF%94"><span class="toc-number">1.4.5.</span> <span class="toc-text">过程类比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">Prometheus部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">2.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2prometheus"><span class="toc-number">2.2.</span> <span class="toc-text">安装部署prometheus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsystemd%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.</span> <span class="toc-text">创建systemd服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#systemctl-%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.1.</span> <span class="toc-text">systemctl 命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7Linux%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.4.</span> <span class="toc-text">监控Linux服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.</span> <span class="toc-text">全局配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#evaluation"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">evaluation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%E8%AF%84%E4%BC%B0"><span class="toc-number">2.5.1.1.1.</span> <span class="toc-text">记录规则评估</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E8%AF%84%E4%BC%B0"><span class="toc-number">2.5.1.1.2.</span> <span class="toc-text">告警规则评估</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#external-labels"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">external_labels</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8E-Alertmanager-%E9%80%9A%E4%BF%A1%E6%97%B6%E6%A0%87%E7%AD%BE%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.5.1.2.1.</span> <span class="toc-text">与 Alertmanager 通信时标签的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8E%E8%BF%9C%E7%A8%8B%E5%AD%98%E5%82%A8%E9%80%9A%E4%BF%A1%E6%97%B6%E6%A0%87%E7%AD%BE%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.5.1.2.2.</span> <span class="toc-text">与远程存储通信时标签的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E6%90%BA%E5%B8%A6%E6%A0%87%E7%AD%BE%E9%94%99%E8%AF%AF"><span class="toc-number">2.5.1.2.3.</span> <span class="toc-text">避免携带标签错误</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#query-log-file"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">query_log_file</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#scrape-config-files"><span class="toc-number">2.5.1.4.</span> <span class="toc-text">scrape_config_files</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E5%88%97%E8%A1%A8"><span class="toc-number">2.5.1.4.1.</span> <span class="toc-text">通配符列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%BD%E5%8A%A0%E5%88%B0%E6%8A%93%E5%8F%96%E9%85%8D%E7%BD%AE%E5%88%97%E8%A1%A8"><span class="toc-number">2.5.1.4.2.</span> <span class="toc-text">配置追加到抓取配置列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">2.5.1.4.3.</span> <span class="toc-text">示例说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alerting"><span class="toc-number">2.5.1.5.</span> <span class="toc-text">alerting</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#alert-relabel-configs"><span class="toc-number">2.5.1.5.1.</span> <span class="toc-text">alert_relabel_configs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#alertmanagers"><span class="toc-number">2.5.1.5.2.</span> <span class="toc-text">alertmanagers</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AAalertmanagers"><span class="toc-number">2.5.1.5.3.</span> <span class="toc-text">配置多个alertmanagers</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#storage"><span class="toc-number">2.5.1.6.</span> <span class="toc-text">storage</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#tsdb-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.6.1.</span> <span class="toc-text">tsdb 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#exemplars-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.6.2.</span> <span class="toc-text">exemplars 配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scrape-config"><span class="toc-number">2.5.2.</span> <span class="toc-text">scrape_config</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#params"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">params</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.6.</span> <span class="toc-text">查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0-1"><span class="toc-number">2.6.1.</span> <span class="toc-text">函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">2.7.</span> <span class="toc-text">存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E5%B8%83%E5%B1%80"><span class="toc-number">2.7.1.</span> <span class="toc-text">磁盘布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.7.2.</span> <span class="toc-text">数据目录示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%9D%97%E5%8F%AA%E6%9C%89-meta-json-%E6%96%87%E4%BB%B6%E8%80%8C%E6%97%A0%E5%85%B6%E4%BB%96%E6%96%87%E4%BB%B6%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">2.7.3.</span> <span class="toc-text">部分块只有 meta.json 文件而无其他文件的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8E%8B%E5%AE%9E"><span class="toc-number">2.7.4.</span> <span class="toc-text">数据压实</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.5.</span> <span class="toc-text">本地存储配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F%E5%A4%84%E7%90%86"><span class="toc-number">2.7.6.</span> <span class="toc-text">容量规划与数据损坏处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E7%AD%96%E7%95%A5"><span class="toc-number">2.7.7.</span> <span class="toc-text">保留策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%AD%98%E5%82%A8%E9%9B%86%E6%88%90"><span class="toc-number">2.7.8.</span> <span class="toc-text">远程存储集成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">2.8.</span> <span class="toc-text">服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%88File-Based-SD%EF%BC%89"><span class="toc-number">2.8.1.</span> <span class="toc-text">文件服务发现（File - Based SD）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes-%E5%8F%91%E7%8E%B0"><span class="toc-number">2.8.2.</span> <span class="toc-text">Kubernetes 发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%88HTTP-SD%EF%BC%89"><span class="toc-number">2.8.3.</span> <span class="toc-text">HTTP 服务发现（HTTP SD）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consul%E5%8F%91%E7%8E%B0"><span class="toc-number">2.8.4.</span> <span class="toc-text">consul发现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#relabeling"><span class="toc-number">2.9.</span> <span class="toc-text">relabeling</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.9.1.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.9.2.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E9%87%8D%E6%96%B0%E6%A0%87%E8%AE%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.9.3.</span> <span class="toc-text">常用的重新标记配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.9.4.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus%E5%AE%9E%E6%88%98"><span class="toc-number">3.</span> <span class="toc-text">Prometheus实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%91%E6%8E%A7"><span class="toc-number">3.1.</span> <span class="toc-text">Linux服务器监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85node-exporter"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.服务器安装node_exporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B8%B8%E7%94%A8%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">3.1.2.</span> <span class="toc-text">2.常用监控指标</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E7%9B%91%E6%8E%A7"><span class="toc-number">3.2.</span> <span class="toc-text">mysql监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.1.</span> <span class="toc-text">参数详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">3.2.2.</span> <span class="toc-text">常用监控指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">3.2.3.</span> <span class="toc-text">告警规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7"><span class="toc-number">3.3.</span> <span class="toc-text">黑盒监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-HTTP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.1.</span> <span class="toc-text">1. HTTP 探测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http-2xx%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">http_2xx配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http-post-2xx-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">http_post_2xx 配置示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-TCP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.2.</span> <span class="toc-text">2. TCP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ICMP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.3.</span> <span class="toc-text">3. ICMP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-DNS-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.4.</span> <span class="toc-text">4. DNS 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-SMTP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.5.</span> <span class="toc-text">5. SMTP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-POP3-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.6.</span> <span class="toc-text">6. POP3 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-IMAP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.7.</span> <span class="toc-text">7. IMAP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">3.3.8.</span> <span class="toc-text">部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pushgateway-1"><span class="toc-number">3.4.</span> <span class="toc-text">Pushgateway</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#curl-%E6%8E%A8%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">3.4.1.</span> <span class="toc-text">curl 推送消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python-%E6%8E%A8%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">3.4.2.</span> <span class="toc-text">python  推送消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.</span> <span class="toc-text">告警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%AE%E7%AE%B1%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.1.</span> <span class="toc-text">邮箱告警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.2.</span> <span class="toc-text">企业钉钉告警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.3.</span> <span class="toc-text">企业微信告警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A3%9E%E4%B9%A6%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.4.</span> <span class="toc-text">飞书告警</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%93%BE%E6%8E%A5%EF%BC%9A"><span class="toc-number">3.5.4.1.</span> <span class="toc-text">项目链接：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">3.5.4.2.</span> <span class="toc-text">使用方式：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%EF%BC%9A"><span class="toc-number">3.5.4.3.</span> <span class="toc-text">特性：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E7%AD%94%EF%BC%9A"><span class="toc-number">3.6.</span> <span class="toc-text">问题解答：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A3%9E%E4%B9%A6%E5%91%8A%E8%AD%A6%E5%B7%A5%E5%85%B7%EF%BC%9Aalertmanager-webhook-feishu"><span class="toc-number">3.6.1.</span> <span class="toc-text">一、飞书告警工具：alertmanager-webhook-feishu</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%93%BE%E6%8E%A5%EF%BC%9A-1"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">项目链接：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A-1"><span class="toc-number">3.6.1.2.</span> <span class="toc-text">使用方式：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%EF%BC%9A-1"><span class="toc-number">3.6.1.3.</span> <span class="toc-text">特性：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E7%9A%84%E5%91%8A%E8%AD%A6%E9%9B%86%E6%88%90%E5%B7%A5%E5%85%B7"><span class="toc-number">3.6.2.</span> <span class="toc-text">二、其他常用软件的告警集成工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%92%89%E9%92%89%EF%BC%9Aprometheus-webhook-dingtalk"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">1. 钉钉：prometheus-webhook-dingtalk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%EF%BC%9Awebhook-wechat"><span class="toc-number">3.6.2.2.</span> <span class="toc-text">2. 企业微信：webhook-wechat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Slack%EF%BC%9A%E5%AE%98%E6%96%B9-Webhook-%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.3.</span> <span class="toc-text">3. Slack：官方 Webhook 集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Microsoft-Teams%EF%BC%9A%E5%AE%98%E6%96%B9-Webhook-%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.4.</span> <span class="toc-text">4. Microsoft Teams：官方 Webhook 集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Email%EF%BC%9AAlertmanager-%E5%86%85%E7%BD%AE%E6%94%AF%E6%8C%81"><span class="toc-number">3.6.2.5.</span> <span class="toc-text">5. Email：Alertmanager 内置支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-PagerDuty%EF%BC%9A%E5%AE%98%E6%96%B9%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.6.</span> <span class="toc-text">6. PagerDuty：官方集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-Opsgenie%EF%BC%9A%E5%AE%98%E6%96%B9%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.7.</span> <span class="toc-text">7. Opsgenie：官方集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-Telegram%EF%BC%9A%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7-prometheus-alertmanager-telegram"><span class="toc-number">3.6.2.8.</span> <span class="toc-text">8. Telegram：第三方工具 prometheus-alertmanager-telegram</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%80%9A%E7%94%A8%E9%9B%86%E6%88%90%E6%96%B9%E6%A1%88%EF%BC%9AWebhook-%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">3.6.3.</span> <span class="toc-text">三、通用集成方案：Webhook 自定义</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Prometheus内容详解
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">LightningJie</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-12-28T02:00:00.000Z" class="dt-published" itemprop="datePublished">2025-12-28</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">实用工具</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="Prometheus内容详解"><a href="#Prometheus内容详解" class="headerlink" title="Prometheus内容详解"></a>Prometheus内容详解</h1><h2 id="Prometheus-监控系统的架构图"><a href="#Prometheus-监控系统的架构图" class="headerlink" title="Prometheus 监控系统的架构图"></a>Prometheus 监控系统的架构图</h2><p><img src="/../../images/architecture.jpg"></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/">https://prometheus.io/docs/introduction/overview/</a><br>exporters:<br>官方&#x2F;第三方提供的exporters： <a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a><br>自定义eporters：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/writing_exporters/">https://prometheus.io/docs/instrumenting/writing_exporters/</a><br>alert:<br>官方示例：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/notification_examples/">https://prometheus.io/docs/alerting/latest/notification_examples/</a><br>第三方提供的alert规则：<a target="_blank" rel="noopener" href="https://samber.github.io/awesome-prometheus-alerts/">https://samber.github.io/awesome-prometheus-alerts/</a><br>docker部署：<a target="_blank" rel="noopener" href="https://gitee.com/LightningJie/docker-prometheus/blob/main/docker-compose.yaml">https://gitee.com/LightningJie/docker-prometheus/blob/main/docker-compose.yaml</a></p>
<h3 id="框架模块"><a href="#框架模块" class="headerlink" title="框架模块"></a>框架模块</h3><h4 id="Short-lived-jobs（短期作业）"><a href="#Short-lived-jobs（短期作业）" class="headerlink" title="Short - lived jobs（短期作业）"></a>Short - lived jobs（短期作业）</h4><p>​	这类作业生命周期较短，在退出时将指标数据推送到 Pushgateway。</p>
<p>​	在数据库场景中，比如每天凌晨执行的数据库日志清理脚本，它在运行结束时，需要将执行过程中的相关指标（如处理的日志文件数量、删除的记录行数等）推送到 Pushgateway。由于其生命周期短，Prometheus 难以直接定时拉取指标，所以采用推送的方式</p>
<p>​	<strong>数据库数据初始化与加载、数据库备份与归档、数据库数据清理与维护、数据库性能测试相关作业、数据库脚本执行作业</strong></p>
<h4 id="Pushgateway"><a href="#Pushgateway" class="headerlink" title="Pushgateway"></a>Pushgateway</h4><ul>
<li>Prometheus 采用 pull 模式，可能由于<strong>不在一个子网或者防火墙原因</strong>，导致 Prometheus 无法直接拉取各个 target 数据。</li>
<li>在监控业务数据的时候，需要将不同<strong>数据汇总</strong>888，由 Prometheus 统一收集。</li>
<li>当 exporter 不能满足需要时，也可以通过<strong>自定义（python、shell、java）监控</strong>我们想要的数据。</li>
</ul>
<p>由于以上原因，不得不使用 pushgateway ，但在使用之前，有必要了解一下它的一些弊端：</p>
<ul>
<li>将多个节点数据汇总到 pushgateway，如果 pushgateway 挂了，受影响比多个 target 大。</li>
<li>Prometheus 拉取状态 up 只针对 pushgateway，无法做到对每个节点有效。</li>
<li>Pushgateway 可以<strong>持久化</strong>推送给它的所有监控数据。</li>
</ul>
<p>因此，即使你的监控已经下线，prometheus 还会拉取到旧的监控数据，需要手动清理 pushgateway 不要的数据。</p>
<p>作为短期作业推送指标的中间缓存层。它接收短期作业推送过来的指标，并为 Prometheus server 提供拉取指标的接口，解决 Prometheus 难以直接抓取短期作业指标的问题。</p>
<p>​	短期作业集成相应的<strong>客户端库（如 Prometheus 客户端库）</strong>，在作业内部代码中定义要收集的指标，并在合适的时机（如作业结束时）将这些指标数据推送到 Pushgateway 指定的端点。Pushgateway 会存储这些指标，并为每个推送作业生成唯一的标识（通常基于作业名称和一些标签）。Prometheus 则通过配置文件指定 Pushgateway 的地址和相关作业的标识，定期从 Pushgateway 拉取指标数据，然后将其存储到自身的时间序列数据库（TSDB）中进行后续的分析、告警等操作。</p>
<h4 id="Service-discovery（服务发现）"><a href="#Service-discovery（服务发现）" class="headerlink" title="Service discovery（服务发现）"></a>Service discovery（服务发现）</h4><p>​	Service discovery 是一种<strong>自动发现和管理被监控目标</strong>的机制，它允许 Prometheus 动态地识别需要收集指标的目标服务器或服务，而无需手动逐个配置</p>
<h4 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h4><p>​	通过 Kubernetes 进行服务发现，能自动发现 Kubernetes 集群中的服务作为监控目标。</p>
<p>​	<strong>Kubernetes</strong>：是一个<strong>容器编排系统</strong>，主要用于<strong>管理和协调多个容器化应用程序在集群环境中的运行</strong>。它提供了诸如自动部署、弹性伸缩、服务发现、负载均衡、故障恢复等一系列功能，帮助用户更高效地管理大规模的容器化应用。比如，在一个电商网站的架构中，Kubernetes 可以管理包括前端服务器、后端 API 服务器、数据库服务器等多个不同类型的容器，并根据业务负载自动调整这些容器的数量和分布。</p>
<ul>
<li>数据库资源监控<ul>
<li>Kubernetes 可以将数据库相关的容器、Pod、节点等资源纳入监控范畴，通过 Prometheus 采集这些资源的 CPU、内存、磁盘 I&#x2F;O、网络流量等指标，帮助运维人员实时了解数据库服务器的资源使用情况，及时发现资源瓶颈，例如当数据库服务器的 CPU 使用率持续过高时，可能意味着查询负载过重，需要进行优化。</li>
<li>对于运行在 Kubernetes 集群中的数据库，还能监控其副本数量、健康状态等指标，确保数据库的高可用性和容错能力。比如，当某个数据库 Pod 出现故障时，Kubernetes 可以自动重启或重新调度该 Pod，并通过 Prometheus 及时反馈相关状态变化。</li>
</ul>
</li>
<li>数据库性能监测<ul>
<li>Prometheus 结合 Kubernetes 可以对数据库的性能指标进行采集和分析，如数据库的查询执行时间、连接数、事务处理速度等。通过分析这些指标，可以发现数据库性能问题的根源，如慢查询、锁竞争等，从而进行针对性的优化。</li>
<li>借助 Kubernetes 的资源隔离和调度机制，可以确保数据库在不同的负载情况下都能获得稳定的资源分配，避免因资源竞争导致的性能波动。同时，Prometheus 可以实时监测资源分配对数据库性能的影响，为调整资源配置提供依据。</li>
</ul>
</li>
<li>服务发现与动态配置<ul>
<li>Kubernetes 的服务发现机制能够让 <strong>Prometheus 自动发现新部署的数据库实例</strong>，无需手动配置监控目标。当在 Kubernetes 集群中新增或删除数据库 Pod 时，Prometheus 可以及时更新监控目标列表，保证监控的连续性和完整性。</li>
<li>通过 Kubernetes 的配置管理功能，可以方便地为数据库应用配置不同的监控参数和告警规则。例如，根据不同的数据库类型、业务场景或性能要求，为 Prometheus 配置相应的指标采集频率、告警阈值等，实现精细化的监控和管理。</li>
</ul>
</li>
<li>数据库集群管理<ul>
<li>在数据库集群环境中，Kubernetes 可以协调数据库节点之间的通信和数据同步，确保集群的一致性和稳定性。Prometheus 可以监控集群的关键指标，如节点间的心跳、数据复制延迟等，帮助运维人员及时发现集群中的异常情况。</li>
<li>当数据库集群需要进行扩展或收缩时，Kubernetes 可以根据预设的规则自动调整集群规模，并通过 Prometheus 提供的指标数据来评估扩展或收缩的效果，确保集群性能始终满足业务需求。</li>
</ul>
</li>
</ul>
<h5 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h5><ul>
<li><strong>Pod</strong>：Kubernetes 中最小的可部署和可管理的计算单元，它可以包含<strong>一个或多个</strong>紧密相关的容器。这些容器<strong>共享网络命名空间和存储卷</strong>，它们在同一个 Pod 中可以方便地进行通信和协作。例如，一个 Web 应用容器和一个数据库容器可以放在同一个 Pod 中，Web 应用容器通过本地网络访问数据库容器。</li>
<li><strong>Service</strong>：定义了一组 Pod 的逻辑集合以及访问它们的策略。Service 提供了一个稳定的 IP 地址和端口，使得其他组件可以通过这个固定的地址来访问 Pod，而无需关心 Pod 的实际 IP 地址和它们的动态变化。</li>
<li><strong>Deployment</strong>：用于描述应用程序的部署方式和策略，包括<strong>如何创建、更新和扩展 Pod</strong>。通过 Deployment，可以方便地管理应用程序的版本升级、回滚等操作，确保应用程序按照期望的状态运行。例如，你可以通过修改 Deployment 的配置来更新应用程序的版本，Kubernetes 会自动按照指定的策略进行升级。</li>
<li><strong>Namespace</strong>：提供了一种将集群资源划分为不同逻辑隔离空间的方式。不同 Namespace 中的资源名称可以相同，这样可以在同一个集群中为不同的团队、项目或环境创建独立的资源空间，实现资源的隔离和管理。</li>
</ul>
<h5 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h5><ul>
<li><strong>资源管理</strong>：Kubernetes 通过控制平面来管理集群中的资源。控制平面会根据用户定义的资源需求和策略，将 Pod 调度到合适的工作节点上运行。同时，控制平面还会监控 Pod 的运行状态，确保它们始终处于期望的状态。如果某个 Pod 出现故障，控制平面会自动重新调度该 Pod 到其他可用节点上。</li>
<li><strong>服务发现与负载均衡</strong>：Service 通过标签选择器来关联后端的 Pod，并为这些 Pod 提供一个统一的访问入口。当客户端发送请求到 Service 时，Service 会根据负载均衡算法将请求分发到后端的 Pod 上。Kubernetes 支持多种负载均衡算法，如轮询、加权轮询等，以满足不同应用场景的需求。</li>
<li><strong>自动扩展</strong>：Kubernetes 可以根据应用程序的负载情况自动扩展或收缩 Pod 的数量。通过使用 Horizontal Pod Autoscaler（HPA），可以根据 CPU 使用率、内存使用率等指标来自动调整 Deployment 中 Pod 的副本数量。例如，当应用程序的负载增加时，HPA 会自动增加 Pod 的数量，以提高应用程序的处理能力；当负载降低时，HPA 会自动减少 Pod 的数量，节省资源。</li>
</ul>
<h5 id="关键组件"><a href="#关键组件" class="headerlink" title="关键组件"></a>关键组件</h5><ul>
<li><strong>etcd</strong>：它是一个高可用的键值对存储系统，用于保存 Kubernetes 集群的所有配置信息和状态数据。例如，集群中各个节点的信息、Pod 的定义、Service 的配置等都存储在 etcd 中。etcd 确保这些数据的一致性和可靠性，为 Kubernetes 集群的正常运行提供了基础支撑。</li>
<li><strong>kube - apiserver</strong>：作为 Kubernetes 的核心组件，它提供了 RESTful API 接口，是集群内外各个组件与 Kubernetes 集群进行交互的唯一入口。无论是用户通过命令行工具 kubectl，还是其他自动化工具，都需要通过 kube - apiserver 来提交请求，实现对集群资源的管理，如创建、删除、更新 Pod、Service 等操作。</li>
<li><strong>kube - scheduler</strong>：负责将 Pod 分配到集群中的合适节点上运行。它会根据一系列的调度算法和策略，考虑节点的资源状况（如 CPU、内存）、Pod 的资源需求、节点的亲和性和反亲和性等因素，以确保 Pod 能够在满足其要求的节点上高效运行。</li>
<li><strong>kube - controller - manager</strong>：包含多个控制器，这些控制器负责管理集群中各种资源的状态，确保实际状态与用户定义的期望状态一致。例如，副本控制器（Replica Controller）用于确保指定数量的 Pod 副本始终在运行；节点控制器（Node Controller）负责监控节点的状态，当节点出现故障时进行相应的处理。</li>
<li><strong>kube - proxy</strong>：运行在每个节点上，主要负责实现 Service 的网络代理和负载均衡功能。它会在节点上设置 iptables 规则或使用其他网络代理方式，将发往 Service 的流量转发到后端实际的 Pod 上，从而实现对 Pod 的访问和负载均衡。</li>
</ul>
<h5 id="监控与日志"><a href="#监控与日志" class="headerlink" title="监控与日志"></a>监控与日志</h5><ul>
<li><strong>监控</strong>：Kubernetes 提供了多种监控方式，通过集成 Prometheus、Grafana 等监控工具，可以对集群的资源使用情况（如 CPU、内存、网络流量）、Pod 和容器的运行状态、应用程序的性能指标等进行实时监控和分析。用户可以通过监控数据及时发现集群中的问题，并进行相应的调整和优化。</li>
<li><strong>日志</strong>：容器内的日志可以通过多种方式进行收集和管理，如使用 Fluentd、Elasticsearch 和 Kibana（EFK）组合等。这些工具可以将容器的日志收集起来，进行集中存储和分析，方便用户查看和排查应用程序的故障和问题。</li>
</ul>
<h5 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h5><ul>
<li><strong>微服务架构</strong>：Kubernetes 非常适合用于管理微服务架构的应用程序。每个微服务可以被打包成一个容器，并通过 Kubernetes 进行部署、扩展和管理。Kubernetes 可以方便地实现微服务之间的通信、负载均衡和服务发现，使得微服务架构的应用程序更加易于维护和扩展。</li>
<li><strong>持续集成与持续部署（CI&#x2F;CD）</strong>：Kubernetes 可以与 CI&#x2F;CD 工具集成，实现应用程序的自动化部署和更新。当开发人员提交代码后，CI&#x2F;CD 工具可以自动构建容器镜像，并将其部署到 Kubernetes 集群中。通过使用 Deployment 和相关的更新策略，可以实现应用程序的快速迭代和上线。</li>
<li><strong>云原生应用开发</strong>：Kubernetes 是云原生应用开发的核心技术之一。它提供了一个弹性、可扩展和高可用的平台，使得开发人员可以专注于应用程序的业务逻辑，而无需关心底层的基础设施管理。云原生应用可以充分利用 Kubernetes 的特性，如容器化、自动化部署和服务发现，以实现快速开发、部署和运维。</li>
</ul>
<h4 id="file-sd"><a href="#file-sd" class="headerlink" title="file_sd"></a>file_sd</h4><p>基于文件的服务发现机制，通过读取配置文件来确定监控目标。<code>file_sd</code>通过指定一个或多个包含目标信息的文件，Prometheus 会定期读取这些文件，解析其中的目标配置，并根据配置动态地添加或删除监控目标。这些文件通常采用 JSON 或 YAML 格式来描述目标的相关信息，如目标的地址、端口、标签等。</p>
<p><strong>配置示例</strong></p>
<p>假设你有一个 Kubernetes 集群，其中有几个需要监控的应用服务，你可以使用<code>file_sd</code>来配置 Prometheus 对这些服务进行监控。以下是一个简单的 YAML 格式的<code>file_sd</code>配置示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes - services&#x27;</span></span><br><span class="line">  <span class="attr">file_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/etc/prometheus/targets/kubernetes - services - targets.yaml&#x27;</span></span><br><span class="line">    <span class="attr">refresh_interval:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure>

<p>在上述配置中，<code>job_name</code>定义了监控任务的名称，<code>file_sd_configs</code>下的<code>files</code>字段指定了包含目标信息的文件路径，<code>refresh_interval</code>表示 Prometheus 读取文件的时间间隔，这里设置为 10 秒。</p>
<p>接下来是<code>kubernetes - services - targets.yaml</code>文件的内容示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;10.0.0.1:8080&#x27;</span>, <span class="string">&#x27;10.0.0.2:8080&#x27;</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#x27;my - app&#x27;</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">&#x27;prod&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;10.0.0.3:9090&#x27;</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#x27;another - app&#x27;</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">&#x27;test&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这个文件中定义了两个监控目标组。第一个目标组包含两个目标，地址分别是<code>10.0.0.1:8080</code>和<code>10.0.0.2:8080</code>，它们都属于名为<code>my - app</code>的应用，并且运行在<code>prod</code>环境中。第二个目标组只有一个目标<code>10.0.0.3:9090</code>，属于<code>another - app</code>应用，运行在<code>test</code>环境中。</p>
<p>当 Prometheus 启动后，它会按照配置的<code>refresh_interval</code>定期读取<code>kubernetes - services - targets.yaml</code>文件，根据其中的内容发现并监控这些目标。如果文件中的目标信息发生变化，Prometheus 会自动更新监控目标，无需手动重启 Prometheus 服务。</p>
<h4 id="Prometheus-server"><a href="#Prometheus-server" class="headerlink" title="Prometheus server"></a>Prometheus server</h4><h5 id="Retrieval"><a href="#Retrieval" class="headerlink" title="Retrieval"></a>Retrieval</h5><ul>
<li><strong>功能</strong>：该模块是 Prometheus Server 与各种数据源之间的<strong>桥梁</strong>，负责从 Pushgateway、Jobs&#x2F;exporters 等目标拉取指标数据。它支持多种数据采集方式，以适应不同的应用场景和技术架构。</li>
<li>工作原理：<ul>
<li><strong>配置解析</strong>：首先，Retrieval 模块会读取 Prometheus Server 的配置文件，其中定义了各种 Job 和 Target 的信息。Job 是一组相关 Target 的集合，每个 Target 都对应一个具体的数据源，例如一个运行着 Exporter 的服务器地址和端口。</li>
<li><strong>定时拉取</strong>：根据配置的时间间隔（默认为 15 秒），Retrieval 模块会为每个 Target <strong>创建一个 HTTP 请求</strong>，向其暴露的指标端点发送请求以获取数据。对于 Pushgateway，它会从指定的 Pushgateway 地址拉取由客户端主动推送过来的数据；对于 Jobs&#x2F;exporters，它会按照配置的目标地址和端口，向相应的 Exporter 发送请求，Exporter 则会将其所监控的应用程序或系统的指标数据以 Prometheus 特定的格式返回。</li>
<li><strong>数据处理</strong>：接收到数据后，Retrieval 模块会对数据进行初步的处理和验证，确保数据的格式正确且符合 Prometheus 的规范。例如，它会检查数据中的指标名称、标签是否合法，时间戳是否准确等。如果数据存在问题，会记录相应的错误信息，并根据配置决定是否继续处理或丢弃该数据。</li>
</ul>
</li>
<li><strong>作用</strong>：通过定期从各个数据源拉取指标数据，Retrieval 模块为 Prometheus Server 提供了实时、准确的监控数据，是整个监控系统能够正常运行的基础。它确保了 Prometheus 能够及时获取到系统中各个组件的运行状态信息，为后续的数据分析、告警以及可视化展示提供了数据支持。</li>
</ul>
<h5 id="TSDB（Time-Series-Database，时间序列数据库）"><a href="#TSDB（Time-Series-Database，时间序列数据库）" class="headerlink" title="TSDB（Time Series Database，时间序列数据库）"></a>TSDB（Time Series Database，时间序列数据库）</h5><ul>
<li><strong>功能</strong>：TSDB 是 Prometheus Server 用于<strong>存储时间序列指标数据</strong>的核心模块，它以高效、紧凑的方式存储大量的监控数据，并支持快速的数据查询和检索，以便用户能够及时获取到历史数据进行分析和比较。</li>
<li>工作原理：<ul>
<li><strong>数据结构</strong>：在 TSDB 中，时间序列数据以键值对的形式存储，其中键由指标名称和一组标签组成，用于唯一标识一个时间序列，值则是一系列的时间戳 - 值对，表示该时间序列在不同时间点上的取值。例如，对于一个监控服务器 CPU 使用率的指标，指标名称可能是 “cpu_usage_percentage”，标签可能包括 “instance”（服务器实例名称）、“job”（所属的 Job 名称）等，而时间戳 - 值对则记录了不同时间点上 CPU 的使用率。</li>
<li><strong>数据存储</strong>：TSDB 将数据分为<strong>多个块（Block）进行存储</strong>，每个块包含了一定时间范围内的数据。默认情况下，<strong>每个块的时间范围是 2 小时</strong>。数据在写入块时，会先进行压缩处理，以减少存储空间占用。Prometheus 使用了多种压缩算法，如 Delta-of-Deltas 编码等，对数据进行高效压缩。同时，为了提高查询性能，TSDB 还会为每个块建立索引，包括时间索引和标签索引，使得在查询数据时能够快速定位到包含所需数据的块。</li>
<li><strong>数据查询</strong>：当收到查询请求时，TSDB 会根据查询条件解析出需要查询的时间范围和指标名称、标签等信息。然后，它会利用索引快速定位到包含相关数据的块，并从这些块中读取数据。在读取数据后，TSDB 会根据查询要求对数据进行进一步的处理，如聚合、过滤等操作，最后将处理结果返回给查询和告警模块或其他请求方。</li>
</ul>
</li>
<li><strong>作用</strong>：TSDB 的存在使得 Prometheus Server 能够存储大量的历史监控数据，为用户提供了强大的数据分析和追溯能力。用户可以通过查询 TSDB 获取系统在过去一段时间内的运行趋势，分析性能瓶颈，以及检测异常行为。同时，它的高效存储和查询机制保证了在处理大规模数据时，Prometheus 仍然能够保持较高的性能和响应速度。</li>
</ul>
<h5 id="HTTP-server"><a href="#HTTP-server" class="headerlink" title="HTTP server"></a>HTTP server</h5><ul>
<li><strong>功能</strong>：HTTP server 是 Prometheus Server 对外提供服务的接口，它通过 HTTP 协议提供了一系列的 API 和 Web 界面，用于 Prometheus web UI、API clients 等进行数据访问和交互。用户可以通过 HTTP 请求发送查询语句、获取监控数据、查看系统状态，以及进行一些配置管理操作等。</li>
<li>工作原理：<ul>
<li><strong>请求监听</strong>：HTTP server 在启动时会绑定到指定的端口（默认为 9090），开始监听来自客户端的 HTTP 请求。它使用了 Go 语言的标准 HTTP 库来处理网络连接和请求解析。</li>
<li><strong>路由处理</strong>：当收到一个 HTTP 请求时，HTTP server 会根据请求的 URL 路径和方法来确定对应的处理函数。例如，对于以 “&#x2F;api&#x2F;v1&#x2F;query” 开头的请求，通常是用于执行 PromQL 查询的 API，服务器会调用相应的查询处理函数；对于以 “&#x2F;graph” 开头的请求，则会返回 Prometheus web UI 的图表页面。</li>
<li><strong>查询处理</strong>：如果是一个查询请求，HTTP server 会从请求中解析出 PromQL 查询语句，并将其传递给查询引擎进行处理。查询引擎会与 TSDB 进行交互，获取所需的数据，并对数据进行计算和处理。处理完成后，HTTP server 会将结果以 JSON 格式返回给客户端。</li>
<li><strong>Web 界面渲染</strong>：对于 Prometheus web UI 的请求，HTTP server 会返回相应的 HTML、CSS 和 JavaScript 文件，这些文件在客户端浏览器中渲染后，会呈现出一个可视化的监控界面。用户可以在这个界面上通过图形化的方式查看各种指标数据、创建自定义的仪表盘，以及进行数据过滤和分析等操作。</li>
</ul>
</li>
<li><strong>作用</strong>：HTTP server 为 Prometheus Server 提供了一个便捷的交互接口，使得用户和其他系统能够方便地与 Prometheus 进行集成和通信。通过这个接口，用户可以使用各种工具和客户端来访问监控数据，进行数据分析和可视化展示。同时，它也支持第三方应用程序通过 API 与 Prometheus 进行交互，实现自动化的监控和管理任务，大大提高了 Prometheus 的可扩展性和实用性。</li>
</ul>
<h4 id="Exporter"><a href="#Exporter" class="headerlink" title="Exporter"></a>Exporter</h4><p>Exporter 是 Prometheus 生态系统中的一个关键组件，用于将各种不同系统、服务或应用程序的指标数据转换为 Prometheus 能够识别和处理的格式，并提供给 Prometheus Server 进行采集和监控。</p>
<ul>
<li><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5></li>
</ul>
<p>Exporter 的主要作用是将原本不兼容 Prometheus 数据格式的指标数据进行转换和适配。不同的系统和服务通常使用各自特定的方式来表示性能指标和运行状态信息，Exporter 就是一个桥梁，它能够理解这些不同来源的数据，并将其重新格式化为 Prometheus 所使用的时间序列数据格式，这样 Prometheus Server 就可以方便地从 Exporter 拉取数据进行统一的存储、分析和展示。</p>
<ul>
<li><h5 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h5><ul>
<li><p><strong>数据收集</strong>：Exporter 通过与目标系统或服务进行交互来收集指标数据。这可能涉及到使用各种不同的技术和协议，具体取决于被监控的对象。例如，对于操作系统，Exporter 可能会使用系统命令或特定的系统接口来获取 CPU 使用率、内存使用量、磁盘 I&#x2F;O 等信息；对于数据库，Exporter 可能会通过数据库的客户端库执行查询来获取数据库的性能指标，如查询执行时间、连接数、缓存命中率等。</p>
</li>
<li><p><strong>格式转换</strong>：收集到数据后，Exporter 会将其转换为 Prometheus 的格式。在 Prometheus 中，数据以指标名称和一组标签的形式表示，每个指标可以有多个时间戳 - 值对，表示不同时间点上的指标值。Exporter 会将收集到的各种指标数据映射到 Prometheus 的指标体系中，并为每个指标添加适当的标签，以便在 Prometheus 中进行区分和查询。例如，一个监控服务器 CPU 使用率的 Exporter 可能会将数据转换为名为 “cpu_usage_percentage” 的指标，并添加 “instance”（服务器实例名称）、“job”（所属的 Job 名称）等标签，然后按照 Prometheus 的协议将数据暴露在一个 HTTP 端点上。</p>
</li>
<li><p><strong>数据暴露</strong>：Exporter 会在本地启动一个 HTTP 服务器，默认情况下会在某个特定的端口上监听请求（例如，许多 Exporter 默认使用 9100 端口）。Prometheus Server 通过向 Exporter 的 HTTP 端点发送 HTTP 请求来拉取指标数据。Exporter 在接收到请求后，会将转换后的数据以 Prometheus 特定的文本格式返回给 Prometheus Server，这个格式通常被称为 “Prometheus exposition format”。</p>
</li>
</ul>
</li>
<li><h5 id="常见类型"><a href="#常见类型" class="headerlink" title="常见类型"></a>常见类型</h5><ul>
<li><p><strong>节点 Exporter</strong>：用于收集服务器节点的各种系统指标，如 CPU、内存、磁盘、网络等使用情况。它是 Prometheus 监控基础设施中最常用的 Exporter 之一，通过收集这些底层系统指标，可以帮助管理员了解服务器的资源使用状况，及时发现潜在的性能问题。</p>
</li>
<li><p><strong>应用程序 Exporter</strong>：针对特定的应用程序或服务进行指标收集的 Exporter。例如，<strong>MySQL Exporter 用于收集 MySQL 数据库的性能指标，包括查询执行时间、缓存命中率、事务处理等</strong>；Redis Exporter 用于监控 Redis 缓存服务器的指标，如内存使用、键空间信息、连接数等。这些 Exporter 能够深入了解应用程序的运行状态，帮助开发人员和运维人员优化应用程序性能、诊断问题。</p>
</li>
<li><p><strong>中间件 Exporter</strong>：用于监控各种中间件技术的指标，如 Kafka Exporter 用于收集 Kafka 消息队列的相关指标，如消息吞吐量、消费者滞后情况、分区状态等；Nginx Exporter 用于监控 Nginx 服务器的访问日志、连接数、请求处理等指标。通过对中间件的监控，可以确保其稳定运行，保障整个系统的可靠性和性能。</p>
</li>
</ul>
</li>
<li><p><strong>分类</strong></p>
<ul>
<li><p><strong>直接采集型</strong></p>
<p>这类 Exporter 自身就集成了能与 Prometheus 交互、提供目标（Target）数据的功能模块 。就像 cAdvisor、Kubernetes，它们自身具备专门的端点（类似提供数据的接口），可直接把内部运行状态等相关监控数据发送给 Prometheus。比如 cAdvisor 能实时采集容器的资源使用情况（CPU、内存等），然后传递给 Prometheus，不需要额外复杂的转换或中间环节。</p>
</li>
<li><p><strong>间接采集型</strong></p>
<p>当原始监控目标（如 Linux 系统、某些数据库、HTTP 应用等）自身没有直接适配 Prometheus 的能力时，就得借助 Prometheus 提供的 Client Library（客户端库）来编写专门的采集程序 ，也就是 Exporter。像 Linux 系统，得安装 Node Exporter 这个程序，它会去收集 Linux 系统层面的指标（如 CPU 使用率、磁盘 I&#x2F;O 等），整理成 Prometheus 能识别的格式后再提供过去。</p>
</li>
</ul>
</li>
<li><h5 id="自定义-Exporter"><a href="#自定义-Exporter" class="headerlink" title="自定义 Exporter"></a>自定义 Exporter</h5></li>
</ul>
<p>​	在实际应用中，除了使用官方和社区提供的各种 Exporter 外，用户还可以根据自己的需求开发自定义的 Exporter。当遇到一些特殊的系统或服务，没有现成的 Exporter 可用时，或者需要收集一些特定的、非标准的指标数据时，就可以通过编写自定义 Exporter 来实现。自定义 Exporter 可以使用各种编程语言来开发，只要能够实现数据收集、格式转换和 HTTP 接口暴露等功能即可。例如，可以使用 Python 的 Flask 框架或 Go 语言的标准 HTTP 库来创建一个简单的自定义 Exporter，收集特定业务系统的指标并提供给 Prometheus 进行监控。</p>
<h5 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h5><ul>
<li><strong>功能概述</strong>：blackbox_exporter 是 Prometheus 生态系统中的一个工具，主要用于对<strong>网络服务</strong>进行<strong>黑盒监控</strong>。它通过模拟各种网络请求来检查目标服务的可达性和性能，而无需了解目标服务的内部实现细节。</li>
<li><strong>工作原理</strong>：它支持多种探测协议，包括 ICMP、TCP、HTTP、HTTPS、DNS 等。例如，当使用 HTTP 协议进行探测时，它会向指定的 URL 发送 HTTP 请求，并根据响应来判断服务是否正常运行，同时收集诸如响应时间、状态码等指标。对于 ICMP 探测，它会发送 ping 包来检查目标主机是否可达以及往返时间。</li>
<li><strong>应用场景</strong>：可以用于<strong>监控网站的可用性</strong>，确保用户能够正常访问网页；也能用于<strong>检测网络设备的连通性</strong>，及时发现网络故障；还可对各种基于网络协议的服务进行健康检查，保障服务的稳定性。</li>
</ul>
<h5 id="consul-exporter"><a href="#consul-exporter" class="headerlink" title="consul_exporter"></a>consul_exporter</h5><ul>
<li><strong>功能概述</strong>：consul_exporter 是专门为 Consul 服务发现和配置管理系统设计的一个工具，用于将 Consul 中的相关信息转化为 Prometheus 能够理解和处理的指标。</li>
<li><strong>工作原理</strong>：它通过 Consul 的 API 获取各种数据，包括服务注册信息、节点状态、健康检查结果等。然后将这些信息转换为 Prometheus 的指标格式，例如，将服务的注册数量、健康服务的数量、节点的负载等信息转化为相应的数值指标，以便 Prometheus 进行收集和分析。</li>
<li><strong>应用场景</strong>：在微服务架构中，当使用 Consul 进行服务发现和健康管理时，consul_exporter 可以帮助运维人员监控 Consul 集群的运行状态，了解各个服务的注册和健康情况，及时发现服务故障或异常，确保整个微服务系统的稳定运行。</li>
</ul>
<h5 id="graphite-exporter"><a href="#graphite-exporter" class="headerlink" title="graphite_exporter"></a>graphite_exporter</h5><ul>
<li><strong>功能概述</strong>：graphite_exporter 的作用是在 Graphite 和 Prometheus 之间搭建一座桥梁，使 Prometheus 能够获取和处理 Graphite 中存储的时间序列数据。</li>
<li><strong>工作原理</strong>：它通过与 Graphite 的 API 进行交互，按照一定的规则将 Graphite 中的数据转换为 Prometheus 的指标格式。例如，它会将 Graphite 中以特定路径和命名规则存储的指标数据，转换为 Prometheus 中具有明确标签和值的指标，然后暴露给 Prometheus 进行抓取。</li>
<li><strong>应用场景</strong>：当企业已经在使用 Graphite 进行数据存储和可视化，同时又希望引入 Prometheus 进行更强大的数据分析和告警功能时，graphite_exporter 就可以发挥作用，实现数据的共享和整合，避免重复采集数据，保护已有的数据资产。</li>
</ul>
<h5 id="memcached-exporter"><a href="#memcached-exporter" class="headerlink" title="memcached_exporter"></a>memcached_exporter</h5><ul>
<li><strong>功能概述</strong>：memcached_exporter 是用于监控 Memcached 内存缓存系统的工具，它能够收集 Memcached 服务器的详细运行指标，为运维人员提供关于缓存系统的运行状态信息。(Memcached 是一个开源的高性能分布式内存对象缓存系统，常用于动态 Web 应用程序中以减轻数据库负载，提高系统性能。)</li>
<li><strong>工作原理</strong>：它通过与 Memcached 服务器建立连接，发送特定的命令来获取各种统计信息，如缓存项的数量、缓存命中率、内存使用情况、连接数、请求速率等。然后将这些信息转换为 Prometheus 可识别的指标，以便进行存储和分析。</li>
<li><strong>应用场景</strong>：在应用程序中使用 Memcached 作为缓存来提高性能时，memcached_exporter 可以帮助运维人员实时监控缓存的使用情况，及时发现缓存击穿、缓存雪崩等潜在问题，以便采取相应的措施进行优化，如调整缓存策略、增加缓存容量等，确保缓存系统能够高效稳定地运行，提升整个应用程序的性能和响应速度。</li>
</ul>
<h5 id="mysqld-exporter"><a href="#mysqld-exporter" class="headerlink" title="mysqld_exporter"></a><strong>mysqld_exporter</strong></h5><ul>
<li><strong>功能概述</strong>：mysqld_exporter 是专门为 MySQL 数据库设计的指标收集工具，它能够深入挖掘 MySQL 数据库的运行状态和性能指标，为数据库管理员和运维人员提供全面的监控数据。</li>
<li><strong>工作原理</strong>：它通过连接到 MySQL 数据库，执行一系列的查询语句来获取各种指标信息。这些指标包括数据库的连接数、查询执行时间、缓存使用情况（如查询缓存、InnoDB 缓冲池等）、事务处理情况、索引使用情况、磁盘 I&#x2F;O 等。然后将这些信息转换为 Prometheus 的指标格式，方便 Prometheus 进行采集和分析。</li>
<li><strong>应用场景</strong>：在数据库管理中，mysqld_exporter 是一个非常重要的工具。它可以帮助 DBA 及时发现数据库的性能瓶颈，如查询执行缓慢、缓存命中率低、磁盘 I&#x2F;O 过高导致的性能下降等问题。通过对这些指标的分析，DBA 可以采取相应的优化措施，如优化查询语句、调整数据库配置参数、添加索引等，以提高数据库的性能和稳定性，确保业务系统能够正常运行。</li>
</ul>
<h5 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h5><ul>
<li><strong>功能概述</strong>：node_exporter 是 Prometheus 生态中用于收集服务器节点系统指标的关键组件，它能够提供关于服务器硬件和操作系统层面的详细信息。</li>
<li><strong>工作原理</strong>：它通过与操作系统的底层接口进行交互，收集各种系统指标。例如，通过读取 &#x2F;proc 文件系统（在 Linux 系统中）获取 CPU 使用率、内存使用情况、磁盘 I&#x2F;O 统计、进程信息等。对于系统的网络接口，它会收集网络流量数据，包括发送和接收的字节数、数据包数量等。此外，还能获取系统的负载平均值、开机时间等信息，并将这些信息转换为 Prometheus 可识别的指标格式进行暴露。</li>
<li><strong>应用场景</strong>：以一个大型电商网站为例，其背后的服务器集群可能包含多个服务器节点，在服务器运维中，node_exporter 是必不可少的工具。它可以帮助运维人员全面了解服务器的运行状态，及时发现服务器的性能问题，如 CPU 过载、内存泄漏、磁盘空间不足、网络拥堵等。通过对这些指标的监控和分析，运维人员可以提前采取措施进行故障排除和性能优化，保障服务器的稳定运行，避免因系统故障导致的业务中断。</li>
</ul>
<h5 id="statsd-exporter"><a href="#statsd-exporter" class="headerlink" title="statsd_exporter"></a>statsd_exporter</h5><ul>
<li><p><strong>功能概述</strong>：statsd_exporter 主要用于将 StatsD 收集的指标数据转换为 Prometheus 能够处理的格式，从而实现<strong>将 StatsD 的数据纳入 Prometheus 的监控体系</strong>。</p>
</li>
<li><p><strong>工作原理</strong>：它监听 StatsD 发送的数据，按照 StatsD 的协议解析数据，并将其转换为 Prometheus 的指标。StatsD 通常收集应用程序的各种指标，如计数器（用于统计事件发生的次数）、计时器（用于记录操作的执行时间）、直方图（用于统计数据的分布情况）等。statsd_exporter 会将这些不同类型的指标转换为 Prometheus 中对应的指标类型，并添加适当的标签，以便 Prometheus 进行分类和存储。</p>
</li>
<li><p><strong>应用场景</strong>：在一些应用程序中，已经使用 StatsD 进行指标收集，而希望利用 Prometheus 强大的查询、告警和可视化功能时，statsd_exporter 就可以发挥作用。它可以将 StatsD 收集到的应用程序性能指标，如接口调用次数、响应时间分布等，提供给 Prometheus 进行进一步的分析和处理，帮助开发人员和运维人员更好地了解应用程序的运行状况，及时发现性能问题并进行优化。</p>
</li>
<li><p>StatsD 是一个用于实时收集和汇总应用程序统计数据的工具，通常用于监控系统性能和应用程序行为。以下是关于它的详细介绍：</p>
<p>特点</p>
<ul>
<li><strong>轻量级</strong>：StatsD 的设计目标是轻量级和高效，它可以快速处理大量的统计数据，而不会给应用程序带来过多的性能开销。</li>
<li><strong>可扩展</strong>：支持插件扩展机制，用户可以根据自己的需求开发自定义插件，以扩展 StatsD 的功能，例如添加新的数据收集器或聚合器。</li>
<li><strong>支持多种数据类型</strong>：能够处理多种类型的统计数据，包括计数器（Counter）、计量器（Gauge）、直方图（Histogram）和分布（Distribution）等，满足不同场景下的统计需求。</li>
<li><strong>与其他系统集成性好</strong>：可以很方便地与其他监控和数据分析系统集成，如 Graphite、InfluxDB 等，将收集到的数据进行存储、可视化和进一步分析。</li>
</ul>
<p>工作原理</p>
<ul>
<li><strong>数据收集</strong>：StatsD 通过 UDP 协议接收来自应用程序发送的统计数据。应用程序在运行过程中，根据需要向 StatsD 发送各种类型的统计信息，例如，记录某个函数被调用的次数、某个操作的执行时间等。</li>
<li><strong>数据处理</strong>：StatsD 接收到数据后，会按照一定的规则对数据进行处理和汇总。它可以在内存中对数据进行实时聚合，例如计算平均值、最大值、最小值等，并根据配置的时间间隔将汇总后的数据发送到后端的存储或分析系统。</li>
<li><strong>数据存储与展示</strong>：StatsD 本身并不存储数据，而是将处理后的数据转发给其他数据存储系统，如 Graphite。这些存储系统会将数据持久化保存，并提供相应的可视化工具，以便用户直观地查看和分析统计数据的变化趋势。</li>
</ul>
<p>应用场景</p>
<ul>
<li><strong>应用性能监控</strong>：在 Web 应用程序中，StatsD 可以用于收集各种性能指标，如页面加载时间、数据库查询时间、接口响应时间等。通过分析这些指标，开发人员可以快速定位性能瓶颈，优化应用程序代码和架构。</li>
<li><strong>业务指标统计</strong>：可以用来统计业务相关的数据，如用户注册量、登录次数、订单成交量等。这些数据对于了解业务发展趋势、评估营销策略效果具有重要意义。</li>
<li><strong>系统资源监控</strong>：StatsD 还可以与服务器监控工具结合，收集系统资源使用情况的统计数据，如 CPU 使用率、内存使用率、磁盘 I&#x2F;O 等。运维人员可以根据这些数据及时发现系统资源的异常消耗，提前进行资源调整和优化。</li>
</ul>
</li>
</ul>
<h4 id="Jobs-exporters（作业-导出器）"><a href="#Jobs-exporters（作业-导出器）" class="headerlink" title="Jobs&#x2F;exporters（作业 &#x2F; 导出器）"></a>Jobs&#x2F;exporters（作业 &#x2F; 导出器）</h4><ul>
<li><strong>作用</strong></li>
</ul>
<p>​	Jobs 主要用于告诉 Prometheus 服务器如何以及从哪里采集指标数据。它定义了一组目标（通常是 Exporter），并配置了采集这些目标数据的相关参数，是 Prometheus 实现对各种系统和应用进行监控的关键配置部分。</p>
<ul>
<li><p><strong>配置参数</strong></p>
<ul>
<li><p><strong>job_name</strong>：每个 Job 都有一个唯一的名称，用于标识该作业，例如<code>web_server</code>、<code>database_monitor</code>等，方便在 Prometheus 的配置和管理中进行区分和引用。</p>
</li>
<li><p><strong>scrape_interval</strong>：指定 Prometheus 从目标 Exporter 采集数据的时间间隔。默认是 15 秒，可以根据实际需求进行调整。如果监控的系统变化频繁，可能需要缩短采集间隔；如果系统相对稳定，可适当延长间隔以减少资源消耗。</p>
</li>
<li><p><strong>scrape_timeout</strong>：设置采集数据的超时时间。当 Prometheus 向 Exporter 请求数据时，如果在指定的超时时间内没有收到响应，就会认为此次采集失败。默认是 10 秒，一般不需要修改，但在网络环境不稳定或 Exporter 处理数据较慢的情况下，可能需要适当延长超时时间。</p>
</li>
<li><p><strong>targets</strong>：这是 Job 配置中最重要的部分，用于指定要采集数据的目标地址，通常是 Exporter 的地址和端口。可以是单个目标，如<code>[&#39;server1:9100&#39;]</code>，也可以是多个目标的列表，如<code>[&#39;server1:9100&#39;, &#39;server2:9100&#39;, &#39;server3:9100&#39;]</code>。Prometheus 会按照配置的时间间隔依次向这些目标发送数据采集请求。</p>
</li>
<li><p><strong>labels</strong>：标签是 Prometheus 中用于对数据进行分类和标识的重要手段。在 Job 配置中，可以为采集到的数据添加一组标签，例如<code>env: &#39;production&#39;</code>、<code>app: &#39;myapp&#39;</code>等。这些标签可以帮助用户在查询和分析数据时更方便地进行筛选、聚合和分组操作，以便更好地理解和监控系统的不同方面。</p>
</li>
</ul>
</li>
<li><p><strong>工作原理</strong></p>
<p>Prometheus 服务器会按照 Job 配置中定义的<code>scrape_interval</code>定期遍历每个 Job 中的<code>targets</code>列表，向每个目标 Exporter 发送 HTTP 请求，获取指标数据。Exporter 接收到请求后，会将自身收集到的指标数据以 Prometheus 支持的格式返回给 Prometheus 服务器。Prometheus 服务器接收到数据后，会根据 Job 配置中的<code>labels</code>以及 Exporter 返回数据中自带的标签信息，对数据进行标记和存储。这样，用户就可以通过 Prometheus 的查询界面或其他工具，根据标签来查询和分析采集到的指标数据，实现对系统的监控和故障排查。</p>
</li>
<li><p><strong>与其他组件的关系</strong></p>
<p>Jobs 与 Exporter 紧密配合，Exporter 负责将各种系统和应用的指标数据转换为 Prometheus 能够识别的格式，而 Jobs 则负责告诉 Prometheus 如何去采集这些 Exporter 的数据。同时，Jobs 采集到的数据会存储在 Prometheus 的时间序列数据库中，供用户通过 **PromQL（Prometheus Query Language）**进行查询和分析。此外，Jobs 也可以与 Prometheus 的告警系统结合，根据采集到的数据设置告警规则，当某些指标超出阈值或满足特定条件时，及时向相关人员发送告警通知。</p>
</li>
</ul>
<h4 id="Node（节点）"><a href="#Node（节点）" class="headerlink" title="Node（节点）"></a>Node（节点）</h4><p>代表运行 Prometheus server 的物理或虚拟节点，下方的 HDD&#x2F;SSD 表示存储设备，用于存储 Prometheus 的数据。</p>
<p>在存储系统中，节点是一个具有独立处理能力和存储能力的单元。它可以是一台服务器、一个存储设备或一个特定的硬件模块，作为存储网络中的一个基本组成部分，负责存储和管理数据。多个节点可以通过网络连接在一起，形成一个分布式存储系统，共同提供大规模的数据存储和访问服务。每个节点都有自己的处理器、内存、存储设备和网络接口，能够独立地执行数据读写操作，并与其他节点进行通信和协作，以实现数据的冗余、容错和负载均衡等功能。</p>
<h4 id="Prometheus-alerting"><a href="#Prometheus-alerting" class="headerlink" title="Prometheus alerting"></a>Prometheus alerting</h4><ul>
<li><p><strong>工作原理</strong></p>
<ul>
<li><p>Prometheus 通过配置文件中的规则来定义警报条件。<strong>它会定期评估这些规则</strong>，检查监控指标是否符合设定的阈值或其他条件。当指标满足警报条件时，Prometheus 会将警报信息发送到配置好的 Alertmanager。</p>
</li>
<li><p><strong>Alertmanager 负责接收来自 Prometheus 的警报信息</strong>，并对其进行处理，包括分组、抑制、去重等操作，然后根据配置将警报发送到指定的接收者，如邮件、即时通讯工具等。</p>
</li>
</ul>
</li>
</ul>
<h5 id="警报规则配置"><a href="#警报规则配置" class="headerlink" title="警报规则配置"></a>警报规则配置</h5><ul>
<li>警报规则使用 Prometheus 的查询语言（PromQL）来定义。例如，可以定义当 CPU 使用率超过 80% 持续 5 分钟时触发警报：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_alert_rules</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighCPUUsage</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">&lt;</span> <span class="number">0.2</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High CPU usage on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;CPU usage on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> is above 80%.&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在这个规则中，<code>expr</code> 字段是核心表达式，用于判断警报条件。<code>for</code> 字段指定了持续时间，只有当条件满足该持续时间后才会触发警报。<code>labels</code> 字段用于为警报添加标签，以便在 Alertmanager 中进行分类和过滤。<code>annotations</code> 字段则提供了关于警报的详细描述信息，如摘要和具体描述。</li>
<li><strong><code>expr</code> 中的 <code>[5m]</code></strong>：它是 PromQL 中 <code>rate</code> 函数的一部分，用于指定计算 CPU 使用率的时间窗口。在这里，它表示获取过去 5 分钟内 <code>node_cpu_seconds_total{mode=&quot;idle&quot;}</code> 指标的变化率，即计算每 5 分钟的 CPU 空闲时间的平均变化速率，以此来间接得出 CPU 的使用率。</li>
<li><strong><code>for</code> 字段中的 <code>5m</code></strong>：它指定了警报触发的条件需要持续的时间。也就是说，只有当 <code>expr</code> 中定义的条件（CPU 使用率小于 0.2，即 CPU 使用率超过 80%）持续满足 5 分钟后，Prometheus 才会真正触发警报。</li>
</ul>
<h5 id="Alertmanager-配置"><a href="#Alertmanager-配置" class="headerlink" title="Alertmanager 配置"></a>Alertmanager 配置</h5><ul>
<li>分组（Grouping）：可以将相似的警报分组在一起，例如按照主机名或服务名进行分组，这样可以避免收到大量重复的警报信息。例如：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">12h</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&#x27;email&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>group_by</code>：这是一个列表，里面定义了用于分组的标签。在这个例子中，<code>[&#39;instance&#39;]</code> 意味着会依据 <code>instance</code> 标签的值来对告警进行分组。例如，所有 <code>instance</code> 标签值相同的告警会被分到一组。</p>
<p><code>group_wait</code>：表示在首次收到告警后，Alertmanager 会<strong>等待多长时间再发送分组后的通知</strong>。设置这个时间是为了让 Alertmanager 有时间收集更多相关的告警，然后一起发送。在这个例子中，等待时间是 30 秒。</p>
<p><code>group_interval</code>：指的是在发送一个分组通知之后，下一次收集新告警并发送新分组通知之前的等待时间。这里设置为 5 分钟，也就是说，在发送一个分组通知后，接下来的 5 分钟内，新产生的告警会被收集起来，等到 5 分钟结束后，再把这些新告警作为一个新的分组通知发送出去。</p>
<p><code>repeat_interval</code>：表示如果一个告警分组持续存在，那么每隔多长时间会再次发送通知。这里设置为 12 小时，意味着如果一个告警分组一直存在，每隔 12 小时会再次发送通知提醒接收者。</p>
<p><code>receiver</code>：指定了分组通知的接收者。这里设置为 <code>&#39;email&#39;</code>，表示使用名为 <code>email</code> 的接收者配置来发送通知。</p>
<ul>
<li>抑制（Inhibition）：可以配置当某些警报触发时，抑制其他相关警报的发送。例如，当服务器整体故障警报触发时，抑制该服务器上单个服务的故障警报。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">  <span class="attr">target_match:</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">  <span class="attr">equal:</span> [<span class="string">&#x27;instance&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p><code>source_match</code>：这是一个标签匹配规则，定义了触发抑制的告警需要满足的条件。在这个例子中，<code>severity: &#39;critical&#39;</code> 表示只有当 <code>severity</code> 标签值为 <code>critical</code> 的告警触发时，才会触发抑制规则。</p>
<p><code>target_match</code>：同样是一个标签匹配规则，定义了会被抑制的告警需要满足的条件。这里 <code>severity: &#39;warning&#39;</code> 表示 <code>severity</code> 标签值为 <code>warning</code> 的告警会被抑制。</p>
<p><code>equal</code>：这是一个列表，定义了在进行抑制判断时，需要比较的标签。在这个例子中，<code>[&#39;instance&#39;]</code> 表示只有当触发抑制的告警和被抑制的告警的 <code>instance</code> 标签值相同时，才会进行抑制操作。也就是说，当 <code>severity</code> 为 <code>critical</code> 的告警触发时，会抑制 <code>severity</code> 为 <code>warning</code> 且 <code>instance</code> 标签值相同的告警。</p>
<p>1号数据库 慢查询 warning </p>
<p>2号数据库宕机  critical </p>
<ul>
<li>去重（Deduplication）：Alertmanager 会自动对相同的警报进行去重，只发送一次通知，避免重复通知给用户带来困扰。</li>
</ul>
<h5 id="警报接收方式"><a href="#警报接收方式" class="headerlink" title="警报接收方式"></a>警报接收方式</h5><ul>
<li>Prometheus 支持多种警报接收方式，常见的有邮件、Slack、PagerDuty(一种事件管理和应急响应平台) 等。通过配置相应的接收器（Receiver），可以将警报信息发送到不同的平台。例如，配置邮件接收器：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;email&#x27;</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;admin@example.com&#x27;</span></span><br><span class="line">    <span class="attr">subject:</span> <span class="string">&#x27;Prometheus Alert: &#123;&#123; .CommonLabels.alertname &#125;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">html:</span> <span class="string">&#x27;&lt;p&gt;Alert: &#123;&#123; .CommonLabels.alertname &#125;&#125;&lt;br&gt;Description: &#123;&#123; .CommonAnnotations.description &#125;&#125;&lt;/p&gt;&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="PromQL"><a href="#PromQL" class="headerlink" title="PromQL"></a>PromQL</h4><p>（Prometheus Query Language，Prometheus 查询语言）</p>
<p>用于在 Prometheus web UI、Grafana 等工具中查询和分析存储在 Prometheus 中的指标数据。</p>
<h5 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h5><ul>
<li><p><strong>指标名称</strong>：直接使用指标名称可查询该指标的时间序列数据。例如，<code>http_requests_total</code> 表示 HTTP 请求的总数，它是一个反映系统中 HTTP 请求量的指标。</p>
</li>
<li><p>标签选择器：用 <code>{}</code>来指定标签选择条件，用于过滤具有特定标签的时间序列。例如，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;method=&quot;GET&quot;, status_code=&quot;200&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>表示仅选择 HTTP 请求方法为 GET 且状态码为 200 的请求总数的时间序列。标签选择器支持多种匹配模式，具体如下：</p>
<ul>
<li><strong>精确匹配（<code>=</code>）</strong>：<code>node_cpu_seconds_total{mode=&quot;user&quot;}</code> 会精确选择出 CPU 处于用户态的时间序列。</li>
<li><strong>不精确匹配（<code>!=</code>）</strong>：<code>node_cpu_seconds_total{mode!=&quot;system&quot;}</code> 表示选择除了 CPU 处于系统态之外的其他时间序列。</li>
<li><strong>正则表达式匹配（<code>=~</code> 和 <code>!~</code>）</strong>：<code>node_labels{label_name=~&quot;role.*&quot;}</code> 会选择标签名为 <code>label_name</code> 且值以 <code>role</code> 开头的时间序列。</li>
</ul>
</li>
</ul>
<h5 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h5><ul>
<li><strong>瞬时向量（Instant Vector）</strong>：包含一组时间序列样本，每个样本都有一个唯一的时间戳和值，代表在某个特定时刻的指标数据。例如，<code>node_memory_MemAvailable_bytes</code> 可能返回当前时刻系统可用内存的字节数，它是一个瞬时向量，反映了当前这一时刻的内存可用情况。</li>
<li><strong>范围向量（Range Vector）</strong>：包含一段时间范围内的时间序列样本，通过指定时间范围来获取数据。例如，<code>http_requests_total{method=&quot;POST&quot;}[10m]</code> 表示过去 10 分钟内 HTTP 请求方法为 POST 的请求总数的时间序列数据，它可以用于分析一段时间内 POST 请求的变化趋势。</li>
<li><strong>标量（Scalar）</strong>：一个单独的数字值，通常是通过对瞬时向量或范围向量进行聚合操作得到的结果。例如，<code>count(node_cpu_seconds_total)</code> 会返回 CPU 时间序列的数量，这是一个标量值，用于统计相关指标的数量。</li>
<li><strong>字符串（String）</strong>：主要用于在表达式中传递文本信息，例如标签的值或注释内容。例如，在查询中可以使用字符串来指定特定的标签值进行过滤，如 <code>node_metadata{hostname=&quot;server01&quot;}</code>，其中 <code>&quot;server01&quot;</code> 就是字符串。</li>
</ul>
<h5 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h5><ul>
<li>算术操作符：包括+、-、*、&#x2F;、%（取模）和^（幂运算）。这些操作符可对指标数据进行数学计算。例如：<ul>
<li><code>node_memory_MemTotal_bytes - node_memory_MemFree_bytes</code> 用于计算系统已使用的内存字节数。</li>
<li><code>http_requests_per_second * 60</code> 可以将每秒的 HTTP 请求数转换为每分钟的请求数。</li>
</ul>
</li>
<li>比较操作符：有 &#x3D;&#x3D;、!&#x3D;、&gt;、&lt;、&gt;&#x3D;和&lt;&#x3D;。比较操作符用于过滤满足特定条件的时间序列。例如：<ul>
<li><code>node_cpu_utilization &gt; 0.9</code> 可以选择出 CPU 使用率超过 90% 的节点，用于发现 CPU 负载较高的情况。</li>
<li><code>http_response_time_ms &lt;= 500</code> 表示选择 HTTP 响应时间小于等于 500 毫秒的时间序列，用于监控响应时间是否在正常范围内。</li>
</ul>
</li>
<li>逻辑操作符：and、or、unless（除非）。逻辑操作符用于组合多个条件。例如：<ul>
<li><code>(node_cpu_utilization &gt; 0.8) and (node_memory_utilization &gt; 0.7)</code> 表示选择 CPU 使用率超过 80% 且内存使用率超过 70% 的节点，用于找出系统资源整体使用较高的节点。</li>
<li><code>(http_requests_total &gt; 1000) or (http_error_rate &gt; 0.05)</code> 表示选择 HTTP 请求总数超过 1000 或者错误率超过 5% 的时间序列，用于判断系统是否出现高请求量或高错误率的情况。</li>
</ul>
</li>
</ul>
<h5 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h5><ul>
<li><p>聚合函数：PromQL 提供了丰富的聚合函数，用于对时间序列数据进行聚合计算。例如：</p>
<ul>
<li><code>sum by (instance) (node_cpu_seconds_total{mode=&quot;idle&quot;})</code> 会按照实例对 CPU 空闲时间进行求和，返回每个实例的 CPU 空闲时间总和，便于了解不同实例的 CPU 空闲情况。</li>
<li><code>avg over time (http_requests_total[1h])</code> 计算过去 1 小时内 HTTP 请求总数的平均值，用于分析请求量的平均水平。</li>
<li><code>max by (job) (node_memory_MemUsed_bytes)</code> 按照作业（job）标签找出每个作业中内存使用量的最大值，有助于发现内存使用的峰值情况。</li>
</ul>
</li>
<li><p>数据转换函数</p>
<p>：可以对时间序列数据进行转换和处理。例如：</p>
<ul>
<li><code>rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[5m])</code> 计算过去 5 分钟内 CPU 空闲时间的平均变化率，用于了解 CPU 空闲时间的变化趋势。</li>
<li><code>irate(node_network_bytes_transmitted[1m])</code> 计算节点网络传输字节数的瞬时变化率，能及时反映网络流量的瞬间变化情况。</li>
<li><code>delta(node_disk_io_time_seconds[10m])</code> 计算过去 10 分钟内磁盘 I&#x2F;O 时间的差值，用于分析磁盘 I&#x2F;O 的活动情况。</li>
</ul>
</li>
<li><p>其他函数</p>
<p>：还有一些其他类型的函数。例如：</p>
<ul>
<li><code>label_join(node_labels, &quot;combined_label&quot;, &quot; &quot;, &quot;label1&quot;, &quot;label2&quot;)</code> 用于将 <code>label1</code> 和 <code>label2</code> 两个标签的值连接起来，形成一个新的标签 <code>combined_label</code>，中间用空格分隔，方便对标签进行组合和处理。</li>
<li><code>time()</code> 函数返回当前时间戳，可用于在查询中获取当前时间，以便与其他时间相关的指标进行比较或计算。</li>
</ul>
</li>
</ul>
<h5 id="查询示例"><a href="#查询示例" class="headerlink" title="查询示例"></a>查询示例</h5><ul>
<li><strong>查询当前所有节点的 CPU 使用率</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 - (avg by (instance) (rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])))</span><br></pre></td></tr></table></figure>

<p>该查询先计算每个实例（instance）在过去 5 分钟内 CPU 空闲时间的平均变化率，然后用 1 减去这个值，得到的就是每个实例的 CPU 使用率。</p>
<ul>
<li><strong>查询内存使用率超过 80% 的节点</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_MemUsed_bytes / node_memory_MemTotal_bytes) &gt; 0.8</span><br></pre></td></tr></table></figure>

<p>此查询通过计算内存已使用字节数与总内存字节数的比值，来判断每个节点的内存使用率是否超过 80%，如果超过则会被选中。</p>
<ul>
<li><strong>查询过去 1 小时内每秒请求数的变化趋势</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[1h])</span><br></pre></td></tr></table></figure>

<p>该查询使用 <code>rate</code> 函数计算过去 1 小时内 HTTP 请求总数的每秒变化率，从而展示出每秒请求数的变化趋势，帮助分析系统的负载情况。</p>
<ul>
<li><strong>查询特定服务的平均响应时间</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avg by (service) (rate(http_response_time_seconds_sum[5m]) / rate(http_response_time_seconds_count[5m]))</span><br></pre></td></tr></table></figure>

<p>这个查询通过计算过去 5 分钟内特定服务的响应时间总和与响应次数的比值，得到每个服务的平均响应时间，用于监控不同服务的性能。</p>
<ul>
<li><strong>查询集群中磁盘空间使用率最高的前 5 个节点</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(5, node_filesystem_used_percent&#123;mountpoint=&quot;/&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p><code>topk</code> 函数用于找出指定指标中值最大的前 N 个元素，这里查询出根目录（<code>mountpoint=&quot;/&quot;</code>）磁盘空间使用率最高的前 5 个节点，方便及时发现磁盘空间紧张的节点。</p>
<h4 id="Prometheus-web-UI"><a href="#Prometheus-web-UI" class="headerlink" title="Prometheus web UI"></a>Prometheus web UI</h4><p>Prometheus 自带的 Web 界面，用户可以通过它使用 PromQL 查询指标数据，查看监控图表等。</p>
<h4 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h4><p>一个开源的数据可视化工具，连接 Prometheus 作为数据源，提供更丰富、美观的数据可视化界面和报表功能。</p>
<h4 id="API-clients（API-客户端）"><a href="#API-clients（API-客户端）" class="headerlink" title="API clients（API 客户端）"></a>API clients（API 客户端）</h4><p>通过 Prometheus 的 API 访问指标数据，进行数据导出等操作。</p>
<h5 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h5><ul>
<li><strong>数据查询</strong>：允许用户通过编程方式向 Prometheus 服务器发送查询请求，获取存储在其中的监控数据。例如，通过 API 客户端可以查询特定时间范围内的 CPU 使用率、内存使用量等指标数据，而无需在 Prometheus Web UI 中手动输入查询语句。</li>
<li><strong>数据写入</strong>：某些 API 客户端还支持将数据写入 Prometheus 服务器。这对于一些自定义的监控数据收集器或者需要将外部数据导入到 Prometheus 进行分析的场景非常有用。比如，将应用程序内部的一些特定业务指标数据通过 API 客户端写入 Prometheus，以便进行统一的监控和分析。</li>
<li><strong>配置管理</strong>：可以通过 API 客户端来管理 Prometheus 的配置，如添加或删除监控目标、更新警报规则等。这使得在自动化运维场景中，能够方便地通过脚本或程序来动态调整 Prometheus 的配置，而无需手动修改配置文件并重启服务。</li>
</ul>
<h5 id="常用的-API-客户端8888"><a href="#常用的-API-客户端8888" class="headerlink" title="常用的 API 客户端8888"></a>常用的 API 客户端8888</h5><ul>
<li><strong>Prometheus 官方 Python 客户端</strong>：官方提供的 Python 库，方便 Python 开发者与 Prometheus API 进行交互。它提供了简洁的接口，用于构建查询语句、发送请求以及处理响应数据。以下是一个简单的示例代码，用于查询 Prometheus 中 CPU 使用率的指标数据：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_api_client <span class="keyword">import</span> PrometheusConnect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Prometheus连接对象</span></span><br><span class="line">prometheus = PrometheusConnect(url=<span class="string">&#x27;http://localhost:9090&#x27;</span>, disable_ssl=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建查询语句</span></span><br><span class="line">query = <span class="string">&#x27;node_cpu_usage&#123;cpu=&quot;0&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送查询请求并获取结果</span></span><br><span class="line">result = prometheus.custom_query(query)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Prometheus 官方 Go 客户端</strong>：对于 Go 语言开发者，官方提供了相应的客户端库。它与 Go 的标准库和生态系统集成良好，能够高效地与 Prometheus API 进行通信。以下是一个基本的 Go 语言示例，用于查询 Prometheus 中的内存使用指标：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/api&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/api/prometheus/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 创建Prometheus API客户端</span></span><br><span class="line">    client, err := api.NewClient(api.Config&#123;</span><br><span class="line">        Address: <span class="string">&quot;http://localhost:9090&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err!= <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Error creating client:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Prometheus v1 API对象</span></span><br><span class="line">    v1api := v1.NewAPI(client)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询语句</span></span><br><span class="line">    query := <span class="string">&quot;node_memory_MemFree_bytes&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行查询</span></span><br><span class="line">    result, warnings, err := v1api.Query(context.Background(), query, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err!= <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Error querying Prometheus:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> warnings!= <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Warnings:&quot;</span>, warnings)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印查询结果</span></span><br><span class="line">    fmt.Println(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Prometheus 官方 Java 客户端</strong>：用于 Java 项目中与 Prometheus API 进行交互。它提供了 Java 风格的接口，便于在 Java 应用程序中集成 Prometheus 的查询和数据写入功能。以下是一个简单的 Java 示例，用于查询 Prometheus 中的网络流量指标：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.CollectorRegistry;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.exporter.PushGateway;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.exporter.common.TextFormat;</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrometheusClientExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建OkHttpClient对象</span></span><br><span class="line">        <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建Prometheus查询请求</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .url(<span class="string">&quot;http://localhost:9090/api/v1/query?query=node_network_transmit_bytes_total&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 发送请求并获取响应</span></span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">                <span class="comment">// 处理响应数据</span></span><br><span class="line">                System.out.println(response.body().string());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Error: &quot;</span> + response.code());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h5><ul>
<li><strong>自动化与集成</strong>：便于与其他系统和工具集成，实现监控数据的自动化处理和分析。例如，可以将 Prometheus API 客户端集成到持续集成 &#x2F; 持续部署（CI&#x2F;CD）流程中，在每次部署后自动查询相关指标数据，以验证系统的性能和稳定性。</li>
<li><strong>定制化开发</strong>：允许开发人员根据具体的业务需求，定制特定的监控和分析功能。通过 API 客户端获取原始数据后，可以进行自定义的计算、过滤和可视化处理，满足不同用户对于监控数据的个性化需求。</li>
<li><strong>远程操作</strong>：即使不在 Prometheus 服务器所在的本地环境，也可以通过网络远程连接到 Prometheus 服务器的 API，进行数据查询和管理操作。这对于分布式系统的监控和管理非常方便，运维人员可以在任何有网络连接的地方通过 API 客户端对 Prometheus 进行操作。</li>
</ul>
<h3 id="线条部分"><a href="#线条部分" class="headerlink" title="线条部分"></a>线条部分</h3><ol>
<li><strong>push metrics at exit（退出时推送指标）</strong>：表示短期作业在结束运行时，将自身的指标数据推送到 Pushgateway。</li>
<li><strong>pull metrics（拉取指标）</strong>：Prometheus server 从 Pushgateway 和 Jobs&#x2F;exporters 拉取指标数据。</li>
<li><strong>discover targets（发现目标）</strong>：Service discovery 组件通过 Kubernetes 或 file_sd 机制发现 Prometheus 的监控目标。</li>
<li><strong>push alerts（推送告警）</strong>：Prometheus alerting 将检测到的告警信息推送给 Alertmanager。</li>
<li><strong>notify（通知）</strong>：Alertmanager 将处理后的告警信息通过 PagerDuty、Email 等方式通知相关人员。</li>
<li>其他线条：表示数据在各个组件之间的流动和交互，如 PromQL 用于查询 Prometheus server 中的数据，供 Prometheus web UI、Grafana 和 API clients 使用 。</li>
</ol>
<h2 id="Prometheus的数据模型"><a href="#Prometheus的数据模型" class="headerlink" title="Prometheus的数据模型"></a>Prometheus的数据模型</h2><p>Prometheus 基本上将所有数据存储为时间序列：属于同一指标和相同一组标记维度的时间戳值流。除了存储的时间序列外，Prometheus 还可能根据查询结果生成临时派生时间序列。</p>
<h3 id="指标名称和标签"><a href="#指标名称和标签" class="headerlink" title="指标名称和标签"></a>指标名称和标签</h3><p>每个时间序列都通过其指标名称和可选的键值对（称为标签）来唯一标识。</p>
<p><strong>指标名称：</strong></p>
<ul>
<li>指定被测系统的一般特征（例如 - 收到的 HTTP 请求总数）。<code>http_requests_total</code></li>
<li>指标名称可以包含 ASCII 字母、数字、下划线和冒号。它必须与 regex（正则表达式） 匹配。<code>[a-zA-Z_:][a-zA-Z0-9_:]*</code></li>
</ul>
<p>注意：冒号是为用户定义的录制规则保留的。导出器或直接检测不应使用它们。</p>
<p><strong>指标标签：</strong></p>
<ul>
<li>启用 Prometheus 的维度数据模型，以识别同一指标名称的任何给定标签组合。它标识该指标的特定维度实例（例如：使用该方法的所有 HTTP 请求到处理程序）。查询语言允许基于这些维度进行筛选和聚合。<code>POST``/api/tracks</code></li>
<li>更改任何标签的值（包括添加或删除标签）都将创建新的时间序列。</li>
<li>标签可以包含 ASCII 字母、数字以及下划线。它们必须与 regex 匹配。<code>[a-zA-Z_][a-zA-Z0-9_]*</code></li>
<li>以 （两个 “_”） 开头的标签名称保留供内部使用。<code>__</code></li>
<li>标签值可以包含任何 Unicode 字符。</li>
<li>标签值为空的标签被视为等同于不存在的标签。</li>
</ul>
<p>例如，假设你有一个指标名称叫做 <code>http_requests</code>，用来记录HTTP请求的数量。你可以添加一些标签来进一步描述这些请求，比如：</p>
<ul>
<li><code>method=&quot;GET&quot;</code>：表示这是一个GET请求。</li>
<li><code>handler=&quot;/api/users&quot;</code>：表示请求是针对<code>/api/users</code>这个处理程序的。</li>
<li><code>status=&quot;200&quot;</code>：表示请求成功返回了状态码200。</li>
</ul>
<p>因此，一个带有标签的时间序列可能看起来像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests&#123;method=&quot;GET&quot;, handler=&quot;/api/users&quot;, status=&quot;200&quot;&#125;  50</span><br></pre></td></tr></table></figure>

<p>在这个例子中，<code>method</code>、<code>handler</code> 和 <code>status</code> 就是标签，它们为 <code>http_requests</code> 指标提供了额外的上下文信息。这些标签可以帮助你在查询和分析数据时更精确地定位和分类时间序列</p>
<p>例如，如果你在监控一个网站的访问量，一个样品可能如下所示：</p>
<ul>
<li>值（float64）：<code>120.5</code>（例如，表示在某个特定时刻的每秒访问量）</li>
<li>时间戳（毫秒精度）：<code>2024-03-24T13:52:37.456Z</code>（表示这个访问量数据是在2024年3月24日13时52分37秒456毫秒时记录的）</li>
</ul>
<p>在Prometheus中，这样的样品可能会被存储和表示为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;method=&quot;GET&quot;, handler=&quot;/api/users&quot;&#125; 120.5 1679600377456</span><br></pre></td></tr></table></figure>

<h2 id="Prometheus的指标类型（4种）"><a href="#Prometheus的指标类型（4种）" class="headerlink" title="Prometheus的指标类型（4种）"></a>Prometheus的指标类型（4种）</h2><p>Prometheus 客户端库提供了四种核心指标类型。这些类型目前<strong>仅在客户端库中有所区分</strong>（以支持针对特定类型使用而定制的API），以及<strong>在网络协议中有所区分</strong>。Prometheus 服务器尚未利用这些类型信息，而是将所有数据扁平化为无类型的时序数据。</p>
<h3 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h3><p><strong>计数器的定义</strong>：</p>
<ul>
<li>计数器是一种累积式指标（cumulative metric），意味着它的值<strong>只能增加或在重启时重置为零</strong>。</li>
<li>计数器的值是单调递增的，即它<strong>只能上升，不能下降</strong>。</li>
</ul>
<p><strong>计数器的用途</strong>：</p>
<ul>
<li>计数器可以用来表示请求的数量、完成的任务数量或发生的错误数量等。</li>
<li>这些场景下的数值都是随着时间的推移而增加的，或者在服务重启时重置。</li>
</ul>
<p><strong>计数器的使用方法</strong>：</p>
<ul>
<li>不应该使用计数器来表示可能减少的值。例如，不应该用计数器来表示当前正在运行的进程数量。</li>
<li>对于可能减少的值，应该使用另一种类型的指标，如<strong>仪表（gauge）</strong>。</li>
</ul>
<p><strong>例子</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Counter</span><br><span class="line">c = Counter(<span class="string">&#x27;my_failures&#x27;</span>, <span class="string">&#x27;Description of counter&#x27;</span>)</span><br><span class="line">c.inc()     <span class="comment"># Increment by 1</span></span><br><span class="line">c.inc(<span class="number">1.6</span>)  <span class="comment"># Increment by given value</span></span><br></pre></td></tr></table></figure>

<h3 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h3><p><strong>仪表的定义</strong>：</p>
<ul>
<li>仪表是一种可以任意上升或下降的单个数值指标。</li>
<li>与计数器（Counter）不同，仪表的值没有单调性要求，即它的值可以增加也可以减少。</li>
</ul>
<p><strong>仪表的用途</strong>：</p>
<ul>
<li>仪表通常用于表示测量值，如温度、当前内存使用量等。</li>
<li>也适用于那些可以上升和下降的“计数”，例如并发请求的数量。</li>
</ul>
<p><strong>仪表的应用场景</strong>：</p>
<ul>
<li>当你需要监控的数值会随着时间变化而增减时，使用仪表是合适的。</li>
<li>例如，如果你想要<strong>监控当前系统中正在运行的进程数量</strong>，这个数量可能会随着进程的启动和结束而变化，这时就应该使用仪表。</li>
<li>另一个例子是监控队列中的任务数量，这个数量也会随着任务的添加和完成而变化。</li>
</ul>
<h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><p><strong>直方图的定义和用途</strong>：</p>
<ul>
<li>直方图用于<strong>采样观察值</strong>（例如请求持续时间或响应大小），并将这些观察值计数在可配置的桶（buckets）中。</li>
<li>它还提供了所有观察值的总和。</li>
</ul>
<p><strong>直方图的暴露时间序列</strong>：</p>
<ul>
<li>在Prometheus中，直方图在一次抓取（scrape）过程中会暴露多个时间序列。这些时间序列基于基本指标名称（basename）。</li>
</ul>
<p><strong>直方图暴露的具体时间序列</strong>：</p>
<ul>
<li><strong>观察桶的累积计数器</strong>：这些计数器表示每个桶中观察值的数量，暴露为 <code>&lt;basename&gt;_bucket{le=&quot;&lt;upper inclusive bound&gt;&quot;}</code>。这里的 <code>le</code> 表示“小于或等于”（less than or equal to），<code>&lt;upper inclusive bound&gt;</code> 是桶的上界。</li>
<li><strong>所有观察值的总和</strong>：暴露为 <code>&lt;basename&gt;_sum</code>。</li>
<li><strong>已观察事件的计数</strong>：暴露为 <code>&lt;basename&gt;_count</code>。这个计数与 <code>&lt;basename&gt;_bucket{le=&quot;+Inf&quot;}</code> 相同，表示所有观察值的总数。</li>
</ul>
<p><strong>计算分位数</strong>：</p>
<ul>
<li>使用 <code>histogram_quantile()</code> 函数可以从直方图中计算分位数，甚至可以计算直方图聚合的分位数。</li>
<li>直方图也适合计算 Apdex 分数（一种衡量用户体验的指标）。</li>
</ul>
<p><strong>直方图的累积性质</strong>：</p>
<ul>
<li>当操作桶时，需要记住直方图是累积的。这意味着每个桶包括它自身以及所有更小桶的观察值。</li>
</ul>
<p><strong>直方图与摘要（Summaries）的区别</strong>：</p>
<ul>
<li>直方图是暴露桶观察计数器给服务端，计算分位数是交给服务端来计算。摘要直接暴露分位数，分位数的计算由客户端进行计算 ，缓解服务端压力。</li>
</ul>
<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p>下面结合一个具体的请求响应时间监控的例子，来详细讲解直方图的相关概念：</p>
<p>假设我们正在监控一个 Web 应用的请求响应时间，使用直方图来统计这些响应时间的分布情况。我们将基础指标名称设定为 <code>http_request_duration_seconds</code>。</p>
<h5 id="样本观测与桶计数"><a href="#样本观测与桶计数" class="headerlink" title="样本观测与桶计数"></a>样本观测与桶计数</h5><ul>
<li><p>我们预先配置了以下几个桶来统计请求响应时间：[0.1, 0.2, 0.5, 1.0, 2.0]，单位是秒。这意味着我们把响应时间划分为以下几个区间：</p>
<ul>
<li>小于等于 0.1 秒</li>
<li>大于 0.1 秒且小于等于 0.2 秒</li>
<li>大于 0.2 秒且小于等于 0.5 秒</li>
<li>大于 0.5 秒且小于等于 1.0 秒</li>
<li>大于 1.0 秒且小于等于 2.0 秒</li>
</ul>
</li>
<li><p>在一段时间内，Web 应用处理了 100 个请求，响应时间各不相同。直方图会对每个请求的响应时间进行采样，并将其归入相应的桶中。假设统计结果如下：</p>
<ul>
<li>响应时间小于等于 0.1 秒的请求有 20 个</li>
<li>响应时间大于 0.1 秒且小于等于 0.2 秒的请求有 30 个</li>
<li>响应时间大于 0.2 秒且小于等于 0.5 秒的请求有 25 个</li>
<li>响应时间大于 0.5 秒且小于等于 1.0 秒的请求有 15 个</li>
<li>响应时间大于 1.0 秒且小于等于 2.0 秒的请求有 10 个</li>
</ul>
</li>
</ul>
<h5 id="直方图暴露的时间序列"><a href="#直方图暴露的时间序列" class="headerlink" title="直方图暴露的时间序列"></a>直方图暴露的时间序列</h5><ul>
<li><p>观测桶的累积计数器 ，由于直方图是累积的，每个桶的计数包含了小于或等于该桶上限的所有观测值的数量。所以，我们会得到以下时间序列：</p>
<ul>
<li><code>http_request_duration_seconds_bucket{le=&quot;0.1&quot;}</code> &#x3D; 20 ，表示响应时间小于等于 0.1 秒的请求数量为 20 个。</li>
<li><code>http_request_duration_seconds_bucket{le=&quot;0.2&quot;}</code> &#x3D; 20 + 30 &#x3D; 50 ，表示响应时间小于等于 0.2 秒的请求数量为 50 个（包含了小于等于 0.1 秒的 20 个）。</li>
<li><strong>http_request_duration_seconds_bucket{le&#x3D;”0.1”}[5m]</strong></li>
<li><code>http_request_duration_seconds_bucket{le=&quot;0.5&quot;}</code> &#x3D; 20 + 30 + 25 &#x3D; 75 ，表示响应时间小于等于 0.5 秒的请求数量为 75 个。</li>
<li><code>http_request_duration_seconds_bucket{le=&quot;1.0&quot;}</code> &#x3D; 20 + 30 + 25 + 15 &#x3D; 90 ，表示响应时间小于等于 1.0 秒的请求数量为 90 个。</li>
<li><code>http_request_duration_seconds_bucket{le=&quot;2.0&quot;}</code> &#x3D; 20 + 30 + 25 + 15 + 10 &#x3D; 100 ，表示响应时间小于等于 2.0 秒的请求数量为 100 个。</li>
<li><code>http_request_duration_seconds_bucket{le=&quot;+Inf&quot;}</code> &#x3D; 100 ，因为 <code>+Inf</code> 表示正无穷大，所以这个桶包含了所有的请求。</li>
</ul>
</li>
<li><p>所有观测值的总和</p>
</li>
</ul>
<p>假设这 100 个请求的响应时间总和是 35 秒，那么会暴露时间序列 <code>http_request_duration_seconds_sum</code> &#x3D; 35 。这个值可以用来计算平均响应时间等统计信息。</p>
<ul>
<li>观测事件的计数</li>
</ul>
<p>时间序列 <code>http_request_duration_seconds_count</code> &#x3D; 100 ，这与 <code>http_request_duration_seconds_bucket{le=&quot;+Inf&quot;}</code> 的值是相同的，都表示总的请求数量。</p>
<h5 id="直方图的常见用途"><a href="#直方图的常见用途" class="headerlink" title="直方图的常见用途"></a>直方图的常见用途</h5><ul>
<li>分位数计算</li>
</ul>
<p>使用 <code>histogram_quantile()</code> 函数可以计算分位数。例如，我们想计算响应时间的 90 分位数（90 分位数就是将数据从小到大排序后，使得 90% 的数据小于等于该值，10% 的数据大于该值），可以使用以下 PromQL 查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">histogram_quantile(0.9, http_request_duration_seconds_bucket)</span><br></pre></td></tr></table></figure>

<p>这个查询会根据直方图的数据计算出有 90% 的请求响应时间小于该值的具体时间，帮助我们了解系统在大多数情况下的性能表现。</p>
<ul>
<li><p>Apdex 分数计算  假设我们定义 Apdex 的满意时间阈值为 0.2 秒，可容忍时间阈值为 1.0 秒。根据直方图的数据，我们可以计算出：</p>
<ul>
<li><p>满意的请求数量（响应时间小于等于 0.2 秒）：50 个</p>
</li>
<li><p>可容忍的请求数量（响应时间大于 0.2 秒且小于等于 1.0 秒）：90 - 50 &#x3D; 40 个</p>
</li>
<li><p>不满意的请求数量（响应时间大于 1.0 秒）：100 - 90 &#x3D; 10 个</p>
</li>
</ul>
</li>
</ul>
<p>根据 Apdex 分数的计算公式：<code>Apdex = (满意请求数 + 可容忍请求数 / 2) / 总请求数</code>，可以计算出该应用的 Apdex 分数为 <code>(50 + 40 / 2) / 100 = 0.7</code> ，这个分数可以直观地反映出用户对应用性能的满意度。</p>
<h3 id="Summary-1888滑动时间默认值，【】"><a href="#Summary-1888滑动时间默认值，【】" class="headerlink" title="Summary (1888滑动时间默认值，【】)"></a>Summary (1888滑动时间默认值，【】)</h3><h4 id="摘要的定义和用途"><a href="#摘要的定义和用途" class="headerlink" title="摘要的定义和用途"></a>摘要的定义和用途</h4><ul>
<li>摘要用于采样观察值（例如请求持续时间或响应大小）。</li>
<li>它提供了观察值的总数和所有观察值的总和。</li>
<li>与直方图不同的是，摘要计算的是可配置的分位数（quantiles），这些分位数是在滑动时间窗口上计算的。</li>
</ul>
<h4 id="摘要暴露的时间序列"><a href="#摘要暴露的时间序列" class="headerlink" title="摘要暴露的时间序列"></a>摘要暴露的时间序列</h4><p>在Prometheus中，一个摘要指标在一次抓取（scrape）过程中会暴露多个时间序列。这些时间序列基于基本指标名称（basename）：</p>
<ol>
<li><strong>流式φ-分位数</strong>：φ-分位数（0 ≤ φ ≤ 1）表示在滑动时间窗口内观察到的事件的分位数，暴露为 <code>&lt;basename&gt;{quantile=&quot;&lt;φ&gt;&quot;}</code>。这里的φ是一个介于0和1之间的数值，表示分位数。例如，<code>&lt;basename&gt;{quantile=&quot;0.5&quot;}</code> 表示中位数（50%的分位数）。</li>
<li><strong>所有观察值的总和</strong>：暴露为 <code>&lt;basename&gt;_sum</code>。这表示在滑动时间窗口内所有观察值的总和。</li>
<li><strong>已观察事件的计数</strong>：暴露为 <code>&lt;basename&gt;_count</code>。这表示在滑动时间窗口内观察到的事件总数。</li>
</ol>
<h4 id="φ-分位数"><a href="#φ-分位数" class="headerlink" title="φ-分位数"></a>φ-分位数</h4><p>φ-分位数是一种统计量，用于描述数据分布的特定百分位。例如，φ&#x3D;0.5表示中位数，φ&#x3D;0.9表示90%的数据点都低于这个值。在摘要中，你可以配置不同的φ值来计算不同的分位数，这对于了解数据的分布情况非常有用。</p>
<h4 id="摘要与直方图的区别"><a href="#摘要与直方图的区别" class="headerlink" title="摘要与直方图的区别"></a>摘要与直方图的区别</h4><ul>
<li><strong>直方图</strong>：提供一系列预定义的桶，用于计算落入每个桶的观测值数量。直方图是累积的，每个桶包括它自身以及所有更小桶的观测值。</li>
<li><strong>摘要</strong>：计算滑动时间窗口内的分位数，不提供桶的计数。摘要不是累积的，它只计算在滑动窗口内的观测值。</li>
</ul>
<h4 id="使用摘要"><a href="#使用摘要" class="headerlink" title="使用摘要"></a>使用摘要</h4><p>摘要适用于需要了解数据分布的实时统计信息的场景，如计算请求持续时间的中位数或90%分位数。这些信息可以帮助你了解大多数请求的性能，以及可能存在的性能瓶颈。</p>
<h3 id="指标类型为什么只在客户端分类"><a href="#指标类型为什么只在客户端分类" class="headerlink" title="指标类型为什么只在客户端分类"></a>指标类型为什么只在客户端分类</h3><p> <strong>客户端和服务端的区别</strong></p>
<ul>
<li><strong>客户端</strong>：在 Prometheus 体系中，客户端通常是指被监控的应用程序或服务所在的一端。它负责收集自身的各种运行指标数据，如应用程序的请求响应时间、内存使用量、CPU 使用率等，并按照 Prometheus 规定的格式和协议将这些数据提供给服务端。客户端需要使用 Prometheus 的客户端库来实现指标的定义、收集和暴露等功能。不同的编程语言都有相应的 Prometheus 客户端库，如 Python 的 <code>prometheus_client</code> 库。</li>
<li><strong>服务端</strong>：Prometheus 服务端是专门用于存储、管理和查询指标数据的组件。它会定期从各个客户端（也称为目标）抓取指标数据，并将这些数据存储在本地的时间序列数据库中。服务端提供了强大的查询语言（PromQL），用于对存储的指标数据进行分析、聚合和可视化展示等操作。</li>
</ul>
<p>在 Prometheus 监控体系中，客户端收集数据的方式既可以借助 Exporter，也可以自己编写代码。</p>
<p><strong>使用 Exporter 收集数据</strong></p>
<ul>
<li><strong>Exporter 的作用</strong>：Exporter 是一种专门为 Prometheus 设计的代理程序，其主要功能是将各种不同类型系统或服务的指标数据转换为 Prometheus 能够识别的格式。比如，Node Exporter 可以收集服务器节点的 CPU、内存、磁盘等系统指标；MySQL Exporter 可以收集 MySQL 数据库的查询性能、连接数等指标。</li>
<li><strong>适用场景</strong>：当你要监控的目标是常见的系统或服务，且已有对应的 Exporter 时，使用 Exporter 是非常便捷的选择。你无需了解这些系统或服务内部复杂的指标收集逻辑，只需要安装并配置好相应的 Exporter，它就会自动收集和暴露指标数据。例如，<strong>要监控 Linux 服务器的性能，安装并启动 Node Exporter 后</strong>，Prometheus 就能从其暴露的 <code>/metrics</code> 端点获取服务器的各项指标。</li>
</ul>
<p><strong>自己编写代码收集数据</strong></p>
<ul>
<li><strong>代码收集的必要性</strong>：在某些情况下，你无法使用现有的 Exporter，或者需要对应用程序的特定业务指标进行监控，这时就需要自己编写代码来收集数据。比如，你想监控其他数据库例如postgreSQL，没有现成的 Exporter 可以使用。</li>
<li><strong>代码实现方式</strong>：借助 Prometheus 提供的客户端库，你可以轻松地在代码中定义和收集指标。不同的编程语言都有对应的客户端库，例如 Python 的 <code>prometheus_client</code>、Java 的 <code>prometheus_client_java</code> 等。在代码中，你可以根据业务需求选择合适的指标类型，如使用 Counter 记录请求次数，使用 Summary 统计请求响应时间的分布等。以下是一个 Python 示例：</li>
<li><strong>2888：运行</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> psycopg2</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> start_http_server, Gauge, Histogram, Summary</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 Prometheus 指标</span></span><br><span class="line"><span class="comment"># 连接数指标</span></span><br><span class="line">POSTGRES_CONNECTIONS = Gauge(<span class="string">&#x27;postgresql_connections&#x27;</span>, <span class="string">&#x27;Number of current connections to PostgreSQL&#x27;</span>)</span><br><span class="line"><span class="comment"># 活动事务数指标</span></span><br><span class="line">POSTGRES_ACTIVE_TRANSACTIONS = Gauge(<span class="string">&#x27;postgresql_active_transactions&#x27;</span>, <span class="string">&#x27;Number of active transactions in PostgreSQL&#x27;</span>)</span><br><span class="line"><span class="comment"># 数据库大小指标</span></span><br><span class="line">POSTGRES_DATABASE_SIZE = Gauge(<span class="string">&#x27;postgresql_database_size_bytes&#x27;</span>, <span class="string">&#x27;Size of the PostgreSQL database in bytes&#x27;</span>)</span><br><span class="line"><span class="comment"># 直方图指标，用于监控查询执行时间的分布</span></span><br><span class="line">POSTGRES_QUERY_DURATION_HISTOGRAM = Histogram(<span class="string">&#x27;postgresql_query_duration_seconds&#x27;</span>, <span class="string">&#x27;Duration of PostgreSQL queries&#x27;</span>,</span><br><span class="line">                                               buckets=[<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">5.0</span>])</span><br><span class="line"><span class="comment"># 摘要指标，用于监控查询执行时间的分位数</span></span><br><span class="line">POSTGRES_QUERY_DURATION_SUMMARY = Summary(<span class="string">&#x27;postgresql_query_duration_summary_seconds&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;Summary of PostgreSQL query durations&#x27;</span>)<span class="number">888</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_postgres_metrics</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 连接到 PostgreSQL 数据库，根据实际情况修改连接信息</span></span><br><span class="line">        conn = psycopg2.connect(</span><br><span class="line">            database=<span class="string">&quot;your_database&quot;</span>,</span><br><span class="line">            user=<span class="string">&quot;your_user&quot;</span>,</span><br><span class="line">            password=<span class="string">&quot;your_password&quot;</span>,</span><br><span class="line">            host=<span class="string">&quot;your_host&quot;</span>,</span><br><span class="line">            port=<span class="string">&quot;your_port&quot;</span></span><br><span class="line">        )</span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 查询当前连接数</span></span><br><span class="line">        cursor.execute(<span class="string">&quot;SELECT count(*) FROM pg_stat_activity;&quot;</span>)</span><br><span class="line">        connections = cursor.fetchone()[<span class="number">0</span>]</span><br><span class="line">        POSTGRES_CONNECTIONS.<span class="built_in">set</span>(connections)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 查询活动事务数</span></span><br><span class="line">        cursor.execute(<span class="string">&quot;SELECT count(*) FROM pg_stat_activity WHERE state = &#x27;active&#x27;;&quot;</span>)</span><br><span class="line">        active_transactions = cursor.fetchone()[<span class="number">0</span>]</span><br><span class="line">        POSTGRES_ACTIVE_TRANSACTIONS.<span class="built_in">set</span>(active_transactions)</span><br><span class="line">        <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 查询数据库大小</span></span><br><span class="line">        cursor.execute(<span class="string">&quot;SELECT pg_database_size(current_database());&quot;</span>)</span><br><span class="line">        database_size = cursor.fetchone()[<span class="number">0</span>]</span><br><span class="line">        POSTGRES_DATABASE_SIZE.<span class="built_in">set</span>(database_size)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 模拟执行一个查询，并记录查询执行时间</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        cursor.execute(<span class="string">&quot;SELECT 1;&quot;</span>)</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        query_duration = end_time - start_time</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录查询执行时间到直方图和摘要指标</span></span><br><span class="line">        POSTGRES_QUERY_DURATION_HISTOGRAM.observe(query_duration)</span><br><span class="line">        POSTGRES_QUERY_DURATION_SUMMARY.observe(query_duration)</span><br><span class="line"></span><br><span class="line">        cursor.close()</span><br><span class="line">        conn.close()</span><br><span class="line">    <span class="keyword">except</span> (Exception, psycopg2.Error) <span class="keyword">as</span> error:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error while connecting to PostgreSQL or querying metrics: <span class="subst">&#123;error&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 启动一个 HTTP 服务器，监听 8000 端口，用于暴露 Prometheus 指标</span></span><br><span class="line">    start_http_server(<span class="number">8000</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 每隔 15 秒获取一次 PostgreSQL 指标</span></span><br><span class="line">        get_postgres_metrics()</span><br><span class="line">        time.sleep(<span class="number">15</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>在这个示例中，我们使用三个指标来记录。然后启动一个 HTTP 服务器，将指标暴露在 8000 端口的 <code>/metrics</code> 端点，供 Prometheus 抓取。</p>
<p><strong>客户端配置好后如何配置服务器端呢？</strong></p>
<p>当你使用客户端代码将 PostgreSQL 指标暴露在本地的 8000 端口后，需要对 Prometheus 服务端进行配置，使其能够定期从该端点抓取指标数据。以下是具体的配置步骤：</p>
<p><strong>1. 编辑 Prometheus 配置文件</strong></p>
<p>Prometheus 的配置文件通常是 <code>prometheus.yml</code>，你需要在这个文件中添加一个新的 <code>scrape_config</code> 部分，以指定要监控的目标和相关参数。以下是一个示例配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span>  <span class="comment"># 全局抓取间隔，每 15 秒抓取一次指标</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span>  <span class="comment"># 规则评估间隔，每 15 秒评估一次告警规则</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 告警配置（可选）</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则文件（可选）</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># Prometheus 自身监控配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]  <span class="comment"># Prometheus 自身的监控端点</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># PostgreSQL 指标监控配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;postgresql_metrics&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8000&#x27;</span>]  <span class="comment"># 客户端代码暴露指标的端点</span></span><br></pre></td></tr></table></figure>

<p><strong>配置解释</strong></p>
<ul>
<li><code>global</code> 部分：<ul>
<li><code>scrape_interval</code>：定义了 Prometheus 全局的抓取间隔，这里设置为每 15 秒抓取一次指标。</li>
<li><code>evaluation_interval</code>：定义了 Prometheus 评估告警规则的间隔，同样设置为每 15 秒评估一次。</li>
</ul>
</li>
<li><code>scrape_configs</code> 部分：<ul>
<li><code>job_name</code>：为每个抓取任务指定一个名称，这里 <code>postgresql_metrics</code> 表示用于监控 PostgreSQL 指标的任务。</li>
<li><code>static_configs</code>：指定要监控的目标列表，<code>targets</code> 中的 <code>localhost:8000</code> 是客户端代码中启动的 HTTP 服务器的地址和端口，即指标暴露的端点。</li>
</ul>
</li>
</ul>
<p><strong>2. 重启 Prometheus 服务</strong></p>
<p>在修改完 <code>prometheus.yml</code> 配置文件后，需要重启 Prometheus 服务，使其加载新的配置。具体的重启命令取决于你的操作系统和 Prometheus 的安装方式。</p>
<p><strong>Linux 系统</strong></p>
<p>如果你使用 <code>systemd</code> 来管理 Prometheus 服务，可以使用以下命令重启：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart prometheus</span><br></pre></td></tr></table></figure>

<p><strong>Docker 环境</strong></p>
<p>如果你使用 Docker 运行 Prometheus，可以使用以下命令重新启动容器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart &lt;prometheus_container_id&gt;</span><br></pre></td></tr></table></figure>

<p>其中 <code>&lt;prometheus_container_id&gt;</code> 是 Prometheus 容器的 ID。</p>
<p><strong>3. 验证配置是否生效</strong></p>
<ul>
<li><strong>查看 Prometheus 状态</strong>：打开浏览器，访问 <code>http://localhost:9090</code>（如果 Prometheus 运行在本地的 9090 端口），进入 Prometheus 的 Web 界面。</li>
<li><strong>检查目标状态</strong>：在 Prometheus 界面中，点击左侧菜单中的 “Status” -&gt; “Targets”，查看 <code>postgresql_metrics</code> 任务的状态。如果状态显示为 “UP”，则表示 Prometheus 已经成功连接到客户端的指标暴露端点，并开始抓取指标数据。</li>
<li><strong>查询指标</strong>：在 Prometheus 界面的查询框中输入相关的指标名称，如 <code>postgresql_connections</code>、<code>postgresql_active_transactions</code> 或 <code>postgresql_database_size_bytes</code>，然后点击 “Execute” 按钮进行查询。如果能够看到相应的指标数据，则说明配置已经生效。</li>
</ul>
<p><strong>4. 可视化指标（可选）</strong></p>
<p>你可以使用 Grafana 等可视化工具来展示 Prometheus 中的指标数据。具体步骤如下：</p>
<ol>
<li><strong>安装和配置 Grafana</strong>：根据你的操作系统和需求，安装 Grafana 并启动服务。</li>
<li><strong>添加 Prometheus 数据源</strong>：在 Grafana 界面中，点击左侧菜单中的 “Configuration” -&gt; “Data Sources”，然后点击 “Add data source”，选择 “Prometheus”，并配置 Prometheus 的地址（通常是 <code>http://localhost:9090</code>）。</li>
<li><strong>创建仪表盘</strong>：在 Grafana 中创建一个新的仪表盘，添加相应的图表，并使用 PromQL 查询语句从 Prometheus 中获取指标数据进行展示。</li>
</ol>
<p>通过以上步骤，你就可以完成 Prometheus 服务端的配置，使其能够接收和监控客户端暴露的 PostgreSQL 指标数据。</p>
<h2 id="“安装指标类型”-的过程"><a href="#“安装指标类型”-的过程" class="headerlink" title="“安装指标类型” 的过程"></a>“安装指标类型” 的过程</h2><h3 id="内部存储时不区分指标类型"><a href="#内部存储时不区分指标类型" class="headerlink" title="内部存储时不区分指标类型"></a>内部存储时不区分指标类型</h3><p>Prometheus 采用时间序列数据库来存储数据，其核心存储的是样本（Sample），样本由指标名、标签集合以及对应的时间戳和数值构成。&#x3D;&#x3D;在存储层面，不管是 <code>Counter</code>、<code>Gauge</code>、<code>Histogram</code> 还是 <code>Summary</code> 类型的指标，都以相同的底层格式存储，也就是只关注<strong>指标名、标签、时间戳和数值</strong>，不特别区分其指标类型。这样做的好处是简化了存储逻辑，提升了存储效率。</p>
<h3 id="指标类型信息的记录"><a href="#指标类型信息的记录" class="headerlink" title="指标类型信息的记录"></a>指标类型信息的记录</h3><p>虽然存储时不区分类型，但在客户端（如应用程序中的 Exporter）向 Prometheus 服务器推送数据时，会附带指标类型的元数据。例如，Python 的 <code>prometheus_client</code> 库在定义指标时，就会明确指定指标类型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> start_http_server, Counter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个 Counter 类型的指标</span></span><br><span class="line">REQUEST_COUNTER = Counter(<span class="string">&#x27;http_requests_total&#x27;</span>, <span class="string">&#x27;Total HTTP requests&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_request</span>():</span><br><span class="line">    REQUEST_COUNTER.inc()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start_http_server(<span class="number">8000</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        process_request()</span><br></pre></td></tr></table></figure>

<p>在这个例子中，<code>REQUEST_COUNTER</code> 被明确定义为 <code>Counter</code> 类型。当客户端向 Prometheus 服务器发送数据时，会把这个类型信息一同发送过去。</p>
<h3 id="元数据的存储与关联"><a href="#元数据的存储与关联" class="headerlink" title="元数据的存储与关联"></a>元数据的存储与关联</h3><p>Prometheus 服务器接收到客户端发送的数据后，会将指标类型等元数据存储在内部的元数据结构中，并且把这些元数据和对应的时间序列关联起来。也就是说，<strong>虽然存储样本数据时不区分类型，但服务器会另外记录每个指标的类型信息，并建立起与时间序列的对应关系</strong>。</p>
<h3 id="查询和展示时利用类型信息"><a href="#查询和展示时利用类型信息" class="headerlink" title="查询和展示时利用类型信息"></a>查询和展示时利用类型信息</h3><ul>
<li><strong>查询处理</strong>：当用户发起查询请求时，Prometheus 会先从元数据中获取该指标的类型信息。例如，当使用 <code>rate()</code> 函数查询一个指标时，Prometheus 会检查该指标的类型，如果是 <code>Counter</code> 类型，就按照 <code>Counter</code> 的特性（只增不减）来计算速率；如果是其他类型，就可能给出错误提示，因为 <code>rate()</code> 函数主要用于 <code>Counter</code> 类型。</li>
<li><strong>展示处理</strong>：在将查询结果展示给用户时，可视化工具（如 Grafana）会从 Prometheus 获取指标的类型信息。根据不同的类型，采用不同的可视化方式。例如，对于 <code>Counter</code> 类型，通常展示其增长趋势；对于 <code>Gauge</code> 类型，展示当前值和变化趋势等。</li>
</ul>
<h3 id="过程类比"><a href="#过程类比" class="headerlink" title="过程类比"></a>过程类比</h3><p>可以把指标类型信息看作是一种特殊的 “标签”，它的 “安装” 过程如下：</p>
<ol>
<li><strong>客户端定义</strong>：在客户端代码里，开发者定义指标时就明确指定了指标类型，这就好比给指标贴上了类型 “标签”。</li>
<li><strong>数据传输</strong>：客户端向 Prometheus 服务器发送数据时，会把这个类型 “标签” 一同发送过去。</li>
<li><strong>服务器关联</strong>：Prometheus 服务器接收到数据后，将类型 “标签” 存储在元数据中，并和对应的时间序列关联起来，就像把标签贴到了具体的物品上。</li>
<li><strong>查询展示使用</strong>：在查询和展示时，Prometheus 或可视化工具会读取这个类型 “标签”，根据标签的内容来正确处理和展示数据。</li>
</ol>
<h1 id="Prometheus部署"><a href="#Prometheus部署" class="headerlink" title="Prometheus部署"></a>Prometheus部署</h1><p>作者：王文杰</p>
<p>日期：2024年3月25日</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>虚拟机Ubuntu20.04  内存4GB CPU2核  硬盘40GB</p>
<h2 id="安装部署prometheus"><a href="#安装部署prometheus" class="headerlink" title="安装部署prometheus"></a>安装部署prometheus</h2><p>解压prometheus</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xvfz prometheus-*.tar.gz</span><br><span class="line"><span class="built_in">cd</span> prometheus-*</span><br></pre></td></tr></table></figure>

<p>配置prometheus.yml文档（样例）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> <span class="comment"># By default, scrape targets every 15 seconds.</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># Evaluate rules every 15 seconds.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Attach these extra labels to all timeseries collected by this Prometheus instance.</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">&#x27;codelab-monitor&#x27;</span></span><br><span class="line"><span class="comment"># http_requests&#123;method=&quot;GET&quot;, handler=&quot;/api/users&quot;, status=&quot;200&quot;&#125;  50</span></span><br><span class="line"><span class="comment"># http_requests&#123;method=&quot;GET&quot;, handler=&quot;/api/users&quot;, status=&quot;200&quot; , monitor=&#x27;codelab-monitor&#x27;&#125;  50</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;prometheus.rules.yml&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;rules/*.yml&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span>       <span class="string">&#x27;node&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>, <span class="string">&#x27;localhost:8081&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">&#x27;production&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8082&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">&#x27;canary&#x27;</span></span><br></pre></td></tr></table></figure>

<p>运行prometheus</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start Prometheus.</span></span><br><span class="line"><span class="comment"># By default, Prometheus stores its database in ./data (flag --storage.tsdb.path).</span></span><br><span class="line">./prometheus --config.file=prometheus.yml</span><br></pre></td></tr></table></figure>

<h2 id="创建systemd服务"><a href="#创建systemd服务" class="headerlink" title="创建systemd服务"></a><strong>创建systemd服务</strong></h2><p>切换root用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br></pre></td></tr></table></figure>

<p>将移动解压后的文件名到&#x2F;opt&#x2F;，并改名为prometheus</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv prometheus-2.53.4.linux-amd64 /opt/prometheus</span><br></pre></td></tr></table></figure>

<p>创建一个专门的prometheus用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -M -s /user/sbin/nologin prometheus</span><br></pre></td></tr></table></figure>

<p>赋予权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown prometheus:prometheus -R /opt/prometheus</span><br></pre></td></tr></table></figure>

<p>Prometheus创建一个systemd服务单元文件，你需要创建一个名为 <code>prometheus.service</code> 的文件，并将以下内容添加到该文件中。这个文件通常位于 <code>/etc/systemd/system/</code> 目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/prometheus.service</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Prometheus Server</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=prometheus</span><br><span class="line">Group=prometheus</span><br><span class="line">Type=simple</span><br><span class="line">Restart=on-failure</span><br><span class="line">ExecStart=/opt/prometheus/prometheus \</span><br><span class="line">  --config.file=/opt/prometheus/prometheus.yml \</span><br><span class="line">  --storage.tsdb.path=/opt/prometheus/data \</span><br><span class="line">  --storage.tsdb.retention.time=60d \</span><br><span class="line">  --web.enable-lifecycle</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>运行prometheus</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start prometheus</span><br></pre></td></tr></table></figure>

<p>外部打开链接即可查看</p>
<p><a target="_blank" rel="noopener" href="http://192.168.8.130:9090/">http://192.168.8.130:9090/</a></p>
<p>查看监控指标</p>
<p><a target="_blank" rel="noopener" href="http://192.168.8.130:9090/metrics">http://192.168.8.130:9090/metrics</a></p>
<h3 id="systemctl-命令"><a href="#systemctl-命令" class="headerlink" title="systemctl 命令"></a>systemctl 命令</h3><p><strong>停止服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl stop &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>查看服务状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl status &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>显示服务的详细信息，包括它是否正在运行、启动日志等。</p>
<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>查看服务是否设置为开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl is-enabled &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>如果服务已启用，命令将输出 <code>enabled</code>；如果未启用，则输出 <code>disabled</code>。</p>
<p>设置服务开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>禁用服务开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>查看所有已加载的服务单元</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units --<span class="built_in">type</span>=service</span><br></pre></td></tr></table></figure>

<p>查看所有已启用的服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --<span class="built_in">type</span>=service</span><br></pre></td></tr></table></figure>

<p>查看服务的日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u &lt;服务名&gt;</span><br></pre></td></tr></table></figure>

<p>这将显示服务的日志信息，包括启动和运行时的日志。</p>
<h2 id="监控Linux服务器"><a href="#监控Linux服务器" class="headerlink" title="监控Linux服务器"></a>监控Linux服务器</h2><p>服务器上下载Node_exporter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf node_exporter-*.*.tar.gz</span><br><span class="line"><span class="built_in">cd</span> node_exporter-*.*</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start 3 example targets in separate terminals:</span></span><br><span class="line">./node_exporter --web.listen-address 127.0.0.1:8080</span><br><span class="line">./node_exporter --web.listen-address 127.0.0.1:8081</span><br><span class="line">./node_exporter --web.listen-address 127.0.0.1:8082</span><br></pre></td></tr></table></figure>

<p>prometheus.yml文件增加信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span>       <span class="string">&#x27;node&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>, <span class="string">&#x27;localhost:8081&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">&#x27;production&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8082&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">&#x27;canary&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置查询规则</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</span><br></pre></td></tr></table></figure>

<p>创建prometheus.rules.yml文件，写入如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu-node</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">job_instance_mode:node_cpu_seconds:avg_rate5m</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">avg</span> <span class="string">by</span> <span class="string">(job,</span> <span class="string">instance,</span> <span class="string">mode)</span> <span class="string">(rate(node_cpu_seconds_total[5m]))</span></span><br></pre></td></tr></table></figure>

<p>prometheus.yml文件规则信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;prometheus.rules.yml&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这样输入<code>job_instance_mode:node_cpu_seconds:avg_rate5m</code>  就能执行代码<code>avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</code></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>要指定要加载的配置文件，请使用 flag。<code>--config.file</code></p>
<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># Prometheus 抓取目标的频率，默认是 1 分钟.</span></span><br><span class="line">  [ <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 抓取请求的超时时间，不能大于scrape_interval，默认是 10 秒。</span></span><br><span class="line">  [ <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">10s</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 在与客户端进行抓取时协商的协议，默认包括OpenMetricsText1.0.0、OpenMetricsText0.0.1和PrometheusText0.0.4等</span></span><br><span class="line">  [ <span class="attr">scrape_protocols:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> [ <span class="string">OpenMetricsText1.0.0</span>, <span class="string">OpenMetricsText0.0.1</span>, <span class="string">PrometheusText0.0.4</span> ] ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 评估规则的频率</span></span><br><span class="line">  [ <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 用于将规则评估时间戳向前偏移，以确保底层指标已被接收，默认是 0 秒。</span></span><br><span class="line">  [ <span class="attr">rule_query_offset:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">0s</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 添加到与外部系统（联邦、远程存储、Alertmanager）通信的任何时间序列或警报的标签</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    [ <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># PromQL 查询日志记录到的文件，重新加载配置会重新打开文件。</span></span><br><span class="line">  [ <span class="attr">query_log_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 抓取失败日志存储文件</span></span><br><span class="line">  [ <span class="attr">scrape_failure_log_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 未压缩的响应体大于此字节数将导致抓取失败，0 表示无限制</span></span><br><span class="line">  [ <span class="attr">body_size_limit:</span> <span class="string">&lt;size&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 每次抓取接受的样本数量限制，0 表示无限制。</span></span><br><span class="line">  [ <span class="attr">sample_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 每个样本接受的标签数量限制，0 表示无限制。</span></span><br><span class="line">  [ <span class="attr">label_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 每个标签名的长度（以字节为单位）限制，0 表示无限制。</span></span><br><span class="line">  [ <span class="attr">label_name_length_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 每个标签值的长度（以字节为单位）限制，0 表示无限制。</span></span><br><span class="line">  [ <span class="attr">label_value_length_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 每个抓取配置中接受的唯一目标数量限制，0 表示无限制。</span></span><br><span class="line">  [ <span class="attr">target_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># - 每个抓取配置中保留在内存中的通过重新标记丢弃的目标数量，0 表示无限制。</span></span><br><span class="line">  [ <span class="attr">keep_dropped_targets:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 指标和标签名称的验证方案，可选值为`utf8`或`legacy`，默认是`utf8`</span></span><br><span class="line">  [ <span class="string">metric_name_validation_scheme</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;utf8&quot;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="attr">runtime:</span></span><br><span class="line">  <span class="comment"># 配置 Go 垃圾收集器的`GOGC`参数，默认是 75，降低此值会增加 CPU 使用率。</span></span><br><span class="line">  <span class="comment"># See: https://tip.golang.org/doc/gc-guide#GOGC</span></span><br><span class="line">  [ <span class="attr">gogc:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">75</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定包含规则和警报的文件的通配符列表，Prometheus 会读取所有匹配的文件。</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定包含抓取配置的文件的通配符列表，Prometheus 会读取所有匹配的文件并将配置追加到抓取配置列表中。</span></span><br><span class="line"><span class="attr">scrape_config_files:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置列表，用于定义要抓取的目标和相关配置。</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;scrape_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="comment"># 用于警报的重新标记配置列表。</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line">   <span class="comment"># Alertmanager 配置列表，用于指定 Alertmanager 的地址等信息。</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;alertmanager_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与远程写入功能相关的设置，用于将数据发送到远程存储。</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_write&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the OTLP receiver feature.</span></span><br><span class="line"><span class="comment"># See https://prometheus.io/docs/guides/opentelemetry/ for best practices.</span></span><br><span class="line"><span class="attr">otlp:</span></span><br><span class="line">	<span class="comment">#指定要提升为 Prometheus 指标的 OTLP 资源属性列表。</span></span><br><span class="line">  [ <span class="attr">promote_resource_attributes:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> [ ] ]</span><br><span class="line"> 	<span class="comment">#配置通过 OTLP 指标端点接收 OTLP 指标时的转换策略。</span></span><br><span class="line">  [ <span class="attr">translation_strategy:</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&quot;UnderscoreEscapingWithSuffixes&quot;</span> ]</span><br><span class="line">  	<span class="comment"># 是否将某些资源属性添加到`target_info`指标中，默认是`false`。</span></span><br><span class="line">  [ <span class="attr">keep_identifying_resource_attributes:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#与远程读取功能相关的设置，用于从远程存储读取数据。</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_read&gt;</span> <span class="string">...</span> ]</span><br><span class="line">  </span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="comment"># 与时间序列数据库（TSDB）相关的配置。</span></span><br><span class="line">  [ <span class="attr">tsdb:</span> <span class="string">&lt;tsdb&gt;</span> ]</span><br><span class="line">  <span class="comment">#与示例（exemplars）相关的配置。</span></span><br><span class="line">  [ <span class="attr">exemplars:</span> <span class="string">&lt;exemplars&gt;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于配置跟踪信息的导出，目前配置内容为空，可根据实际需求进行配置。</span></span><br><span class="line"><span class="attr">tracing:</span></span><br><span class="line">  [ <span class="string">&lt;tracing_config&gt;</span> ]</span><br></pre></td></tr></table></figure>

<h4 id="evaluation"><a href="#evaluation" class="headerlink" title="evaluation"></a>evaluation</h4><p>在 Prometheus 中，“评估规则的频率” 指的是 Prometheus 对规则文件里定义的规则（包括<strong>记录规则和告警规则</strong>）进行计算和评估的时间间隔。这一频率由 <code>evaluation_interval</code> 参数设定，默认值为 1 分钟。下面分别为你介绍记录规则和告警规则的评估情况：</p>
<h5 id="记录规则评估"><a href="#记录规则评估" class="headerlink" title="记录规则评估"></a>记录规则评估</h5><p>记录规则可以把复杂的 PromQL 查询表达式预先计算并保存为新的时间序列数据，以此提升后续查询的效率。评估规则的频率决定了 Prometheus 多长时间重新计算一次这些规则，并更新对应的记录指标。</p>
<p><strong>示例</strong></p>
<p>假设你定义了一个记录规则，用于计算每 5 分钟内 HTTP 请求的平均响应时间：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http_metrics</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">job_instance:http_request_duration_seconds:avg_rate5m</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">avg</span> <span class="string">by</span> <span class="string">(job,</span> <span class="string">instance)</span> <span class="string">(rate(http_request_duration_seconds_sum[5m])</span> <span class="string">/</span> <span class="string">rate(http_request_duration_seconds_count[5m]))</span></span><br></pre></td></tr></table></figure>

<p>若 <code>evaluation_interval</code> 设置为 1 分钟，那么 Prometheus 会每分钟对这个规则进行一次评估，重新计算 <code>job_instance:http_request_duration_seconds:avg_rate5m</code> 指标的值，并更新对应的时间序列数据。</p>
<h5 id="告警规则评估"><a href="#告警规则评估" class="headerlink" title="告警规则评估"></a>告警规则评估</h5><p>告警规则用于定义触发告警的条件。评估规则的频率决定了 Prometheus 多久检查一次这些条件是否满足，进而判断是否需要触发告警。</p>
<p><strong>示例</strong></p>
<p>假设你定义了一个告警规则，当 CPU 使用率超过 80% 时触发告警：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_alerts</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighCPUUsage</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High CPU usage on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has a CPU usage of <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%.&quot;</span></span><br></pre></td></tr></table></figure>

<p>若 <code>evaluation_interval</code> 设置为 1 分钟，Prometheus 会每分钟检查一次 <code>expr</code> 表达式的计算结果是否满足条件（即 CPU 使用率是否超过 80%）。若连续 5 分钟（由 <code>for</code> 字段指定）都满足条件，就会触发告警。</p>
<p><strong>频率设置的影响</strong></p>
<ul>
<li><strong>频率过高</strong>：会让 Prometheus 频繁进行规则计算，增加 CPU 和内存的使用量，可能影响系统性能。</li>
<li><strong>频率过低</strong>：可能导致告警延迟触发，无法及时发现系统问题；或者记录指标的数据更新不及时，影响监控和分析的实时性。</li>
</ul>
<p><strong>记录规则和告警规则融合</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">  - name: node_metrics_rules</span><br><span class="line">    rules:</span><br><span class="line">      # 记录规则：计算每个实例的 CPU 使用率</span><br><span class="line">      - record: instance_cpu_usage_percentage</span><br><span class="line">        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) * 100)</span><br><span class="line">      # 告警规则：当 CPU 使用率持续 5 分钟超过 80% 时触发告警</span><br><span class="line">      - alert: HighCPUUsage</span><br><span class="line">        expr: instance_cpu_usage_percentage &gt; 80</span><br><span class="line">        for: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;High CPU usage detected on &#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">          description: &quot;The CPU usage on &#123;&#123; $labels.instance &#125;&#125; has exceeded 80% for the last 5 minutes, currently at &#123;&#123; $value &#125;&#125;%.&quot;</span><br><span class="line"></span><br><span class="line">      # 记录规则：计算每个实例的内存使用率</span><br><span class="line">      - record: instance_memory_usage_percentage</span><br><span class="line">        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100</span><br><span class="line">      # 告警规则：当内存使用率持续 10 分钟超过 90% 时触发告警</span><br><span class="line">      - alert: HighMemoryUsage</span><br><span class="line">        expr: instance_memory_usage_percentage &gt; 90</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;High memory usage detected on &#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">          description: &quot;The memory usage on &#123;&#123; $labels.instance &#125;&#125; has exceeded 90% for the last 10 minutes, currently at &#123;&#123; $value &#125;&#125;%.&quot;    </span><br></pre></td></tr></table></figure>

<h4 id="external-labels"><a href="#external-labels" class="headerlink" title="external_labels"></a>external_labels</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">&#x27;production_monitor&#x27;</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">&#x27;prod&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Alertmanager</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;alertmanager.example.com:9093&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置远程存储</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://remote-storage.example.com/api/v1/write&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>global</code> 配置块中，定义了两个外部标签：</p>
<ul>
<li><code>monitor: &#39;production_monitor&#39;</code>：表示这个监控系统是用于生产环境监控的，可用于区分不同的监控实例，比如开发环境、测试环境等。</li>
<li><code>environment: &#39;prod&#39;</code>：明确指出监控的环境是生产环境。</li>
</ul>
<h5 id="与-Alertmanager-通信时标签的作用"><a href="#与-Alertmanager-通信时标签的作用" class="headerlink" title="与 Alertmanager 通信时标签的作用"></a>与 Alertmanager 通信时标签的作用</h5><p>当 Prometheus 触发一个告警并将其发送给 Alertmanager 时，所有的告警信息都会带上这些外部标签。假设我们有一个关于 CPU 使用率过高的告警规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_alerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighCPUUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High CPU usage on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has a CPU usage of <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%.&quot;</span></span><br></pre></td></tr></table></figure>

<p>当这个告警触发时，发送给 Alertmanager 的告警信息除了本身的 <code>severity: &#39;critical&#39;</code> 标签外，还会带上 <code>monitor: &#39;production_monitor&#39;</code> 和 <code>environment: &#39;prod&#39;</code> 标签。Alertmanager 可以根据这些标签进行告警的路由和处理，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;monitor&#x27;</span>, <span class="string">&#x27;environment&#x27;</span>]</span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">12h</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&#x27;default-receiver&#x27;</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="attr">environment:</span> <span class="string">&#x27;prod&#x27;</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">&#x27;prod-critical-receiver&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在这个 Alertmanager 配置中，根据 <code>environment</code> 和 <code>severity</code> 标签，将生产环境中的严重告警路由到 <code>prod-critical-receiver</code> 进行处理。</p>
<h5 id="与远程存储通信时标签的作用"><a href="#与远程存储通信时标签的作用" class="headerlink" title="与远程存储通信时标签的作用"></a>与远程存储通信时标签的作用</h5><p>当 Prometheus 将时间序列数据写入远程存储时，这些外部标签也会被添加到每个时间序列中。例如，对于 <code>http_requests_total</code> 这个指标，原本的数据可能是：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http_requests_total&#123;job=&quot;webserver&quot;,</span> <span class="string">instance=&quot;server1.example.com&quot;&#125;</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>添加外部标签后，存储到远程存储的数据会变成：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http_requests_total&#123;job=&quot;webserver&quot;,</span> <span class="string">instance=&quot;server1.example.com&quot;,</span> <span class="string">monitor=&quot;production_monitor&quot;,</span> <span class="string">environment=&quot;prod&quot;&#125;</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>这样，在从远程存储查询数据时，可以根据这些标签进行筛选，例如只查询生产环境下的监控数据：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http_requests_total&#123;environment=&quot;prod&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过添加外部标签，可以更好地对与外部系统通信的时间序列和警报进行管理和区分，提高监控和告警系统的灵活性和可维护性。</p>
<h5 id="避免携带标签错误"><a href="#避免携带标签错误" class="headerlink" title="避免携带标签错误"></a>避免携带标签错误</h5><p>加入外部标签是生产环境，此时其他环境的实例发生了告警，那么由于外部标签是全局的，那么是否会携带标签错误呢？</p>
<p>如果在 Prometheus 中设置了全局的外部标签为<strong>生产环境</strong>，而其他环境**（如开发环境、测试环境）**的实例发生了告警，确实可能会存在标签携带不准确的情况。 因为全局外部标签会被添加到所有与外部系统通信的时间序列和警报中，无论这些实例实际处于哪个环境。这可能导致在告警信息或时间序列数据中，环境相关的标签与实际情况不符，给监控和故障排查带来一定的干扰。</p>
<p>为了避免这种情况，可以考虑以下几种解决方法：</p>
<ul>
<li><strong>使用环境特定的配置文件</strong>：为不同的环境（生产、开发、测试等）<strong>创建独立的 Prometheus</strong> 配置文件，在每个配置文件中设置相应环境的外部标签。这样，每个环境的 Prometheus 实例都会使用正确的标签来标识告警和时间序列数据。</li>
<li><strong>动态设置外部标签</strong>：通过 Prometheus 的 API 或配置管理工具，根据实际的运行环境动态地设置外部标签。例如，在启动 Prometheus 时，根据环境变量来设置不同的外部标签。</li>
<li><strong>在告警规则中添加环境判断</strong>：在告警规则中添加对环境相关标签或指标的判断，确保只有在符合特定环境条件时才触发告警，并在告警信息中准确地反映实际环境。例如：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">environment_specific_alerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">NonProdHighCPUUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">environment</span> <span class="type">!=</span> <span class="string">&#x27;prod&#x27;</span> <span class="string">&amp;&amp;</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High CPU usage in non - production environment on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> in non - production environment has a CPU usage of <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%.&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个告警规则只会在非生产环境（通过<code>environment != &#39;prod&#39;</code>判断）中，当 CPU 使用率超过 80% 时触发告警，并在告警信息中明确指出是非生产环境。</p>
<p>通过以上方法，可以更准确地处理不同环境下的告警和监控数据，避免因全局外部标签导致的标签错误问题。</p>
<h4 id="query-log-file"><a href="#query-log-file" class="headerlink" title="query_log_file"></a>query_log_file</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">query_log_file:</span> <span class="string">&quot;/var/log/prometheus/query.log&quot;</span></span><br></pre></td></tr></table></figure>

<p>上述配置指定将 PromQL 查询日志记录到 <code>/var/log/prometheus/query.log</code> 文件中。</p>
<p>scrape_failure_log_file 配置同上。</p>
<h4 id="scrape-config-files"><a href="#scrape-config-files" class="headerlink" title="scrape_config_files"></a>scrape_config_files</h4><p>在 Prometheus 中，抓取配置用于定义 Prometheus 要监控的目标以及如何从这些目标抓取指标数据。而 “指定包含抓取配置的文件的通配符列表，Prometheus 会读取所有匹配的文件并将配置追加到抓取配置列表中” 这一机制，主要是为了增强配置管理的灵活性和可维护性。</p>
<h5 id="通配符列表"><a href="#通配符列表" class="headerlink" title="通配符列表"></a>通配符列表</h5><p>通配符是一种用于匹配文件名的特殊字符。在文件路径中使用通配符，可以方便地指定一组文件名。常见的通配符有 <code>*</code> 和 <code>?</code> ，其中 <code>*</code> 可以匹配任意数量（包括零个）的任意字符，<code>?</code> 可以匹配单个任意字符。例如，<code>*.yml</code> 可以匹配所有以 <code>.yml</code> 结尾的文件，<code>config-?.yml</code> 可以匹配像 <code>config-1.yml</code>、<code>config-a.yml</code> 这类文件名。</p>
<h5 id="配置追加到抓取配置列表"><a href="#配置追加到抓取配置列表" class="headerlink" title="配置追加到抓取配置列表"></a>配置追加到抓取配置列表</h5><p>Prometheus 的主配置文件（通常是 <code>prometheus.yml</code>）中有一个 <code>scrape_config_files</code> 字段，你可以在这个字段中指定包含抓取配置的文件的通配符列表。Prometheus 启动时，会读取主配置文件，然后根据 <code>scrape_config_files</code> 中指定的通配符，去查找所有匹配的文件，并将这些文件中的抓取配置读取出来，追加到主配置文件的抓取配置列表中。</p>
<h5 id="示例说明"><a href="#示例说明" class="headerlink" title="示例说明"></a>示例说明</h5><p>假设你的 Prometheus 主配置文件 <code>prometheus.yml</code> 内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主配置文件 prometheus.yml</span></span><br><span class="line"><span class="attr">scrape_config_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;scrape-configs/*.yml&quot;</span></span><br></pre></td></tr></table></figure>

<p>这里 <code>scrape-configs/*.yml</code> 就是一个通配符列表，表示 <code>scrape-configs</code> 目录下所有以 <code>.yml</code> 结尾的文件。</p>
<p>假设 <code>scrape-configs</code> 目录下有两个文件：</p>
<ul>
<li><code>scrape-configs/app1.yml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># scrape-configs/app1.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;app1&#x27;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;app1.example.com:9090&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>scrape-configs/app2.yml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># scrape-configs/app2.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;app2&#x27;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;app2.example.com:9091&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>当 Prometheus 启动时，会读取 <code>prometheus.yml</code>，然后根据 <code>scrape-config_files</code> 中的通配符 <code>scrape-configs/*.yml</code>，找到 <code>scrape-configs/app1.yml</code> 和 <code>scrape-configs/app2.yml</code> 这两个文件，并将它们中的抓取配置追加到主配置文件的抓取配置列表中。最终，Prometheus 会将 <code>app1.example.com:9090</code> 和 <code>app2.example.com:9091</code> 作为监控目标进行指标抓取。</p>
<h4 id="alerting"><a href="#alerting" class="headerlink" title="alerting"></a>alerting</h4><p>在 Prometheus 的配置文件中，<code>alerting</code> 部分用于配置警报相关的功能，以下是 <code>alert_relabel_configs</code> 和 <code>alertmanagers</code> 的详细解释及配置示例：</p>
<h5 id="alert-relabel-configs"><a href="#alert-relabel-configs" class="headerlink" title="alert_relabel_configs"></a>alert_relabel_configs</h5><ul>
<li><strong>作用</strong>：用于对警报进行重新标记配置。可以在将警报发送到 Alertmanager 之前，根据指定的规则对警报的<strong>标签进行修改、添加或删除操作</strong>，以便更好地对警报进行分类、过滤和路由。</li>
<li>配置参数：<ul>
<li><code>source_labels</code>：指定要提取值的源标签列表。</li>
<li><code>separator</code>：多个源标签值之间的分隔符，默认为 <code>;</code>。</li>
<li><code>target_label</code>：目标标签，即要将处理后的值设置到的标签。</li>
<li><code>regex</code>：用于匹配源标签值的正则表达式，默认为 <code>(.*)</code>。</li>
<li><code>replacement</code>：匹配正则表达式后用于替换的值，默认为 <code>$1</code>。</li>
<li><code>action</code>：执行的操作，如 <code>replace</code>（替换）、<code>keep</code>（保留符合条件的）、<code>drop</code>（丢弃符合条件的）等。</li>
</ul>
</li>
<li><strong>配置示例</strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">      <span class="attr">regex:</span> <span class="string">&#x27;HighCPUUsage&#x27;</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">&#x27;severity&#x27;</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">&#x27;replace&#x27;</span></span><br></pre></td></tr></table></figure>

<p>上述示例中，对于 <code>alertname</code> 标签值为 <code>HighCPUUsage</code> 的警报，会添加一个 <code>severity</code> 标签，值为 <code>critical</code>。</p>
<h5 id="alertmanagers"><a href="#alertmanagers" class="headerlink" title="alertmanagers"></a>alertmanagers</h5><ul>
<li><strong>作用</strong>：用于指定 Alertmanager 的地址等信息，Prometheus 通过该配置将警报发送到 Alertmanager 进行后续的处理，如通知发送、警报分组等。</li>
<li>配置参数：<ul>
<li><code>static_configs</code>：包含静态配置的列表，用于指定 Alertmanager 的地址。</li>
<li><code>name</code>：Alertmanager 实例的名称，可选。</li>
</ul>
</li>
<li><strong>配置示例</strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;alertmanager.example.com:9093&#x27;</span></span><br></pre></td></tr></table></figure>

<p>上述示例中，指定了一个 Alertmanager 实例的地址为 <code>alertmanager.example.com:9093</code>，Prometheus 会将警报发送到这个地址。</p>
<h5 id="配置多个alertmanagers"><a href="#配置多个alertmanagers" class="headerlink" title="配置多个alertmanagers"></a>配置多个alertmanagers</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="comment"># 多个 alert_relabel_configs 规则</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    <span class="comment"># 规则 1：对于 alertname 为 HighCPUUsage 的告警，添加 severity 标签，值为 critical</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">      <span class="attr">regex:</span> <span class="string">&#x27;HighCPUUsage&#x27;</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">&#x27;severity&#x27;</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">&#x27;replace&#x27;</span></span><br><span class="line">    <span class="comment"># 规则 2：对于 instance 标签值以 prod 开头的告警，添加 environment 标签，值为 production</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line">      <span class="attr">regex:</span> <span class="string">&#x27;prod.*&#x27;</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">&#x27;environment&#x27;</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">&#x27;production&#x27;</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">&#x27;replace&#x27;</span></span><br><span class="line">    <span class="comment"># 规则 3：丢弃所有 service 标签值为 test-service 的告警</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">&#x27;service&#x27;</span>]</span><br><span class="line">      <span class="attr">regex:</span> <span class="string">&#x27;test-service&#x27;</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">&#x27;drop&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 多个 Alertmanager 实例</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;alertmanager1.example.com:9093&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;alertmanager2.example.com:9093&#x27;</span>    </span><br></pre></td></tr></table></figure>

<h4 id="storage"><a href="#storage" class="headerlink" title="storage"></a>storage</h4><h5 id="tsdb-配置"><a href="#tsdb-配置" class="headerlink" title="tsdb 配置"></a>tsdb 配置</h5><ul>
<li><strong>含义</strong>：<code>tsdb</code> 是 Prometheus 用于存储时间序列数据的组件。这部分配置主要用于调整时间序列数据库的行为和性能，包括数据的存储路径、保留时间、块大小等参数。通过合理配置 <code>tsdb</code>，可以优化 Prometheus 对时间序列数据的存储和查询效率，确保系统能够稳定地处理大量的监控数据。</li>
<li><strong>示例配置</strong>：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">tsdb:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/prometheus/tsdb</span>  <span class="comment"># 数据存储路径</span></span><br><span class="line">    <span class="attr">retention.time:</span> <span class="string">15d</span>  <span class="comment"># 数据保留时间为15天</span></span><br><span class="line">    <span class="attr">block.resolution:</span> <span class="string">5m</span>  <span class="comment"># 数据块的分辨率为5分钟</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>配置解释</strong>：上述配置中，<code>path</code> 指定了 TSDB 数据文件的存储位置；<code>retention.time</code> 设置了数据保留的时长，超过这个时间的数据将被自动删除；<code>block.resolution</code> 定义了数据块的时间分辨率，即每个数据块包含的数据点的时间间隔。</li>
</ul>
<h5 id="exemplars-配置"><a href="#exemplars-配置" class="headerlink" title="exemplars 配置"></a>exemplars 配置</h5><ul>
<li><strong>含义</strong>：Exemplars 是与特定时间序列数据点相关联的示例数据，它可以为时间序列数据提供更详细的上下文信息，例如，在分布式系统中，exemplars 可以包含与某个指标数据点相关的请求 ID、跟踪 ID 等信息，帮助用户快速定位问题。<code>exemplars</code> 配置用于控制 Prometheus 如何处理和存储这些示例数据。</li>
<li><strong>示例配置</strong>：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">exemplars:</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">      <span class="attr">local:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/data/prometheus/exemplars</span>  <span class="comment"># 示例数据存储路径</span></span><br><span class="line">    <span class="attr">retention.time:</span> <span class="string">7d</span>  <span class="comment"># 示例数据保留时间为7天</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>配置解释</strong>：这里配置了示例数据的存储类型为本地存储（<code>local</code>），并指定了存储路径为 <code>/data/prometheus/exemplars</code>。同时，设置了示例数据的保留时间为 7 天，即超过 7 天的示例数据将被删除。</li>
</ul>
<p>通过对 <code>tsdb</code> 和 <code>exemplars</code> 的合理配置，可以让 Prometheus 更好地存储和管理时间序列数据以及相关的示例数据，为监控和故障排查提供有力支持。</p>
<h3 id="scrape-config"><a href="#scrape-config" class="headerlink" title="scrape_config"></a>scrape_config</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job_name:</span> <span class="string">&lt;job_name&gt;</span></span><br><span class="line">[ <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_interval&gt;</span> ]</span><br><span class="line">[ <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_timeout&gt;</span> ]</span><br><span class="line">[ <span class="attr">scrape_protocols:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_protocols&gt;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当抓取返回空白、无法解析或无效的 Content-Type 时使用的回退协议</span></span><br><span class="line"><span class="comment"># Supported values (case sensitive): PrometheusProto, OpenMetricsText0.0.1,</span></span><br><span class="line"><span class="comment"># OpenMetricsText1.0.0, PrometheusText0.0.4, PrometheusText1.0.0.</span></span><br><span class="line">[ <span class="attr">fallback_scrape_protocol:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否始终抓取经典直方图，即便它也以原生直方图形式暴露（需开启 --enable-feature=native-histograms 特性才有效）。</span></span><br><span class="line">[ <span class="attr">always_scrape_classic_histograms:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从目标获取指标的 HTTP 资源路径，默认是 /metrics。</span></span><br><span class="line">[ <span class="attr">metrics_path:</span> <span class="string">&lt;path&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">/metrics</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#控制 Prometheus 如何处理抓取数据中已存在的标签与服务器端要附加的标签（如 job 和 instance 标签等）之间的冲突。设为 true 时，保留抓取数据中的标签值，忽略冲突的服务器端标签；设为 false 时，将抓取数据中冲突的标签重命名为 exported_&lt;original-label&gt; 后再附加服务器端标签。</span></span><br><span class="line">[ <span class="attr">honor_labels:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制 Prometheus 是否尊重抓取数据中存在的时间戳。设为 true 时，使用目标暴露的指标时间戳；设为 false 时，忽略目标暴露的指标时间戳。</span></span><br><span class="line">[ <span class="attr">honor_timestamps:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">true</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制 Prometheus 是否跟踪抓取数据中具有显式时间戳的指标的陈旧性。设为 true 时，当指标不再存在或目标停机时，会在 TSDB 中插入陈旧标记。</span></span><br><span class="line">[ <span class="attr">track_timestamps_staleness:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于请求的协议方案，默认是 http。</span></span><br><span class="line">[ <span class="attr">scheme:</span> <span class="string">&lt;scheme&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">http</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选的 HTTP URL 参数。</span></span><br><span class="line"><span class="attr">params:</span></span><br><span class="line">  [ <span class="string">&lt;string&gt;:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># If enable_compression is set to &quot;false&quot;, Prometheus will request uncompressed</span></span><br><span class="line"><span class="comment"># response from the scraped target.</span></span><br><span class="line">[ <span class="attr">enable_compression:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">true</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># File to which scrape failures are logged.</span></span><br><span class="line"><span class="comment"># Reloading the configuration will reopen the file.</span></span><br><span class="line">[ <span class="attr">scrape_failure_log_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP client settings, including authentication methods (such as basic auth and</span></span><br><span class="line"><span class="comment"># authorization), proxy configurations, TLS options, custom HTTP headers, etc.</span></span><br><span class="line">[ <span class="string">&lt;http_config&gt;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Azure service discovery configurations.</span></span><br><span class="line"><span class="attr">azure_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;azure_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Consul service discovery configurations.</span></span><br><span class="line"><span class="attr">consul_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;consul_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of DigitalOcean service discovery configurations.</span></span><br><span class="line"><span class="attr">digitalocean_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;digitalocean_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Docker service discovery configurations.</span></span><br><span class="line"><span class="attr">docker_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;docker_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Docker Swarm service discovery configurations.</span></span><br><span class="line"><span class="attr">dockerswarm_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;dockerswarm_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of DNS service discovery configurations.</span></span><br><span class="line"><span class="attr">dns_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;dns_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of EC2 service discovery configurations.</span></span><br><span class="line"><span class="attr">ec2_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;ec2_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Eureka service discovery configurations.</span></span><br><span class="line"><span class="attr">eureka_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;eureka_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of file service discovery configurations.</span></span><br><span class="line"><span class="attr">file_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;file_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of GCE service discovery configurations.</span></span><br><span class="line"><span class="attr">gce_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;gce_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Hetzner service discovery configurations.</span></span><br><span class="line"><span class="attr">hetzner_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;hetzner_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of HTTP service discovery configurations.</span></span><br><span class="line"><span class="attr">http_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;http_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of IONOS service discovery configurations.</span></span><br><span class="line"><span class="attr">ionos_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;ionos_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Kubernetes service discovery configurations.</span></span><br><span class="line"><span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;kubernetes_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Kuma service discovery configurations.</span></span><br><span class="line"><span class="attr">kuma_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;kuma_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Lightsail service discovery configurations.</span></span><br><span class="line"><span class="attr">lightsail_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;lightsail_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Linode service discovery configurations.</span></span><br><span class="line"><span class="attr">linode_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;linode_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Marathon service discovery configurations.</span></span><br><span class="line"><span class="attr">marathon_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;marathon_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of AirBnB&#x27;s Nerve service discovery configurations.</span></span><br><span class="line"><span class="attr">nerve_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;nerve_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Nomad service discovery configurations.</span></span><br><span class="line"><span class="attr">nomad_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;nomad_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of OpenStack service discovery configurations.</span></span><br><span class="line"><span class="attr">openstack_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;openstack_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of OVHcloud service discovery configurations.</span></span><br><span class="line"><span class="attr">ovhcloud_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;ovhcloud_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of PuppetDB service discovery configurations.</span></span><br><span class="line"><span class="attr">puppetdb_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;puppetdb_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Scaleway service discovery configurations.</span></span><br><span class="line"><span class="attr">scaleway_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;scaleway_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Zookeeper Serverset service discovery configurations.</span></span><br><span class="line"><span class="attr">serverset_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;serverset_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Triton service discovery configurations.</span></span><br><span class="line"><span class="attr">triton_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;triton_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Uyuni service discovery configurations.</span></span><br><span class="line"><span class="attr">uyuni_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;uyuni_sd_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of labeled statically configured targets for this job.</span></span><br><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;static_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of target relabel configurations.</span></span><br><span class="line"><span class="attr">relabel_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># List of metric relabel configurations.</span></span><br><span class="line"><span class="attr">metric_relabel_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># An uncompressed response body larger than this many bytes will cause the</span></span><br><span class="line"><span class="comment"># scrape to fail. 0 means no limit. Example: 100MB.</span></span><br><span class="line"><span class="comment"># This is an experimental feature, this behaviour could</span></span><br><span class="line"><span class="comment"># change or be removed in the future.</span></span><br><span class="line">[ <span class="attr">body_size_limit:</span> <span class="string">&lt;size&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Per-scrape limit on the number of scraped samples that will be accepted.</span></span><br><span class="line"><span class="comment"># If more than this number of samples are present after metric relabeling</span></span><br><span class="line"><span class="comment"># the entire scrape will be treated as failed. 0 means no limit.</span></span><br><span class="line">[ <span class="attr">sample_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Limit on the number of labels that will be accepted per sample. If more</span></span><br><span class="line"><span class="comment"># than this number of labels are present on any sample post metric-relabeling,</span></span><br><span class="line"><span class="comment"># the entire scrape will be treated as failed. 0 means no limit.</span></span><br><span class="line">[ <span class="attr">label_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Limit on the length (in bytes) of each individual label name. If any label</span></span><br><span class="line"><span class="comment"># name in a scrape is longer than this number post metric-relabeling, the</span></span><br><span class="line"><span class="comment"># entire scrape will be treated as failed. Note that label names are UTF-8</span></span><br><span class="line"><span class="comment"># encoded, and characters can take up to 4 bytes. 0 means no limit.</span></span><br><span class="line">[ <span class="attr">label_name_length_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Limit on the length (in bytes) of each individual label value. If any label</span></span><br><span class="line"><span class="comment"># value in a scrape is longer than this number post metric-relabeling, the</span></span><br><span class="line"><span class="comment"># entire scrape will be treated as failed. Note that label values are UTF-8</span></span><br><span class="line"><span class="comment"># encoded, and characters can take up to 4 bytes. 0 means no limit.</span></span><br><span class="line">[ <span class="attr">label_value_length_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Limit per scrape config on number of unique targets that will be</span></span><br><span class="line"><span class="comment"># accepted. If more than this number of targets are present after target</span></span><br><span class="line"><span class="comment"># relabeling, Prometheus will mark the targets as failed without scraping them.</span></span><br><span class="line"><span class="comment"># 0 means no limit. This is an experimental feature, this behaviour could</span></span><br><span class="line"><span class="comment"># change in the future.</span></span><br><span class="line">[ <span class="attr">target_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Limit per scrape config on the number of targets dropped by relabeling</span></span><br><span class="line"><span class="comment"># that will be kept in memory. 0 means no limit.</span></span><br><span class="line">[ <span class="attr">keep_dropped_targets:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specifies the validation scheme for metric and label names. Either blank or </span></span><br><span class="line"><span class="comment"># &quot;utf8&quot; for full UTF-8 support, or &quot;legacy&quot; for letters, numbers, colons, and</span></span><br><span class="line"><span class="comment"># underscores.</span></span><br><span class="line">[ <span class="string">metric_name_validation_scheme</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;utf8&quot;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Limit on total number of positive and negative buckets allowed in a single</span></span><br><span class="line"><span class="comment"># native histogram. The resolution of a histogram with more buckets will be</span></span><br><span class="line"><span class="comment"># reduced until the number of buckets is within the limit. If the limit cannot</span></span><br><span class="line"><span class="comment"># be reached, the scrape will fail.</span></span><br><span class="line"><span class="comment"># 0 means no limit.</span></span><br><span class="line">[ <span class="attr">native_histogram_bucket_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Lower limit for the growth factor of one bucket to the next in each native</span></span><br><span class="line"><span class="comment"># histogram. The resolution of a histogram with a lower growth factor will be</span></span><br><span class="line"><span class="comment"># reduced as much as possible until it is within the limit.</span></span><br><span class="line"><span class="comment"># To set an upper limit for the schema (equivalent to &quot;scale&quot; in OTel&#x27;s</span></span><br><span class="line"><span class="comment"># exponential histograms), use the following factor limits:</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |        growth factor       | resulting schema AKA scale |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |          65536             |             -4             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |            256             |             -3             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |             16             |             -2             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              4             |             -1             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              2             |              0             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.4           |              1             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.1           |              2             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.09          |              3             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.04          |              4             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.02          |              5             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.01          |              6             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.005         |              7             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># |              1.002         |              8             |</span></span><br><span class="line"><span class="comment"># +----------------------------+----------------------------+</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 0 results in the smallest supported factor (which is currently ~1.0027 or</span></span><br><span class="line"><span class="comment"># schema 8, but might change in the future).</span></span><br><span class="line">[ <span class="attr">native_histogram_min_bucket_factor:</span> <span class="string">&lt;float&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> ]</span><br></pre></td></tr></table></figure>

<h5 id="params"><a href="#params" class="headerlink" title="params"></a>params</h5><p>可选的 HTTP URL 参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">params:</span><br><span class="line">  param1: [&quot;value1&quot;, &quot;value2&quot;]</span><br></pre></td></tr></table></figure>

<p>假设你有一个 HTTP API，用于获取城市的天气信息。该 API 接受一些参数来指定查询的条件，例如城市名称、日期等。你可以使用 <code>params</code> 来设置这些参数，以便向 API 发送正确的请求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">api:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">&quot;https://api.example.com/weather&quot;</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">city:</span> [<span class="string">&quot;Beijing&quot;</span>, <span class="string">&quot;Shanghai&quot;</span>]</span><br><span class="line">    <span class="attr">date:</span> [<span class="string">&quot;2025-03-26&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>在这个例子中，<code>params</code> 定义了两个参数：<code>city</code> 和 <code>date</code>。<code>city</code> 参数的值为 <code>[&quot;Beijing&quot;, &quot;Shanghai&quot;]</code>，表示要查询北京和上海两个城市的天气信息。<code>date</code> 参数的值为 <code>[&quot;2025-03-26&quot;]</code>，表示要查询 2025 年 3 月 26 日的天气信息。</p>
<p>当应用程序根据这个配置向 <code>https://api.example.com/weather</code> 发送请求时，它会将参数附加到 URL 中，形成类似 <code>https://api.example.com/weather?city=Beijing&amp;city=Shanghai&amp;date=2025-03-26</code> 的请求 URL。这样，API 服务器就可以根据这些参数来返回相应的天气数据。</p>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="函数-1"><a href="#函数-1" class="headerlink" title="函数"></a>函数</h3><ol>
<li>数学运算函数：<ul>
<li>绝对值函数<code>abs()</code>：将输入向量的样本值转换为绝对值。</li>
<li>向上取整函数<code>ceil()</code>：将样本值向上舍入到最接近的整数。</li>
<li>向下取整函数<code>floor()</code>：将样本值向下舍入到最接近的整数。</li>
<li>指数函数<code>exp()</code>：计算样本值的指数。</li>
<li>自然对数函数<code>ln()</code>、二进制对数函数<code>log2()</code>、十进制对数函数<code>log10()</code>：分别计算相应的对数。</li>
<li>平方根函数<code>sqrt()</code>：计算样本值的平方根。</li>
<li>符号函数<code>sgn()</code>：返回样本值的符号（1、-1 或 0）。</li>
<li>三角函数（<code>acos()</code>、<code>asin()</code>、<code>atan()</code>等）和双曲函数（<code>acosh()</code>、<code>asinh()</code>、<code>atanh()</code>等）：进行相应的三角和双曲运算，以弧度为单位，还有<code>deg()</code>和<code>rad()</code>用于度数和弧度的转换。</li>
</ul>
</li>
<li>时间相关函数：<ul>
<li>获取当前时间的秒数<code>time()</code>。</li>
<li>获取向量样本的时间戳<code>timestamp()</code>。</li>
<li>返回一年中的某天<code>day_of_year()</code>、一月中的某天<code>day_of_month()</code>、一周中的某天<code>day_of_week()</code>、一天中的小时<code>hour()</code>、一小时中的分钟<code>minute()</code>、一年中的月份<code>month()</code>、年份<code>year()</code>。</li>
<li>计算一个月的天数<code>days_in_month()</code>。</li>
</ul>
</li>
<li>指标计算函数：<ul>
<li>计算计数器的增加量<code>increase()</code>、瞬时增加率<code>irate()</code>、平均增加率<code>rate()</code>，<code>increase()</code>和<code>rate()</code>可处理计数器重置，<code>irate()</code>基于最后两个数据点计算瞬时速率。</li>
<li>计算仪表的导数<code>deriv()</code>、预测值<code>predict_linear()</code>，需注意<code>deriv()</code>和<code>predict_linear()</code>只能与仪表一起使用。</li>
<li>计算直方图相关指标的函数，如<code>histogram_avg()</code>、<code>histogram_count()</code>、<code>histogram_sum()</code>、<code>histogram_fraction()</code>、<code>histogram_quantile()</code>、<code>histogram_stddev()</code>、<code>histogram_stdvar()</code>，这些函数仅作用于原生直方图，是实验性特征。</li>
<li>计算样本值变化次数<code>changes()</code>、计数器重置次数<code>resets()</code>。</li>
</ul>
</li>
<li>数据处理函数：<ul>
<li>处理标签冲突的<code>honor_labels</code>配置项，控制 Prometheus 对抓取数据和服务器端标签冲突的处理方式。</li>
<li>标签操作函数<code>label_join()</code>用于连接标签值，<code>label_replace()</code>用于替换标签值。</li>
<li>数据平滑函数<code>double_exponential_smoothing()</code>，需启用实验性功能标志，用于对时间序列进行平滑处理，只能与仪表一起使用。</li>
</ul>
</li>
<li>特殊函数：<ul>
<li><code>absent()</code>和<code>absent_over_time()</code>用于检查指标是否存在，在指标不存在时返回特定结果，可用于发出警报。</li>
<li><code>info()</code>是实验性函数，用于简化从 info 指标添加标签的操作，需启用实验性功能标志。</li>
<li><code>scalar()</code>将单元素向量转换为标量值，若向量元素不为 1 则返回<code>NaN</code>。</li>
</ul>
</li>
<li>聚合函数：<ul>
<li>包括<code>avg_over_time()</code>、<code>min_over_time()</code>、<code>max_over_time()</code>、<code>sum_over_time()</code>、<code>count_over_time()</code>、<code>quantile_over_time()</code>、<code>stddev_over_time()</code>、<code>stdvar_over_time()</code>、<code>last_over_time()</code>、<code>present_over_time()</code>、<code>mad_over_time()</code>（需启用实验性功能标志）等，用于对范围向量进行聚合操作，部分函数可处理原生直方图，部分函数会忽略直方图样本。</li>
</ul>
</li>
<li>排序函数：<ul>
<li><code>sort()</code>按样本值升序排序，<code>sort_desc()</code>按样本值降序排序，<code>sort_by_label()</code>按指定标签值升序排序，<code>sort_by_label_desc()</code>按指定标签值降序排序，这些函数仅影响即时查询结果。</li>
</ul>
</li>
<li>其他函数：<ul>
<li><code>idelta()</code>计算范围向量中最后两个样本的差值，只能与仪表一起使用。</li>
<li><code>round()</code>将样本值四舍五入到最接近的整数，可指定舍入的倍数。</li>
<li><code>vector()</code>将标量转换为无标签的向量。</li>
</ul>
</li>
</ol>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p>Prometheus 自带一个本地磁盘时间序列数据库，它以自定义的高效格式在本地存储数据。不过，它也支持与远程存储系统集成，用户可根据实际需求选择。</p>
<h3 id="磁盘布局"><a href="#磁盘布局" class="headerlink" title="磁盘布局"></a>磁盘布局</h3><p><strong>1.数据块划分</strong></p>
<p>摄入的样本会被分组存为 <strong>2 小时的块</strong>。每个 2 小时块对应的目录包含以下内容：</p>
<ul>
<li><strong>chunks 子目录</strong>：存放该时间窗口内所有时间序列的样本。样本默认被分组到<strong>一个或多个区段</strong>文件中，每个区段文件最大为 512MB。</li>
<li><strong>元数据文件（meta.json）</strong>：记录<strong>该数据块</strong>的相关元数据信息。</li>
<li><strong>索引文件（index）</strong>：为度量名称和标签编制索引，方便快速定位 chunks 目录中的时间序列。</li>
</ul>
<p><strong>2. 删除记录处理</strong></p>
<p>当有时间序列的删除记录时，不会立即从 chunk 段中删除数据，而是将删除记录存储在单独的 tombstone 文件中</p>
<p><strong>3. 预写日志（WAL）</strong></p>
<ul>
<li>正在处理传入样本的当前块会保存在内存中，还未完全持久化。为防止崩溃导致数据丢失，使用预写日志（WAL）进行保护，在 Prometheus 服务器重启时可重放 WAL 中的数据。</li>
<li>WAL 文件以 <strong>128MB</strong> 为单位分段存储在 <code>wal</code> 目录下。这些文件包含尚未压缩的原始数据，所以比常规块文件大很多。</li>
<li>Prometheus 至少会保留三个预写日志文件。对于高流量服务器，可能会保留三个以上的 WAL 文件，以确保至少有 2 小时的原始数据。</li>
</ul>
<h3 id="数据目录示例"><a href="#数据目录示例" class="headerlink" title="数据目录示例"></a>数据目录示例</h3><p>以下是 Prometheus 服务器数据目录的示例结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">./data</span><br><span class="line">├── 01BKGV7JBM69T2G1BGBGM6KB12</span><br><span class="line">│   └── meta.json</span><br><span class="line">├── 01BKGTZQ1SYQJTR4PB43C8PD98</span><br><span class="line">│   ├── chunks</span><br><span class="line">│   │   └── 000001</span><br><span class="line">│   ├── tombstones</span><br><span class="line">│   ├── index</span><br><span class="line">│   └── meta.json</span><br><span class="line">├── 01BKGTZQ1HHWHV8FBJXW1Y3W0K</span><br><span class="line">│   └── meta.json</span><br><span class="line">├── 01BKGV7JC0RY8A6MACW02A2PJD</span><br><span class="line">│   ├── chunks</span><br><span class="line">│   │   └── 000001</span><br><span class="line">│   ├── tombstones</span><br><span class="line">│   ├── index</span><br><span class="line">│   └── meta.json</span><br><span class="line">├── chunks_head</span><br><span class="line">│   └── 000001</span><br><span class="line">└── wal</span><br><span class="line">    ├── 000000002</span><br><span class="line">    └── checkpoint.00000001</span><br><span class="line">        └── 00000000</span><br></pre></td></tr></table></figure>

<ul>
<li>以一串随机字符命名的目录代表不同的 2 小时数据块。</li>
<li><code>chunks_head</code> 目录存放当前正在处理的块的样本数据。</li>
<li><code>wal</code> 目录存放预写日志文件和检查点文件。</li>
</ul>
<h3 id="部分块只有-meta-json-文件而无其他文件的原因"><a href="#部分块只有-meta-json-文件而无其他文件的原因" class="headerlink" title="部分块只有 meta.json 文件而无其他文件的原因"></a>部分块只有 <code>meta.json</code> 文件而无其他文件的原因</h3><p>1.<strong>数据为空或未采集到数据</strong></p>
<p>若在某个 2 小时的时间窗口内，没有任何样本数据被采集或者存储到该数据块，那么这个数据块可能就只有 <code>meta.json</code> 文件。<code>meta.json</code> 作为元数据文件，它记录了该数据块的基本信息，即便没有实际的样本数据，这个元数据文件依然会存在。</p>
<p>2.<strong>数据被清理或迁移</strong></p>
<p>有可能在之前这个数据块是有数据的，不过经过了数据清理或者迁移操作后，相关的 <code>chunks</code> 目录、<code>index</code> 文件等都被移除了，只保留了 <code>meta.json</code> 文件用于记录该数据块曾经的元数据信息。</p>
<p>3.<strong>数据正在初始化</strong></p>
<p>在数据块刚刚创建的时候，可能还处于初始化阶段，只有 <code>meta.json</code> 文件被创建，后续随着样本数据的不断采集和处理，才会逐步生成 <code>chunks</code> 目录、<code>index</code> 文件等。</p>
<h3 id="数据压实"><a href="#数据压实" class="headerlink" title="数据压实"></a>数据压实</h3><p>Prometheus 最初存储的是 2 小时的数据块，之后会在后台将这些小数据块压缩成更大的数据块。压实创建的新数据块，其涵盖的数据时间跨度最大为保留时间的 10% 或者 31 天，取两者中的较小值。</p>
<h3 id="本地存储配置"><a href="#本地存储配置" class="headerlink" title="本地存储配置"></a>本地存储配置</h3><p>Prometheus 提供了一些配置本地存储的重要标志：</p>
<ul>
<li><code>--storage.tsdb.path</code>：指定 Prometheus 数据库的<strong>写入位置</strong>，默认是 <code>data/</code>。</li>
<li><code>--storage.tsdb.retention.time</code>：设置<strong>样本的存储时长</strong>，若未设置该标志和 <code>--storage.tsdb.retention.size</code>，默认保留时间为 15 天。支持的时间单位有 <code>y</code>（年）、<code>w</code>（周）、<code>d</code>（天）、<code>h</code>（小时）等。</li>
<li><code>--storage.tsdb.retention.size</code>：规定要保留的<strong>存储块的最大字节数</strong>，会优先删除最早的数据。默认是禁用状态，支持的字节单位有 <code>B</code>、<code>KB</code>、<code>MB</code> 等。</li>
<li><code>--storage.tsdb.wal-compression</code>：开启预写日志（WAL）的压缩功能，可使 WAL 大小减半，且几乎不增加额外的 CPU 负载。该标志在 2.11.0 版本引入，2.20.0 版本默认启用。若启用后将 Prometheus 降级到低于 2.11.0 的版本，需要删除 WAL。</li>
</ul>
<h3 id="容量规划与数据损坏处理"><a href="#容量规划与数据损坏处理" class="headerlink" title="容量规划与数据损坏处理"></a>容量规划与数据损坏处理</h3><ul>
<li><strong>容量规划</strong>：Prometheus 平均每个样本仅需 1 - 2 字节的存储空间。可以使用公式 <code>needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample</code> 来粗略估算所需的磁盘空间。若要降低样本摄取速率，可减少抓取的时间序列或增加抓取间隔，减少序列数量可能更有效。</li>
<li><strong>数据损坏处理</strong>：若本地存储损坏导致 Prometheus 无法启动，建议备份存储目录并从备份中恢复损坏的块目录。若没有备份，可删除损坏的文件，但这会导致相应时间范围内的数据丢失。同时，Prometheus 不支持不符合 POSIX 的文件系统用于本地存储，如 NFS（包括 AWS 的 EFS），建议使用本地文件系统以保证可靠性。</li>
</ul>
<h3 id="保留策略"><a href="#保留策略" class="headerlink" title="保留策略"></a>保留策略</h3><p>若同时设置了时间和大小保留策略，会优先采用先触发的策略。过期块的清理在后台进行，最多可能需要两小时来删除过期块，且区块必须完全过期才会被删除。建议将保留大小设置为分配给 Prometheus 磁盘空间的 80 - 85%，以确保在磁盘满之前删除较早的数据。</p>
<h3 id="远程存储集成"><a href="#远程存储集成" class="headerlink" title="远程存储集成"></a>远程存储集成</h3><p>Prometheus 本地存储在可扩展性和持久性方面存在局限，因此提供了与远程存储系统集成的接口，集成方式有四种：</p>
<ul>
<li>Prometheus 可将提取的样本以 Remote Write 格式写入远程 URL。</li>
<li>可接收来自其他客户端的 Remote Write 格式的样本。</li>
<li>能以 Remote Read 格式从远程 URL 读取样本数据。</li>
<li>可以 Remote Read 格式返回客户端请求的样本数据。</li>
</ul>
<p>远程读写协议采用 snappy 压缩的协议缓冲区编码的 HTTP 请求，读取协议尚未稳定。写入协议有 1.0 稳定版本和 2.0 实验版本，Prometheus 服务器均支持。Prometheus 提供了远程写入接收器和远程读取端点，分别为 <code>/api/v1/write</code> 和 <code>/api/v1/read</code>。不过，远程读取查询存在可扩展性限制，因为所有必要的数据都需先加载到 Prometheus 服务器进行处理。</p>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>文件服务发现和 HTTP 服务发现是 Prometheus 中用于发现监控目标的两种不同机制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;node_exporter&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&#x27;10.0.1.10:9100&#x27;, &#x27;10.0.1.11:9100&#x27;]</span><br></pre></td></tr></table></figure>



<h3 id="文件服务发现（File-Based-SD）"><a href="#文件服务发现（File-Based-SD）" class="headerlink" title="文件服务发现（File - Based SD）"></a>文件服务发现（File - Based SD）</h3><ul>
<li><strong>原理</strong>：文件发现是一种相对简单直接的服务发现方式。通过在本地指定一个或多个配置文件，文件内以特定格式定义监控目标的相关信息，Prometheus 会定期读取这些文件，根据文件内容发现监控目标。</li>
<li><strong>配置示例</strong>：创建一个名为 <code>targets.yml</code> 的文件，内容如下：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;192.168.1.100:8080&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;192.168.1.101:8080&#x27;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">  	<span class="attr">instance:</span> <span class="string">&#x27;test 服务器 &#x27;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&#x27;mysqld_exporter&#x27;</span></span><br></pre></td></tr></table></figure>

<p>上述配置中，定义了两个监控目标的 IP 地址和端口，同时为它们添加了 <code>group: &#39;web - servers&#39;</code> 的标签。在 Prometheus 的配置文件 <code>prometheus.yml</code> 中，添加如下配置启用文件发现：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;file - discovered - targets&#x27;</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;targets.yml&#x27;</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">5m</span></span><br></pre></td></tr></table></figure>

<p>这表示 Prometheus 会每隔 5 分钟读取 <code>targets.yml</code> 文件，根据文件内容更新监控目标。</p>
<ul>
<li><strong>应用场景</strong>：适用于小型、相对静态的环境，比如传统数据中心内服务器变动不频繁的场景，或者在测试环境中方便快速配置少量监控目标。</li>
</ul>
<h3 id="Kubernetes-发现"><a href="#Kubernetes-发现" class="headerlink" title="Kubernetes 发现"></a>Kubernetes 发现</h3><ul>
<li><strong>原理</strong>：在 Kubernetes 集群环境中，Prometheus 利用 Kubernetes API 来实现服务发现。它通过监听 Kubernetes 资源对象（如 Pod、Service、Endpoint 等）的创建、删除、更新等事件，自动发现符合条件的监控目标。例如，当创建一个新的 Pod 且该 Pod 带有特定的用于监控的注解（Annotation）时，Prometheus 能立刻感知并将其纳入监控范围。</li>
<li><strong>配置示例</strong>：在 Prometheus 的配置文件 <code>prometheus.yml</code> 中进行如下配置：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes - pods&#x27;</span></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">api_server:</span> <span class="string">https://kubernetes</span> <span class="bullet">-</span> <span class="string">master:6443</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/path/to/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/path/to/token</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scheme</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br></pre></td></tr></table></figure>

<p>上述配置中，指定了从 Kubernetes API 服务器获取 Pod 资源信息，通过 <code>relabel_configs</code> 对获取到的 Pod 信息进行筛选和转换，仅监控带有特定注解且符合条件的 Pod 。</p>
<ul>
<li><strong>应用场景</strong>：在以 Kubernetes 为基础的容器编排环境中广泛应用，像互联网公司大规模的微服务架构部署在 Kubernetes 集群中，可借助此机制实现对大量动态变化的容器化应用的自动监控 。</li>
</ul>
<h3 id="HTTP-服务发现（HTTP-SD）"><a href="#HTTP-服务发现（HTTP-SD）" class="headerlink" title="HTTP 服务发现（HTTP SD）"></a>HTTP 服务发现（HTTP SD）</h3><ul>
<li><strong>基本原理</strong>：Prometheus 定期通过 HTTP 或 HTTPS 协议向指定的端点发送请求，获取监控目标的信息。</li>
<li><strong>更新频率</strong>：按照设置的<code>refresh_interval</code>（默认 1 分钟）进行更新。每隔这个时间间隔，Prometheus 就会向 HTTP SD 端点发送 GET 请求，获取最新的监控目标列表。</li>
<li><strong>数据格式</strong>：要求返回的内容为 JSON 格式。例如：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.0.10.2:9100&quot;</span><span class="punctuation">,</span> <span class="string">&quot;10.0.10.3:9100&quot;</span><span class="punctuation">,</span> <span class="string">&quot;10.0.10.4:9100&quot;</span><span class="punctuation">,</span> <span class="string">&quot;10.0.10.5:9100&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__meta_datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;london&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;__meta_prometheus_job&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.0.40.2:9100&quot;</span><span class="punctuation">,</span> <span class="string">&quot;10.0.40.3:9100&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__meta_datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;london&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;__meta_prometheus_job&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alertmanager&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.0.40.2:9093&quot;</span><span class="punctuation">,</span> <span class="string">&quot;10.0.40.3:9093&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__meta_datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;newyork&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;__meta_prometheus_job&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alertmanager&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>传输方式</strong>：通过 HTTP 或 HTTPS 协议进行数据传输。Prometheus 向配置好的 HTTP SD 端点发送请求，获取监控目标信息。</li>
<li><strong>安全性</strong>：支持多种安全认证方式，包括 TLS 认证、基本认证（Basic auth）、授权头（Authorization header）以及 OAuth2 等，以确保只有授权的客户端才能访问 HTTP SD 端点并获取监控目标信息。</li>
</ul>
<h3 id="consul发现"><a href="#consul发现" class="headerlink" title="consul发现"></a>consul发现</h3><p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name consul -p 8500:8500 consul:1.14.5</span><br></pre></td></tr></table></figure>

<p>注册consul</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -d &#x27;&#123;&quot;id&quot;: &quot;node1&quot;,&quot; name&quot;: &quot;node_exporter&quot;, &quot;address&quot;: &quot;node_exporter&quot;, &quot;port&quot;: 9100,&quot;tags&quot;: [&quot;exporter&quot;],&quot;meta&quot;: &#123;&quot;job&quot;:&quot;node_exporter&quot;,&quot;instance&quot;:&quot;Prometheus服务器&quot;&#125;，“check”: [&#123;&quot;http&quot;: &quot;http://192.168.8.130:9100/metrics&quot;, &quot;interval&quot;: 5s&#125;]&#125;&#x27; http://localhost:8500/v1/agent/service/register</span><br></pre></td></tr></table></figure>

<p>prometheus.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">job_name:&#x27;my_service&#x27;</span></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&#x27;localhost:8500&#x27;</span>  <span class="comment"># Consul 服务器地址和端口</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_consul_service_name</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__name__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_consul_service_address</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_consul_service_port</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_port</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__param_port</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;$1:$2&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="relabeling"><a href="#relabeling" class="headerlink" title="relabeling"></a>relabeling</h2><p>在 Prometheus 里，重新标记（relabeling）机制是一项极为关键的特性，它能让你在数据抓取与处理期间对标签进行修改、添加或删除操作，从而实现灵活的监控配置。下面从使用场景、工作流程、常用的重新标记配置以及示例几个方面进行介绍。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li><strong>数据清理</strong>：当从目标服务获取的标签包含不必要的信息时，可借助重新标记机制将其去除。</li>
<li><strong>标签标准化</strong>：不同服务或许会使用不同的标签命名规范，通过重新标记能让所有标签统一命名。</li>
<li><strong>动态目标选择</strong>：依据标签值来决定是否抓取某个目标。</li>
</ul>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p>重新标记机制在 Prometheus 中有两个主要阶段起作用：目标发现和样本采集。</p>
<ul>
<li><strong>目标发现阶段</strong>：在从服务发现机制（如 Consul、Kubernetes 等）获取目标后，Prometheus 会根据重新标记配置对目标的标签进行修改。这可以帮助过滤掉不需要的目标，或者为目标添加额外的标签。</li>
<li><strong>样本采集阶段</strong>：在采集到样本数据后，Prometheus 会再次应用重新标记配置来修改样本的标签。这可以用于修改或添加标签，以便在后续的查询和可视化中更方便地使用。</li>
</ul>
<h3 id="常用的重新标记配置"><a href="#常用的重新标记配置" class="headerlink" title="常用的重新标记配置"></a>常用的重新标记配置</h3><p>重新标记配置通过 <code>relabel_configs</code> 字段来定义，它是一个数组，每个元素是一个重新标记规则。常用的配置参数如下：</p>
<ul>
<li><code>source_labels</code>：指定要用于匹配的源标签列表。</li>
<li><code>separator</code>：指定源标签之间的分隔符，默认为 <code>;</code>。</li>
<li><code>regex</code>：用于匹配源标签值的正则表达式。</li>
<li><code>target_label</code>：指定要修改的目标标签。</li>
<li><code>replacement</code>：用于替换匹配到的标签值的字符串，支持使用正则表达式的捕获组。</li>
<li><code>action</code>：指定重新标记的操作类型，常见的有 <code>replace</code>、<code>keep</code>、<code>drop</code>、<code>labelmap</code> 等。</li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>下面是一个简单的 <code>prometheus.yml</code> 配置文件示例，展示了重新标记机制的使用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;my_service&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:8080&#x27;</span>]</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;(.*):.*&#x27;</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;$1&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">job</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">my_service</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br></pre></td></tr></table></figure>

<p>这个示例中：</p>
<ul>
<li>第一条规则从 <code>__address__</code> 标签中提取主机名，并将其赋值给 <code>instance</code> 标签。</li>
<li>第二条规则只保留 <code>job</code> 标签值为 <code>my_service</code> 的目标。</li>
</ul>
<p>通过这些配置，你可以根据实际需求对 Prometheus 的标签进行灵活的管理和处理。</p>
<h1 id="Prometheus实战"><a href="#Prometheus实战" class="headerlink" title="Prometheus实战"></a>Prometheus实战</h1><h2 id="Linux服务器监控"><a href="#Linux服务器监控" class="headerlink" title="Linux服务器监控"></a>Linux服务器监控</h2><h3 id="1-服务器安装node-exporter"><a href="#1-服务器安装node-exporter" class="headerlink" title="1.服务器安装node_exporter"></a>1.服务器安装node_exporter</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.3&#x27;</span><br><span class="line">services:</span><br><span class="line">  node_exporter:</span><br><span class="line">    image: prom/node-exporter:v1.5.0</span><br><span class="line">    container_name: node-exporter</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">      - /proc:/host/proc:ro</span><br><span class="line">      - /sys:/host/sys:ro</span><br><span class="line">      - /:/rootfs:ro</span><br><span class="line">    command: </span><br><span class="line">      - &#x27;--path.procfs=/host/proc&#x27; </span><br><span class="line">      - &#x27;--path.sysfs=/host/sys&#x27;</span><br><span class="line">      - &#x27;--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc|rootfs/var/lib/docker)($$|/)&#x27;</span><br><span class="line">    ports:</span><br><span class="line">      - &#x27;9100:9100&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>修改服务端prometheus.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static_config:</span><br><span class="line"> -targets:[ip:端口号]</span><br><span class="line"> -labels： test_node</span><br></pre></td></tr></table></figure>

<p>热重启prometheus</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:9090/-/reload</span><br></pre></td></tr></table></figure>

<h3 id="2-常用监控指标"><a href="#2-常用监控指标" class="headerlink" title="2.常用监控指标"></a>2.常用监控指标</h3><table>
<thead>
<tr>
<th>指标分类</th>
<th>指标名称</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>CPU</td>
<td><code>node_cpu_seconds_total</code></td>
<td>CPU 在不同模式（如用户态、内核态等）下花费的总时间，可按 <code>cpu</code> 标签区分不同 CPU 核心，如 <code>node_cpu_seconds_total{cpu=&quot;0&quot;}</code> 表示 CPU 0 的情况</td>
</tr>
<tr>
<td>CPU</td>
<td><code>node_load1</code></td>
<td>系统在过去 1 分钟内的平均负载</td>
</tr>
<tr>
<td>CPU</td>
<td><code>node_load5</code></td>
<td>系统在过去 5 分钟内的平均负载</td>
</tr>
<tr>
<td>CPU</td>
<td><code>node_load15</code></td>
<td>系统在过去 15 分钟内的平均负载</td>
</tr>
<tr>
<td>内存</td>
<td><code>node_memory_MemTotal_bytes</code></td>
<td>系统物理内存的总量（以字节为单位）</td>
</tr>
<tr>
<td>内存</td>
<td><code>node_memory_MemFree_bytes</code></td>
<td>系统当前空闲的物理内存量（以字节为单位）</td>
</tr>
<tr>
<td>内存</td>
<td><code>node_memory_MemAvailable_bytes</code></td>
<td>系统可用于分配给新进程的物理内存量（以字节为单位）</td>
</tr>
<tr>
<td>内存</td>
<td><code>node_memory_Buffers_bytes</code></td>
<td>系统用于缓存磁盘块的内存量（以字节为单位）</td>
</tr>
<tr>
<td>内存</td>
<td><code>node_memory_Cached_bytes</code></td>
<td>系统用于缓存文件内容的内存量（以字节为单位）</td>
</tr>
<tr>
<td>磁盘</td>
<td><code>node_disk_read_bytes_total</code></td>
<td>磁盘累计读取的字节数</td>
</tr>
<tr>
<td>磁盘</td>
<td><code>node_disk_written_bytes_total</code></td>
<td>磁盘累计写入的字节数</td>
</tr>
<tr>
<td>磁盘</td>
<td><code>node_disk_io_time_seconds_total</code></td>
<td>磁盘进行 I&#x2F;O 操作所花费的总时间（以秒为单位）</td>
</tr>
<tr>
<td>网络</td>
<td><code>node_network_receive_bytes_total</code></td>
<td>网络接口累计接收的字节数</td>
</tr>
<tr>
<td>网络</td>
<td><code>node_network_transmit_bytes_total</code></td>
<td>网络接口累计发送的字节数</td>
</tr>
<tr>
<td>网络</td>
<td><code>node_network_receive_errs_total</code></td>
<td>网络接口接收数据包时发生错误的总数</td>
</tr>
<tr>
<td>网络</td>
<td><code>node_network_transmit_errs_total</code></td>
<td>网络接口发送数据包时发生错误的总数</td>
</tr>
<tr>
<td>进程</td>
<td><code>node_procs_running</code></td>
<td>当前正在运行的进程数量</td>
</tr>
<tr>
<td>进程</td>
<td><code>node_procs_blocked</code></td>
<td>当前处于阻塞状态的进程数量</td>
</tr>
<tr>
<td>文件系统</td>
<td><code>node_filesystem_size_bytes</code></td>
<td>文件系统的总大小（以字节为单位）</td>
</tr>
<tr>
<td>文件系统</td>
<td><code>node_filesystem_free_bytes</code></td>
<td>文件系统的空闲空间大小（以字节为单位）</td>
</tr>
<tr>
<td>文件系统</td>
<td><code>node_filesystem_avail_bytes</code></td>
<td>文件系统中可供普通用户使用的空闲空间大小（以字节为单位）</td>
</tr>
</tbody></table>
<h2 id="mysql监控"><a href="#mysql监控" class="headerlink" title="mysql监控"></a>mysql监控</h2><p>docker-compose.yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">LANG:</span> <span class="string">en_US.UTF-8</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">      <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="string">--collation-server=utf8mb4_general_ci</span></span><br><span class="line">      <span class="string">--lower_case_table_names=1</span></span><br><span class="line">      <span class="string">--performance_schema=1</span></span><br><span class="line">      <span class="string">--sql_mode=&quot;&quot;</span></span><br><span class="line">      <span class="string">--skip-log-bin</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/mysql/data:/var/lib/mysql</span>  <span class="comment"># 数据文件挂载</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3306</span><span class="string">:3306</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>进入容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mysql mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>创建用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#x27;exporter&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;password&#x27; WITH MAX_USER_CONNECTIONS 3;</span><br><span class="line"></span><br><span class="line">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO &#x27;exporter&#x27;@&#x27;%&#x27;;</span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mysql mysql -uexporter -p</span><br></pre></td></tr></table></figure>

<p>docker-mysql-exporter</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysqld-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/mysqld-exporter:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysqld-exporter</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collect.info_schema.processlist</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collect.info_schema.innodb_metrics</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collect.info_schema.tablestats</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collect.info_schema.tables</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collect.info_schema.userstats</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collect.engine_innodb_status</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;--mysqld.username=exporter:password&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;--mysqld.address=192.168.8.131:3306&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9104</span><span class="string">:9104</span></span><br></pre></td></tr></table></figure>

<h3 id="参数详解"><a href="#参数详解" class="headerlink" title="参数详解"></a>参数详解</h3><ol>
<li><strong><code>--collect.info_schema.processlist</code></strong><br>此参数的作用是让 <code>mysqld-exporter</code> 从 MySQL 的 <code>information_schema.processlist</code> 表收集数据。这个表记录了当前 MySQL 服务器上正在执行的所有线程的信息，像线程 ID、用户、主机、执行的查询等。借助收集这些数据，能够对 MySQL 服务器上的活动查询和线程进行监控。</li>
<li><strong><code>--collect.info_schema.innodb_metrics</code></strong><br>该参数会让 <code>mysqld-exporter</code> 从 <code>information_schema.innodb_metrics</code> 表收集 InnoDB 存储引擎的性能指标。这些指标涵盖了锁等待、事务处理、缓冲池使用情况等多方面的信息，有助于深入了解 InnoDB 存储引擎的运行状况。</li>
<li><strong><code>--collect.info_schema.tablestats</code></strong><br>使用这个参数，<code>mysqld-exporter</code> 会从 <code>information_schema.tablestats</code> 表收集表的统计信息，比如表中的行数、数据长度、索引长度等。这些统计信息可用于评估表的大小和使用情况。</li>
<li><strong><code>--collect.info_schema.tables</code></strong><br>它的作用是让 <code>mysqld-exporter</code> 从 <code>information_schema.tables</code> 表收集表的元数据，包括表名、存储引擎、创建时间、更新时间等。这些元数据有助于对数据库中的表进行管理和监控。</li>
<li><strong><code>--collect.info_schema.userstats</code></strong><br>该参数会使 <code>mysqld-exporter</code> 从 <code>information_schema.userstats</code> 表收集用户的统计信息，像用户执行的查询次数、查询时间等。这些信息有助于了解不同用户对数据库的使用情况。</li>
<li><strong><code>--collect.engine_innodb_status</code></strong><br>这个参数让 <code>mysqld-exporter</code> 收集 InnoDB 存储引擎的状态信息。这些信息包含了 InnoDB 的内部状态、锁信息、事务信息等，对排查 InnoDB 相关的问题很有帮助。</li>
<li><strong><code>&quot;--mysqld.username=exporter:password&quot;</code></strong><br>此参数用于指定连接 MySQL 数据库时使用的用户名和密码。</li>
<li><strong><code>&quot;--mysqld.address=192.168.8.131:3306&quot;</code></strong><br>该参数用于指定要监控的 MySQL 数据库的地址和端口。在这个例子中，MySQL 服务器的 IP 地址是 <code>192.168.8.131</code>，端口号是 <code>3306</code>。</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://192.168.8.131:9104/">MySQLd Exporter</a> 打开连接验证是否运行成功</p>
<h3 id="常用监控指标"><a href="#常用监控指标" class="headerlink" title="常用监控指标"></a>常用监控指标</h3><table>
<thead>
<tr>
<th>监控指标</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>mysql_up</td>
<td>反映服务器是否在线</td>
</tr>
<tr>
<td>mysql_global_status_uptime</td>
<td>服务器运行时长，单位为秒</td>
</tr>
<tr>
<td>delta(mysql_global_status_bytes_received[1m])</td>
<td>1 分钟内网络接收的字节数</td>
</tr>
<tr>
<td>delta(mysql_global_status_bytes_sent[1m])</td>
<td>1 分钟内网络发送的字节数</td>
</tr>
<tr>
<td>mysql_global_status_threads_connected</td>
<td>当前的客户端连接数</td>
</tr>
<tr>
<td>mysql_global_variables_max_connections</td>
<td>允许的最大连接数</td>
</tr>
<tr>
<td>mysql_global_status_threads_running</td>
<td>正在执行命令（非 sleep 状态）的客户端连接数</td>
</tr>
<tr>
<td>delta(mysql_global_status_aborted_connects[1m])</td>
<td>1 分钟内客户端建立连接失败的连接数</td>
</tr>
<tr>
<td>delta(mysql_global_status_aborted_clients[1m])</td>
<td>1 分钟内客户端连接后未正常关闭的连接数</td>
</tr>
<tr>
<td>delta(mysql_global_status_commands_total{command&#x3D;”xx”}[1m])</td>
<td>1 分钟内各种命令的执行次数</td>
</tr>
<tr>
<td>delta(mysql_global_status_handlers_total{handler&#x3D;”xx”}[1m])</td>
<td>1 分钟内各种操作的执行次数</td>
</tr>
<tr>
<td>delta(mysql_global_status_handlers_total{handler&#x3D;”commit”}[1m])</td>
<td>1 分钟内 commit 操作的执行次数</td>
</tr>
<tr>
<td>delta(mysql_global_status_table_locks_immediate[1m])</td>
<td>1 分钟内请求获取锁且立即获得的请求数</td>
</tr>
<tr>
<td>delta(mysql_global_status_table_locks_waited[1m])</td>
<td>1 分钟内请求获取锁但需要等待的请求数</td>
</tr>
<tr>
<td>delta(mysql_global_status_queries[1m])</td>
<td>1 分钟内的查询数</td>
</tr>
<tr>
<td>delta(mysql_global_status_slow_queries[1m])</td>
<td>1 分钟内的慢查询数</td>
</tr>
<tr>
<td>mysql_global_status_innodb_page_size</td>
<td>InnoDB 数据页的大小，单位为字节</td>
</tr>
<tr>
<td>mysql_global_variables_innodb_buffer_pool_size</td>
<td>InnoDB_buffer_pool 的限制体积</td>
</tr>
<tr>
<td>mysql_global_status_buffer_pool_pages{state&#x3D;”data”}</td>
<td>包含数据的数据页数（包括洁页、脏页）</td>
</tr>
<tr>
<td>mysql_global_status_buffer_pool_dirty_pages</td>
<td>脏页数</td>
</tr>
</tbody></table>
<h3 id="告警规则"><a href="#告警规则" class="headerlink" title="告警规则"></a>告警规则</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql_monitoring_rules</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># 服务器离线告警</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">MySQLServerOffline</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">mysql_up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;MySQL服务器离线&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;检测到MySQL服务器已停止运行，请立即检查。&quot;</span></span><br><span class="line">  <span class="comment"># 客户端连接数过高告警</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">MySQLClientConnectionsHigh</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">mysql_global_status_threads_connected</span> <span class="string">&gt;</span> <span class="string">mysql_global_variables_max_connections</span> <span class="string">*</span> <span class="number">0.8</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;MySQL客户端连接数过高&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;当前MySQL客户端连接数已超过最大连接数的80%，可能影响服务性能，请关注。&quot;</span></span><br><span class="line">  <span class="comment"># 连接失败数过高告警</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">MySQLConnectionFailuresHigh</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">delta(mysql_global_status_aborted_connects[5m])</span> <span class="string">&gt;</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;MySQL连接失败数过高&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;在过去5分钟内，MySQL客户端建立连接失败数超过10次，请排查网络或认证相关问题。&quot;</span></span><br><span class="line">  <span class="comment"># 慢查询数过高告警</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">MySQLSlowQueriesHigh</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">delta(mysql_global_status_slow_queries[5m])</span> <span class="string">&gt;</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;MySQL慢查询数过高&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;在过去5分钟内，MySQL慢查询数超过5次，可能存在性能问题，请检查SQL语句。&quot;</span></span><br></pre></td></tr></table></figure>

<p>检查配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">prometheus</span> <span class="string">promtool</span> <span class="string">check</span> <span class="string">config</span> <span class="string">/etc/prometheus/prometheus.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="黑盒监控"><a href="#黑盒监控" class="headerlink" title="黑盒监控"></a>黑盒监控</h2><p>把exporter安装到监控目标主机上，就是白盒监控。</p>
<p>监控他人主机运行，给目标主机发送请求，探测状态，就是黑盒监控</p>
<p><strong>监控原理</strong></p>
<ul>
<li><strong>黑盒监控</strong>：黑盒监控将被监控对象视为一个不透明的 “黑盒”，只关注其输入和输出，通过向被监控系统发送特定的探测请求，然后根据返回的响应来判断系统的运行状态，不考虑内部的运行机制和实现细节。</li>
<li><strong>白盒监控</strong>：白盒监控则是<strong>基于对被监控系统内部结构和运行机制的了解</strong>，通过在系统内部植入监控探针或利用系统自身暴露的监控接口，来获取系统内部的各种指标和状态信息，从而实现对系统的深入监控。</li>
</ul>
<p><strong>数据来源</strong></p>
<ul>
<li><strong>黑盒监控</strong>：数据主要来源于<strong>外部对系统的探测</strong>，比如通过 HTTP 请求、ICMP 包等方式获取系统的响应信息，包括响应码、响应时间、数据包丢失率等。</li>
<li><strong>白盒监控</strong>：数据来自于<strong>被监控系统内部</strong>，例如应用程序的性能指标（如 CPU 使用率、内存占用、数据库查询执行时间、缓存命中率）、系统日志、进程状态等。</li>
</ul>
<p><strong>应用场景</strong></p>
<ul>
<li><strong>黑盒监控</strong>：常用于监控网络设备、服务器的连通性、外部服务的可用性等场景。比如，监控一个网站的可用性，可以通过向网站的域名发送 HTTP 请求，根据返回的状态码来判断网站是否正常运行。如果返回 200 OK，表示网站正常；如果返回 500 Internal Server Error 等错误码，则表示网站可能出现了问题。</li>
<li><strong>白盒监控</strong>：适用于对应用程序和系统内部性能进行深入分析和优化的场景。以一个电商网站为例，白盒监控可以收集数据库的查询性能指标，了解哪些查询语句执行时间较长，从而针对性地进行优化；还可以监控应用服务器的内存使用情况，及时发现内存泄漏等问题。</li>
</ul>
<p><strong>配置复杂度</strong></p>
<ul>
<li><strong>黑盒监控</strong>：配置相对简单，只需要定义好探测的目标地址、探测方法（如 HTTP、ICMP 等）以及相关的阈值即可。例如，使用 Prometheus 的 Blackbox Exporter 监控一个 Web 服务，只需配置要监控的 URL 和期望的响应状态码等基本信息。</li>
<li><strong>白盒监控</strong>：配置通常较为复杂，需要在被监控系统中安装和配置监控代理或插件，并且要根据不同的应用和系统类型，配置相应的监控指标采集规则。例如，在 Java 应用中使用 JMX Exporter 来暴露 JVM 的性能指标，需要对 JMX 进行详细的配置，包括选择要监控的 MBean 对象和属性等。</li>
</ul>
<p><strong>对被监控系统的影响</strong></p>
<ul>
<li><strong>黑盒监控</strong>：因为是从外部进行探测，对被监控系统的性能影响通常较小，除非探测的频率非常高或者探测请求本身对系统资源消耗较大。</li>
<li><strong>白盒监控</strong>：由于需要在系统内部运行监控组件，可能会对被监控系统的性能产生一定的影响，尤其是在采集大量详细指标时。例如，频繁地读取系统日志或收集大量的性能指标数据，可能会增加系统的 CPU 和 I&#x2F;O 开销。</li>
</ul>
<p>Blackbox Exporter 支持多种探测方式，下面是不同探测方式及其在 <code>blackbox.yml</code> 中的配置示例，和 Prometheus 配置。</p>
<h3 id="1-HTTP-探测"><a href="#1-HTTP-探测" class="headerlink" title="1. HTTP 探测"></a>1. HTTP 探测</h3><p>HTTP 探测可用于检查网站的可用性、响应时间等。</p>
<h4 id="http-2xx配置示例"><a href="#http-2xx配置示例" class="headerlink" title="http_2xx配置示例"></a>http_2xx配置示例</h4><p><code>blackbox.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">http_2xx:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">valid_status_codes:</span> [<span class="number">200</span>]</span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">preferred_ip_protocol:</span> <span class="string">&quot;ip4&quot;</span></span><br><span class="line">      <span class="attr">no_follow_redirects:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail_if_ssl:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail_if_not_ssl:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><code>prober: http</code></p>
<ul>
<li><strong>含义</strong>：明确使用 HTTP 作为探测方式。Blackbox Exporter 支持多种探测方式，像 HTTP、TCP、ICMP 等，此参数表明本次探测采用 HTTP 请求。</li>
<li><strong>必要性</strong>：必要参数。它是指定探测类型的关键，若缺少该参数，Blackbox Exporter 就无法知晓采用何种方式进行探测。</li>
</ul>
<p><code>timeout: 5s</code></p>
<ul>
<li><strong>含义</strong>：设定探测请求的超时时间为 5 秒。若在 5 秒内未收到服务器响应，就会判定探测失败。</li>
<li><strong>必要性</strong>：非必要参数。若未设置该参数，Blackbox Exporter 会使用默认的超时时间 10 秒。</li>
</ul>
<p><code>http</code> 子配置块</p>
<p><code>valid_status_codes: [200]</code></p>
<ul>
<li><strong>含义</strong>：规定只有当服务器返回的 HTTP 状态码为 200 时，才认为探测成功。可根据需求添加其他状态码，例如 <code>[200, 201, 204]</code>。</li>
<li><strong>必要性</strong>：非必要参数。若不设置该参数，默认所有状态码都被视为有效。在实际监控中，通常需要明确指定期望的状态码。</li>
</ul>
<p><code>method: GET</code></p>
<ul>
<li><strong>含义</strong>：指定使用 HTTP GET 方法发送探测请求。HTTP 还有 POST、PUT、DELETE 等其他方法，可根据实际情况进行修改。</li>
<li><strong>必要性</strong>：非必要参数。默认使用 GET 方法，若需要使用其他方法，就需要设置该参数。</li>
</ul>
<p><code>preferred_ip_protocol: &quot;ip4&quot;</code></p>
<ul>
<li><strong>含义</strong>：优先使用 IPv4 协议进行通信。若目标服务器同时支持 IPv4 和 IPv6，会优先选择 IPv4 地址进行连接。</li>
<li><strong>必要性</strong>：非必要参数。若不设置该参数，会使用系统默认的 IP 协议。</li>
</ul>
<p><code>no_follow_redirects: false</code></p>
<ul>
<li><strong>含义</strong>：设置是否跟随 HTTP 重定向。<code>false</code> 表示跟随重定向，即当服务器返回 3xx 状态码时，会继续访问重定向后的地址；<code>true</code> 则表示不跟随重定向。</li>
<li><strong>必要性</strong>：非必要参数。默认会跟随重定向，若不需要跟随重定向，可将其设置为 <code>true</code>。</li>
</ul>
<p><code>fail_if_ssl: false</code></p>
<ul>
<li><strong>含义</strong>：设定若服务器使用 SSL&#x2F;TLS 加密连接，是否判定探测失败。<code>false</code> 表示即使使用 SSL&#x2F;TLS 也不判定失败；<code>true</code> 则表示若使用 SSL&#x2F;TLS 就判定失败。</li>
<li><strong>必要性</strong>：非必要参数。通常情况下，不需要因为服务器使用 SSL&#x2F;TLS 而判定失败，所以默认设置为 <code>false</code>。</li>
</ul>
<p><code>fail_if_not_ssl: false</code></p>
<ul>
<li><strong>含义</strong>：规定若服务器未使用 SSL&#x2F;TLS 加密连接，是否判定探测失败。<code>false</code> 表示即使不使用 SSL&#x2F;TLS 也不判定失败；<code>true</code> 则表示若不使用 SSL&#x2F;TLS 就判定失败。</li>
<li><strong>必要性</strong>：非必要参数。默认情况下，不要求服务器必须使用 SSL&#x2F;TLS 连接。</li>
</ul>
<p><code>tls_config</code> 子配置块</p>
<p><code>insecure_skip_verify: false</code></p>
<ul>
<li><strong>含义</strong>：设置是否跳过 SSL&#x2F;TLS 证书验证。<code>false</code> 表示不跳过验证，会验证服务器的 SSL&#x2F;TLS 证书是否有效；<code>true</code> 则表示跳过验证，即使证书无效也会继续连接。</li>
<li><strong>必要性</strong>：非必要参数。在生产环境中，建议保持 <code>false</code> 以确保通信安全；在测试环境中，若服务器使用的是自签名证书，可将其设置为 <code>true</code>。</li>
</ul>
<p><code>prometheus.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_http&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http://baidu.com</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<h4 id="http-post-2xx-配置示例"><a href="#http-post-2xx-配置示例" class="headerlink" title="http_post_2xx 配置示例"></a><code>http_post_2xx</code> 配置示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">http_post_2xx:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">valid_status_codes:</span> [<span class="number">200</span>]</span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">Content-Type:</span> <span class="string">application/json</span></span><br><span class="line">      <span class="attr">body:</span> <span class="string">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span></span><br><span class="line">      <span class="attr">preferred_ip_protocol:</span> <span class="string">&quot;ip4&quot;</span></span><br><span class="line">      <span class="attr">no_follow_redirects:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail_if_ssl:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail_if_not_ssl:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>在 <code>http_post_2xx</code> 配置中，除了把 <code>method</code> 设置为 <code>POST</code> 外，还可能需要配置 <code>headers</code> 和 <code>body</code> 参数。<code>headers</code> 用于设置请求头，例如指定请求体的内容类型；<code>body</code> 用于设置请求体，即要提交的数据。</p>
<h3 id="2-TCP-探测"><a href="#2-TCP-探测" class="headerlink" title="2. TCP 探测"></a>2. TCP 探测</h3><p>TCP 探测用于检查目标主机的 TCP 端口是否开放。</p>
<p><code>blackbox.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">tcp_connect:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>

<p><code>prometheus.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_tcp&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">tcp_connect</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">example.com:80</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<h3 id="3-ICMP-探测"><a href="#3-ICMP-探测" class="headerlink" title="3. ICMP 探测"></a>3. ICMP 探测</h3><p>ICMP 探测用于检查目标主机的连通性。</p>
<p><code>blackbox.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">icmp:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">icmp</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>

<p><code>prometheus.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_icmp&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">icmp</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">example.com</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<h3 id="4-DNS-探测"><a href="#4-DNS-探测" class="headerlink" title="4. DNS 探测"></a>4. DNS 探测</h3><p>DNS 探测用于检查 DNS 解析是否正常。</p>
<p><code>blackbox.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">dns:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">dns</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">dns:</span></span><br><span class="line">      <span class="attr">query_name:</span> <span class="string">&quot;example.com&quot;</span></span><br><span class="line">      <span class="attr">query_type:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">      <span class="attr">valid_rcodes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NOERROR</span></span><br><span class="line">      <span class="attr">validate_answer_rrs:</span></span><br><span class="line">        <span class="attr">fail_if_matches_regexp:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;.*127.0.0.1&quot;</span></span><br><span class="line">        <span class="attr">fail_if_not_matches_regexp:</span> []</span><br></pre></td></tr></table></figure>

<p><code>prometheus.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_dns&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">dns</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<h3 id="5-SMTP-探测"><a href="#5-SMTP-探测" class="headerlink" title="5. SMTP 探测"></a>5. SMTP 探测</h3><p>SMTP 探测用于检查 SMTP 服务器是否正常工作。</p>
<p><code>blackbox.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">smtp:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">smtp</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">smtp:</span></span><br><span class="line">      <span class="attr">starttls:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">ehlo_domain:</span> <span class="string">&quot;example.com&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>prometheus.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_smtp&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">smtp</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">smtp.example.com:25</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<h3 id="6-POP3-探测"><a href="#6-POP3-探测" class="headerlink" title="6. POP3 探测"></a>6. POP3 探测</h3><p>POP3 探测用于检查 POP3 服务器是否正常工作。</p>
<p><code>blackbox.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">pop3:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">pop3</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">pop3:</span></span><br><span class="line">      <span class="attr">starttls:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><code>prometheus.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_pop3&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">pop3</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pop3.example.com:110</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<h3 id="7-IMAP-探测"><a href="#7-IMAP-探测" class="headerlink" title="7. IMAP 探测"></a>7. IMAP 探测</h3><p>IMAP 探测用于检查 IMAP 服务器是否正常工作。</p>
<p><code>blackbox.yml</code> 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">imap:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">imap</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">imap:</span></span><br><span class="line">      <span class="attr">starttls:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><code>prometheus.yml</code> <strong>配置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_imap&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">imap</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">imap.example.com:143</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">http_2xx:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">  <span class="attr">http_post_2xx:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">  <span class="attr">tcp_connect:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">tcp</span></span><br><span class="line">  <span class="attr">icmp:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">icmp</span></span><br></pre></td></tr></table></figure>

<p>直接运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart=always --name blackbox-exporter -p 9115:9115 -v /data/blackbox_exporter:/etc/blackbox_exporter prom/blackbox-exporter:v0.19.0 --config.file=/etc/blackbox_exporter/config.yml</span><br></pre></td></tr></table></figure>

<p>添加prometheus.yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http配置</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_http&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://baidu.com</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.131</span><span class="string">:9115</span></span><br><span class="line"><span class="comment">#tcp配置</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_tcp&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">tcp_connect</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.130</span><span class="string">:9090</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">162.168</span><span class="number">.8</span><span class="number">.130</span><span class="string">:22</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.131</span><span class="string">:9115</span></span><br><span class="line"><span class="comment">#icmp检查配置ping</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox_icmp&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">icmp</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.130</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.131</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">192.168</span><span class="number">.8</span><span class="number">.131</span><span class="string">:9115</span></span><br></pre></td></tr></table></figure>

<p><strong>常用指标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">probe_success，是否探测成功（取值 1、0 分别表示成功、失败）</span><br><span class="line">probe_duration_seconds，探测的耗时</span><br><span class="line">probe_dns_lookup_time_seconds，DNS 解析的耗时</span><br><span class="line">probe_ip_protocol，IP 协议，取值为 4、6</span><br><span class="line">probe_ip_addr_hash，IP 地址的哈希值，用于判断 IP 是否变化</span><br><span class="line">probe_http_status_code，HTTP 响应的状态码。如果发生重定向，则取决于最后一次响应</span><br><span class="line">probe_http_content_length，HTTP 响应的 body 长度，单位 bytes</span><br><span class="line">probe_http_version，HTTP 响应的协议版本，比如 1.1</span><br><span class="line">probe_http_ssl，HTTP 响应是否采用 SSL ，取值为 1、0</span><br><span class="line">probe_ssl_earliest_cert_expiry，SSL 证书的过期时间，为 Unix 时间戳</span><br></pre></td></tr></table></figure>

<p><strong>触发器配置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Blackbox</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">黑盒子探测失败告警</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_success</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;黑盒子探测失败<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;黑盒子检测失败，当前值：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">请求慢告警</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">avg_over_time(probe_duration_seconds[1m])</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;请求慢<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;请求时间超过1秒，值为：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">http状态码检测失败</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_http_status_code</span> <span class="string">&lt;=</span> <span class="number">199</span> <span class="string">OR</span> <span class="string">probe_http_status_code</span> <span class="string">&gt;=</span> <span class="number">400</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;http状态码异常<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;http状态码不在正常范围，当前值：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">DNS解析超时告警</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_dns_lookup_time_seconds</span> <span class="string">&gt;</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;DNS解析超时<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;DNS解析耗时超过0.5秒，当前值：<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">SSL证书即将过期告警</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">(probe_ssl_earliest_cert_expiry</span> <span class="bullet">-</span> <span class="string">time())</span> <span class="string">/</span> <span class="string">(60</span> <span class="string">*</span> <span class="number">60</span> <span class="string">*</span> <span class="number">24</span><span class="string">)</span> <span class="string">&lt;</span> <span class="number">7</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;SSL证书即将过期<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;SSL证书剩余有效期不足7天，当前剩余天数：<span class="template-variable">&#123;&#123; ($value / (60 * 60 * 24)) | printf \&quot;%.0f\&quot; &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Pushgateway-1"><a href="#Pushgateway-1" class="headerlink" title="Pushgateway"></a>Pushgateway</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9091:9091 --name pushgateway prom/pushgateway</span><br></pre></td></tr></table></figure>

<p>prometheus.yml 增加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;pushgateway&#x27;</span><br><span class="line">  honor_labels:true</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets:[192.168.8.130:9091]</span><br><span class="line">    labels:</span><br><span class="line">    	instance:pushgateway</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:9090/-/reload</span><br></pre></td></tr></table></figure>

<h3 id="curl-推送消息"><a href="#curl-推送消息" class="headerlink" title="curl 推送消息"></a>curl 推送消息</h3><ul>
<li>向{ job&#x3D;”some_job” } 添加单条数据：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> “some_metric 3.14” | curl --data-binary @- http://192.168.8.130:9091/metrics/job/some_job</span><br></pre></td></tr></table></figure>

<ul>
<li>删除某个组下的某个实例的所有数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE http://192.168.8.130:9091/metrics/job/some_job/instance/some_instance</span><br></pre></td></tr></table></figure>

<ul>
<li>删除某个组下的所有数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE http://192.168.8.130:9091/metrics/job/some_job</span><br></pre></td></tr></table></figure>

<h3 id="python-推送消息"><a href="#python-推送消息" class="headerlink" title="python  推送消息"></a>python  推送消息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install python3-pip</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install prometheus_client</span><br></pre></td></tr></table></figure>



<h2 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h2><h3 id="邮箱告警"><a href="#邮箱告警" class="headerlink" title="邮箱告警"></a>邮箱告警</h3><p>略，见上文</p>
<h3 id="企业钉钉告警"><a href="#企业钉钉告警" class="headerlink" title="企业钉钉告警"></a>企业钉钉告警</h3><p><strong>企业钉钉创建群聊自定义机器人</strong></p>
<p>&#x2F;data&#x2F;docker-prometheus&#x2F;prometheus-webhook-dingtalk&#x2F;config.yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">targets:</span></span><br><span class="line">  <span class="attr">webhook1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://oapi.dingtalk.com/robot/send?access_token=之前复制的TOKEN</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">SEC00000000000000000000</span></span><br><span class="line">    <span class="comment">#message:</span></span><br><span class="line">    <span class="comment">#  text: &#x27;&#123;&#123; template &quot;default.content&quot; . &#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>docker-compose创建</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">timonwong/prometheus-webhook-dingtalk:v2.1.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">prometheus-webhook-dingtalk</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;always&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8060</span><span class="string">:8060</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus-webhook-dingtalk/config.yml&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="string">-./config.yml:/etc/prometheus-webhook-dingtalk/config.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br></pre></td></tr></table></figure>

<p>alertmanager的config.yml文件新增</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&#x27;dingtalk&#x27;</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;dingtalk&#x27;</span></span><br><span class="line">  <span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://192.168.11.61:8060/dingtalk/webhook1/send&#x27;</span></span><br><span class="line">    <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>修改全局receiver 为 <code>dingtalk</code></p>
<h3 id="企业微信告警"><a href="#企业微信告警" class="headerlink" title="企业微信告警"></a>企业微信告警</h3><p>创建群机器人 拷贝webhook地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>docker_compose</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">prometheus-webhook-wechat:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">linge365/webhook-wechat:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">prometheus-webhook-wechat</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ROBOT_TOKEN:</span> <span class="string">&quot;填入之前复制的token&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;wechat&#x27;</span></span><br><span class="line">  <span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://192.168.11.61:8060&#x27;</span></span><br><span class="line">    <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="飞书告警"><a href="#飞书告警" class="headerlink" title="飞书告警"></a>飞书告警</h3><h4 id="项目链接："><a href="#项目链接：" class="headerlink" title="项目链接："></a>项目链接：</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/XUJiahua/alertmanager-webhook-feishu">GitHub - XUJiahua&#x2F;alertmanager-webhook-feishu</a><br>该项目基于 Go 语言开发，支持飞书机器人的消息模板定制、@指定用户、签名校验等功能，适用于 Kubernetes 等云原生环境。</li>
</ul>
<h4 id="使用方式："><a href="#使用方式：" class="headerlink" title="使用方式："></a>使用方式：</h4><ol>
<li><p><strong>创建飞书机器人</strong>：<br>在飞书群聊中添加自定义机器人，获取 Webhook URL。</p>
</li>
<li><p>配置 Alertmanager：在alertmanager.yml中定义接收器：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;feishu&#x27;</span></span><br><span class="line">  <span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://&lt;alertmanager-webhook-feishu服务地址&gt;/hook/&lt;自定义群组名&gt;&#x27;</span></span><br><span class="line">    <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>部署工具</strong>：<br>通过 Docker 或二进制包部署，配置飞书机器人的 Webhook URL 和模板文件。</p>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/search?q=feishu-webhook">Explore Docker’s Container Image Repository | Docker Hub</a></p>
<h4 id="特性："><a href="#特性：" class="headerlink" title="特性："></a>特性：</h4><ul>
<li>支持多机器人管理</li>
<li>自定义消息模板（基于 Go Template）</li>
<li>支持 @ 特定用户（需获取用户 <code>open_id</code>）</li>
<li>提供 Helm Chart 简化 Kubernetes 部署</li>
</ul>
<h2 id="问题解答："><a href="#问题解答：" class="headerlink" title="问题解答："></a>问题解答：</h2><p><strong>1、expoeters demo 本地运行 了解exporters的原理</strong></p>
<p>例如，若当前时间是 10:00:00，Exporter 在 9:59:55 采集了数据，当 Prometheus 在 10:00:00 来拉取时，Exporter 就把 9:59:55 采集到的数据返回</p>
<p><strong>时间戳的添加</strong></p>
<p>时间戳是由 Prometheus 在抓取指标数据时自动添加的，而不是由 Exporter 负责添加。当 Prometheus 从 Exporter 抓取到指标数据后，会为每个样本添加上当前的时间戳，以此来记录该样本的采集时间。所以，即便你在自定义 Exporter 时没有添加时间戳，Prometheus 也会自动处理并为数据加上时间戳，这样就能在 Prometheus 中基于时间序列进行查询和分析了。</p>
<p><strong>采样时间的设置主体</strong></p>
<p>采样时间是由 Prometheus 配置文件设置的，而不是由 Exporter 决定。在 Prometheus 的配置文件里，<code>scrape_interval</code> 参数用于设定 Prometheus 从各个 Exporter 抓取指标数据的时间间隔。示例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span>  <span class="comment"># 每 15 秒从 Exporter 抓取一次数据</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span>  <span class="comment"># 每 15 秒评估一次告警规则</span></span><br></pre></td></tr></table></figure>

<p>虽然你自定义的 Exporter 定义了每 15 秒获取一次指标，但这只是 Exporter 自身收集指标的频率。Prometheus 会按照自己配置的 <code>scrape_interval</code> 去抓取 Exporter 提供的指标数据。比如，若 Exporter 每 15 秒更新一次指标，而 Prometheus 的 <code>scrape_interval</code> 设为 1 分钟，那么 Prometheus 还是会每分钟去抓取一次 Exporter 上的数据。</p>
<ul>
<li>MySQL<ul>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/information-schema.html">MySQL 官方文档 - INFORMATION_SCHEMA</a>：详细介绍了 <code>INFORMATION_SCHEMA</code> 数据库中的各个表，包括与性能相关的表，如 <code>PROCESSLIST</code> 等。</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema.html">MySQL 官方文档 - PERFORMANCE_SCHEMA</a>：对 <code>PERFORMANCE_SCHEMA</code> 中用于性能监控的表和功能进行了全面说明。</li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/sys-schema.html">MySQL 官方文档 - sys schema</a>：介绍了 <code>sys</code> 模式下与性能分析相关的视图和表，能帮助用户更方便地查看和分析性能数据。</li>
</ul>
</li>
<li>PostgreSQL<ul>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-ACTIVITY-VIEW">PostgreSQL 官方文档 - pg_stat_activity</a>：对 <code>pg_stat_activity</code> 视图进行了详细解释，包括其各个字段的含义和用途。</li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/pgstatstatements.html">PostgreSQL 官方文档 - pg_stat_statements</a>：说明了 <code>pg_stat_statements</code> 扩展的功能和相关表结构，用于收集和分析查询的执行统计信息。</li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-DATABASE-VIEW">PostgreSQL 官方文档 - pg_stat_database</a>：介绍了 <code>pg_stat_database</code> 视图，提供了关于数据库级别的统计信息，如连接数、事务数等。</li>
</ul>
</li>
<li>CockroachDB<ul>
<li><a target="_blank" rel="noopener" href="https://www.cockroachlabs.com/docs/stable/system-tables.html">CockroachDB 官方文档 - System Tables</a>：介绍了 CockroachDB 中的系统表，包括与性能监控相关的表，如 <code>crdb_internal.cluster_contention_events</code> 等。</li>
<li><a target="_blank" rel="noopener" href="https://www.cockroachlabs.com/docs/stable/monitoring-and-metrics.html">CockroachDB 官方文档 - Monitoring and Metrics</a>：提供了关于 CockroachDB 性能监控的整体指导，包括如何使用内置的性能指标表以及相关的监控工具。</li>
</ul>
</li>
</ul>
<p>2、<strong>从哪些角度对数据库制定监控规则？适用性</strong></p>
<p><strong>mysql</strong></p>
<p>服务可用性：实时判断 MySQL 实例、从库线程是否正常运行，确保服务稳定。</p>
<p>资源利用：针对连接数、线程运行、文件打开数量以及预准备语句的使用，进行合理调配与监控。</p>
<p>复制性能：通过监控复制延迟，保障数据同步的及时性和准确性。</p>
<p>查询性能：检测慢查询和 QPS，优化数据库查询效率。</p>
<p>日志状态：关注 InnoDB 日志写入等待，确保日志系统稳定运行。</p>
<p>系统状态：捕捉 MySQL 服务重启，以及 InnoDB 强制恢复等关键系统状态变化。</p>
<p>参数优化：针对 InnoDB 历史长度过高等问题，给出优化建议 。</p>
<p><strong>pg</strong></p>
<p>服务状态：检查服务是否宕机、重启，以及监控工具是否报错。</p>
<p>连接管理：针对连接数过多、过少，以及锁资源使用过量的情况告警。</p>
<p>数据维护：监测表的自动清理与分析操作是否按时执行。</p>
<p>事务性能：关注事务提交率、回滚率，以及事务 ID 消耗速度。</p>
<p>异常情况：对死锁、语句超时等数据库异常进行预警。</p>
<p>复制同步：检测复制槽状态，以及复制延迟是否过高。</p>
<p>配置与优化：跟踪配置变更，避免 SSL 压缩带来的问题，并处理表和索引的膨胀 。</p>
<p><strong>mangodb</strong></p>
<p>服务可用性：通过 <code>mongodb_up</code> 判断实例是否宕机，利用 <code>mongodb_rs_members_health</code> 监测副本集成员健康状况。</p>
<p>复制性能：监控复制延迟，若超过 10 秒则告警；检查复制余量，余量小于等于 0 时告警；同时关注副本集成员状态码异常情况。</p>
<p>资源使用：当打开的游标数量超过 10k 或游标超时过多时发出警告；连接数使用超过 80% 也会告警；虚拟内存使用率过高（虚拟与映射内存比值大于 3）时给出提醒。</p>
<p>备份情况：若 MongoDB 备份失败，会触发严重告警。</p>
<p>3、直方图 和 summary 时间窗口有没有默认值？必要要手动通过中括号指定吗？不填行不行？</p>
<p>在 Prometheus 中，对于直方图（Histogram）和摘要（Summary）指标，如果不填时间窗口，默认情况下会返回<strong>当前时刻</strong>最新的值。</p>
<ul>
<li><strong>直方图</strong>：以<code>http_request_duration_seconds_bucket</code>为例，<code>http_request_duration_seconds_bucket{le=&quot;0.1&quot;} = 20</code>表示当前时间点，请求持续时间小于等于 0.1 秒的请求数量为 20。这里没有指定时间窗口，就是获取最新的统计数据。</li>
<li><strong>摘要</strong>：类似地，对于摘要指标，如果不指定时间窗口，也是返回当前最新的汇总数据，比如<code>http_request_duration_seconds_sum</code>（请求持续时间的总和）、<code>http_request_duration_seconds_count</code>（请求的总次数）等指标，会返回当下的累计值。</li>
</ul>
<p>不填时间窗口是可行的，此时会按照默认行为返回当前最新的指标数据，适用于只关心最新状态而不涉及历史数据查询的场景。但如果想要分析一段时间内的数据变化趋势或进行历史数据的统计分析，就需要手动通过中括号指定时间窗口了，如<code>[5m]</code>表示过去 5 分钟内的数据。</p>
<p><strong>4、prometheus提供的python客户端，做了一些封装，提供了哪些方法？</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/4n4nd/prometheus-api-client-python">4n4nd&#x2F;prometheus-api-client-python: A python wrapper for the prometheus http api</a></p>
<p><strong>Python 客户端库 <code>prometheus_api_client</code></strong></p>
<p><code>prometheus_api_client</code> 是一个用于与 Prometheus 进行交互的 Python 库，它对 Prometheus 的 API 进行了封装，提供了一些方便的方法：</p>
<ol>
<li><strong><code>PrometheusConnect</code> 类</strong>：用于创建与 Prometheus 服务器的连接。构造函数接受 <code>url</code> 参数指定 Prometheus 服务器的地址，<code>disable_ssl</code> 参数用于设置是否禁用 SSL 验证（默认为 <code>False</code>）。</li>
<li><strong><code>custom_query</code> 方法</strong>：用于执行自定义的 PromQL 查询。接受一个 PromQL 查询字符串作为参数，返回查询结果。结果是一个包含查询数据的 Python 字典，格式遵循 Prometheus 的 API 响应结构。</li>
<li><strong>其他方法</strong>：除了 <code>custom_query</code> 外，还提供了如 <code>get_metric_range_data</code> 等方法，用于查询一段时间范围内的指标数据。<code>get_metric_range_data</code> 方法接受 <code>query</code>（查询语句）、<code>start_time</code>（开始时间）、<code>end_time</code>（结束时间）和 <code>step</code>（时间步长）等参数。</li>
</ol>
<p><strong>Java 代码示例分析</strong></p>
<p>在你提供的 Java 代码中，&#x3D;&#x3D;没有使用专门的 Prometheus 客户端库，而是直接使用 <code>OkHttpClient</code> 来发送 HTTP 请求到 Prometheus 的 API 端点&#x3D;&#x3D;。具体步骤如下：</p>
<ol>
<li><strong>创建 <code>OkHttpClient</code> 对象</strong>：<code>OkHttpClient</code> 是一个强大的 HTTP 客户端库，用于发送 HTTP 请求。</li>
<li><strong>构建请求</strong>：使用 <code>Request.Builder</code> 构建一个 <code>GET</code> 请求，指定 Prometheus 的查询 API 端点（<code>http://localhost:9090/api/v1/query?query=node_network_transmit_bytes_total</code>）。</li>
<li><strong>发送请求并处理响应</strong>：通过 <code>client.newCall(request).execute()</code> 发送请求，并根据响应状态码处理响应数据。如果请求成功，读取并打印响应体；否则，打印错误信息。</li>
</ol>
<p>5、pushgetway 数据汇总是什么？ 持久化是什么意思？</p>
<p><strong>Pushgateway 数据汇总</strong></p>
<p><strong>场景描述</strong></p>
<p>假设你有一个<strong>分布式数据库系统</strong>，由多个数据库节点组成，用于处理不同地区的业务数据。为了监控这些数据库节点的运行状态，你会在每个节点上收集一些关键的性能指标，如每秒查询数（QPS）、磁盘 I&#x2F;O 使用率、内存使用率等。然而，Prometheus 默认采用拉取（pull）模型来收集指标数据，而有些数据库节点可能由于网络限制或其他原因，不适合被 Prometheus 直接拉取数据。这时，就可以使用 Pushgateway 来进行数据汇总。</p>
<p><strong>具体流程</strong></p>
<ol>
<li><strong>数据收集</strong>：在每个数据库节点上，运行一个监控脚本或者程序，定期收集该节点的性能指标。例如，在一个 MySQL 数据库节点上，使用 Python 脚本结合 <code>psutil</code> 库收集内存使用率，使用 <code>mysql -e</code> 命令查询 QPS 等信息。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取内存使用率</span></span><br><span class="line">memory_usage = psutil.virtual_memory().percent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 QPS</span></span><br><span class="line">result = subprocess.run([<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;-e&#x27;</span>, <span class="string">&#x27;SHOW GLOBAL STATUS LIKE &quot;Queries&quot;;&#x27;</span>], capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">queries = <span class="built_in">int</span>(result.stdout.split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;\t&#x27;</span>)[<span class="number">1</span>])</span><br><span class="line"><span class="comment"># 假设每隔 10 秒收集一次数据，这里简单模拟 QPS 计算</span></span><br><span class="line">qps = queries / <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将数据推送到 Pushgateway</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">pushgateway_url = <span class="string">&#x27;http://pushgateway.example.com:9091/metrics/job/mysql_node/instance/node1&#x27;</span></span><br><span class="line">metrics = <span class="string">f&#x27;mysql_memory_usage <span class="subst">&#123;memory_usage&#125;</span>\nmysql_qps <span class="subst">&#123;qps&#125;</span>&#x27;</span></span><br><span class="line">response = requests.post(pushgateway_url, data=metrics)</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>数据推送</strong>：每个数据库节点将收集到的指标数据推送到 Pushgateway。Pushgateway 会将这些来自不同节点的数据汇总存储在自己的内存中。</li>
<li><strong>Prometheus 拉取</strong>：Prometheus 定期从 Pushgateway 拉取汇总后的指标数据，进行存储和分析。在 Prometheus 的配置文件中，添加如下配置：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;pushgateway&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;pushgateway.example.com:9091&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>好处</strong></p>
<p>通过 Pushgateway 进行数据汇总，Prometheus 只需要与 Pushgateway 进行通信，而不需要与每个数据库节点单独通信，减少了网络复杂性和 Prometheus 的负载。</p>
<p><strong>Pushgateway 持久化</strong></p>
<p><strong>场景描述</strong></p>
<p>在上述分布式数据库系统中，某个数据库节点由于硬件故障需要进行维护，维护期间该节点会被临时下线。在节点下线之前，它最后一次推送的监控数据会被 Pushgateway 接收并持久化存储。</p>
<p><strong>具体表现</strong></p>
<ol>
<li><strong>数据保存</strong>：Pushgateway 会将接收到的监控数据保存到本地磁盘上的文件中。即使 Pushgateway 重启或者所在的服务器发生故障，这些数据也不会丢失。例如，Pushgateway 可能会将数据以文本格式存储在 <code>/var/lib/pushgateway/metrics</code> 文件中。</li>
<li><strong>旧数据问题</strong>：由于 Pushgateway 会持久化存储数据，即使数据库节点已经下线，Prometheus 仍然会从 Pushgateway 拉取到该节点的旧监控数据。这可能会导致监控系统中出现一些误导性的信息，例如显示一个已经下线的节点仍然有 QPS 数据。</li>
<li><strong>手动清理</strong>：为了避免旧数据的干扰，需要手动清理 Pushgateway 中不需要的数据。可以使用 Pushgateway 的 HTTP API 来删除特定作业或实例的指标数据。例如，使用 <code>curl</code> 命令删除 <code>mysql_node</code> 作业下 <code>node1</code> 实例的指标数据：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE http://pushgateway.example.com:9091/metrics/job/mysql_node/instance/node</span><br></pre></td></tr></table></figure>



<p>假设你有一个批处理作业，它的运行时间非常短，可能就几秒钟。在这种情况下，Prometheus 可能无法及时拉取到该作业的指标数据。此时，你可以在作业结束时把指标数据推送给 Pushgateway，然后让 Prometheus 从 Pushgateway 拉取数据。以下是一个简单的 Python 示例，展示了如何把指标数据推送给 Pushgateway：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> CollectorRegistry, Gauge, push_to_gateway</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个指标注册表</span></span><br><span class="line">registry = CollectorRegistry()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个指标</span></span><br><span class="line">g = Gauge(<span class="string">&#x27;job_duration_seconds&#x27;</span>, <span class="string">&#x27;Duration of batch job in seconds&#x27;</span>, registry=registry)</span><br><span class="line">g.<span class="built_in">set</span>(<span class="number">12.34</span>)  <span class="comment"># 设置指标值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送指标数据到 Pushgateway</span></span><br><span class="line">push_to_gateway(<span class="string">&#x27;localhost:9091&#x27;</span>, job=<span class="string">&#x27;batch_job&#x27;</span>, registry=registry)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>数据覆盖</strong>：<strong>Pushgateway 是基于标签（label）来存储指标数据的，若同一个标签组合的指标数据被多次推送，后面的数据会覆盖前面的数据。</strong></li>
<li><strong>数据清理：Pushgateway 不会自动清理过期的数据，所以需要定期清理不再使用的数据，以避免占用过多的存储空间。</strong></li>
</ul>
<p>6、除了163邮箱，是否支持其他的邮箱，qq邮箱、西电邮箱等</p>
<ul>
<li><strong>Gmail</strong>：作为全球广泛使用的邮箱服务，Gmail 支持 SMTP 协议。用户可以通过配置 SMTP 服务器地址（<a target="_blank" rel="noopener" href="https://smtp.gmail.com/">smtp.gmail.com</a>）和端口（通常为 587 或 465）来使用 SMTP 功能发送邮件。</li>
<li><strong>Outlook</strong>：包括<a target="_blank" rel="noopener" href="https://outlook.com/">Outlook.com</a>以及企业版的 Exchange Online 等都支持 SMTP。其 SMTP 服务器地址为<a target="_blank" rel="noopener" href="https://smtp.office365.com/">smtp.office365.com</a>，端口一般为 587。</li>
<li><strong>QQ 邮箱</strong>：国内常用的邮箱之一，QQ 邮箱也支持 SMTP。SMTP 服务器地址为<a target="_blank" rel="noopener" href="https://smtp.qq.com/">smtp.qq.com</a>，端口为 465 或 587。用户需要在邮箱设置中开启 SMTP 服务，并生成授权码来使用 SMTP 功能。</li>
<li><strong>163 邮箱</strong>：163 邮箱是网易旗下的邮箱服务，支持 SMTP 协议。SMTP 服务器地址为<a target="_blank" rel="noopener" href="https://smtp.163.com/">smtp.163.com</a>，端口为 25、465 或 587。</li>
<li><strong>搜狐邮箱</strong>：搜狐邮箱也提供 SMTP 服务，其 SMTP 服务器地址为<a target="_blank" rel="noopener" href="https://smtp.sohu.com/">smtp.sohu.com</a>，端口一般为 25。</li>
</ul>
<p>7、告警的分组、抑制、去重；<br>8、webhook原理 &amp; 飞书告警中心对接</p>
<p>​	Webhook 是一种允许应用程序或系统在特定事件发生时，通过 HTTP 协议将相关数据自动发送到其他应用程序或系统的机制。</p>
<p>​	简单来说，<strong>webhook就是传话人，将告警转发给群聊人员</strong></p>
<p>9、为什么prometheus数据要有这个label标签</p>
<ul>
<li><strong>唯一标识时间序列</strong>：在 Prometheus 里，指标名和标签组合起来能唯一标识一个时间序列。不同标签值的相同指标名代表不同的时间序列。例如 <code>http_requests_total{method=&quot;GET&quot;, handler=&quot;/api/users&quot;}</code> 和 <code>http_requests_total{method=&quot;POST&quot;, handler=&quot;/api/users&quot;}</code> 是两个不同的时间序列，分别记录了不同 HTTP 请求方法下的请求总数。</li>
</ul>
<h3 id="一、飞书告警工具：alertmanager-webhook-feishu"><a href="#一、飞书告警工具：alertmanager-webhook-feishu" class="headerlink" title="一、飞书告警工具：alertmanager-webhook-feishu"></a>一、飞书告警工具：<code>alertmanager-webhook-feishu</code></h3><h4 id="项目链接：-1"><a href="#项目链接：-1" class="headerlink" title="项目链接："></a>项目链接：</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/XUJiahua/alertmanager-webhook-feishu">GitHub - XUJiahua&#x2F;alertmanager-webhook-feishu</a><br>该项目基于 Go 语言开发，支持飞书机器人的消息模板定制、@指定用户、签名校验等功能，适用于 Kubernetes 等云原生环境。</li>
</ul>
<h4 id="使用方式：-1"><a href="#使用方式：-1" class="headerlink" title="使用方式："></a>使用方式：</h4><ol>
<li><p><strong>创建飞书机器人</strong>：<br>在飞书群聊中添加自定义机器人，获取 Webhook URL。</p>
</li>
<li><p>配置 Alertmanager：在alertmanager.yml中定义接收器：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;feishu&#x27;</span></span><br><span class="line">  <span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://&lt;alertmanager-webhook-feishu服务地址&gt;/hook/&lt;自定义群组名&gt;&#x27;</span></span><br><span class="line">    <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>部署工具</strong>：<br>通过 Docker 或二进制包部署，配置飞书机器人的 Webhook URL 和模板文件。</p>
</li>
</ol>
<h4 id="特性：-1"><a href="#特性：-1" class="headerlink" title="特性："></a>特性：</h4><ul>
<li>支持多机器人管理</li>
<li>自定义消息模板（基于 Go Template）</li>
<li>支持 @ 特定用户（需获取用户 <code>open_id</code>）</li>
<li>提供 Helm Chart 简化 Kubernetes 部署</li>
</ul>
<h3 id="二、其他常用软件的告警集成工具"><a href="#二、其他常用软件的告警集成工具" class="headerlink" title="二、其他常用软件的告警集成工具"></a>二、其他常用软件的告警集成工具</h3><h4 id="1-钉钉：prometheus-webhook-dingtalk"><a href="#1-钉钉：prometheus-webhook-dingtalk" class="headerlink" title="1. 钉钉：prometheus-webhook-dingtalk"></a>1. <strong>钉钉</strong>：<code>prometheus-webhook-dingtalk</code></h4><ul>
<li><strong>项目链接</strong>：<a target="_blank" rel="noopener" href="https://github.com/timonwong/prometheus-webhook-dingtalk">GitHub - timonwong&#x2F;prometheus-webhook-dingtalk</a><br>该工具支持钉钉机器人的消息模板、加签认证、Markdown 格式等，社区活跃度高，文档完善。</li>
</ul>
<h4 id="2-企业微信：webhook-wechat"><a href="#2-企业微信：webhook-wechat" class="headerlink" title="2. 企业微信：webhook-wechat"></a>2. <strong>企业微信</strong>：<code>webhook-wechat</code></h4><ul>
<li><strong>项目链接</strong>：<a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/webhook-wechat">GitHub - prometheus-operator&#x2F;webhook-wechat</a><br>官方维护的企业微信告警工具，支持消息模板和会话机器人。</li>
</ul>
<h4 id="3-Slack：官方-Webhook-集成"><a href="#3-Slack：官方-Webhook-集成" class="headerlink" title="3. Slack：官方 Webhook 集成"></a>3. <strong>Slack</strong>：官方 Webhook 集成</h4><ul>
<li><p>配置方式：</p>
<p>在 Alertmanager 中直接配置 Slack Webhook URL：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;slack&#x27;</span></span><br><span class="line">  <span class="attr">slack_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">api_url:</span> <span class="string">&#x27;https://hooks.slack.com/services/your-webhook-token&#x27;</span></span><br><span class="line">    <span class="attr">channel:</span> <span class="string">&#x27;#alerts&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="4-Microsoft-Teams：官方-Webhook-集成"><a href="#4-Microsoft-Teams：官方-Webhook-集成" class="headerlink" title="4. Microsoft Teams：官方 Webhook 集成"></a>4. <strong>Microsoft Teams</strong>：官方 Webhook 集成</h4><ul>
<li><p>配置方式：</p>
<p>在 Teams 频道中添加 Incoming Webhook，获取 URL 后配置到 Alertmanager：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;teams&#x27;</span></span><br><span class="line">  <span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;https://outlook.office.com/webhook/your-webhook-id&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="5-Email：Alertmanager-内置支持"><a href="#5-Email：Alertmanager-内置支持" class="headerlink" title="5. Email：Alertmanager 内置支持"></a>5. <strong>Email</strong>：Alertmanager 内置支持</h4><ul>
<li><p>配置方式：在alertmanager.yml中配置 SMTP 服务器：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">&#x27;smtp.example.com:587&#x27;</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">&#x27;alerts@example.com&#x27;</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">&#x27;user&#x27;</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">&#x27;password&#x27;</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;email&#x27;</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;admin@example.com&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-PagerDuty：官方集成"><a href="#6-PagerDuty：官方集成" class="headerlink" title="6. PagerDuty：官方集成"></a>6. <strong>PagerDuty</strong>：官方集成</h4><ul>
<li><strong>项目链接</strong>：<a target="_blank" rel="noopener" href="https://v1.developer.pagerduty.com/">PagerDuty Prometheus Integration</a><br>通过 PagerDuty 的 Events API 实现告警通知，支持事件升级策略。</li>
</ul>
<h4 id="7-Opsgenie：官方集成"><a href="#7-Opsgenie：官方集成" class="headerlink" title="7. Opsgenie：官方集成"></a>7. <strong>Opsgenie</strong>：官方集成</h4><ul>
<li><p>配置方式：在 Alertmanager 中配置 Opsgenie API Key：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;opsgenie&#x27;</span></span><br><span class="line">  <span class="attr">opsgenie_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">api_key:</span> <span class="string">&#x27;your-api-key&#x27;</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">&#x27;us&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-Telegram：第三方工具-prometheus-alertmanager-telegram"><a href="#8-Telegram：第三方工具-prometheus-alertmanager-telegram" class="headerlink" title="8. Telegram：第三方工具 prometheus-alertmanager-telegram"></a>8. <strong>Telegram</strong>：第三方工具 <code>prometheus-alertmanager-telegram</code></h4><ul>
<li><strong>项目链接</strong>：<a target="_blank" rel="noopener" href="https://github.com/InVisionApp/prometheus-alertmanager-telegram">GitHub - InVisionApp&#x2F;prometheus-alertmanager-telegram</a><br>支持通过 Telegram Bot 发送告警消息，支持模板和群组通知。</li>
</ul>
<h3 id="三、通用集成方案：Webhook-自定义"><a href="#三、通用集成方案：Webhook-自定义" class="headerlink" title="三、通用集成方案：Webhook 自定义"></a>三、通用集成方案：Webhook 自定义</h3><p>若上述工具无法满足需求，可通过 <strong>通用 Webhook</strong> 实现任意平台的告警集成。以飞书为例：</p>
<ol>
<li><p><strong>创建飞书机器人</strong>，获取 Webhook URL。</p>
</li>
<li><p>配置 Alertmanager：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;custom-webhook&#x27;</span></span><br><span class="line">  <span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-id&#x27;</span></span><br><span class="line">    <span class="attr">http_config:</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">Content-Type:</span> <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">      <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;msg_type&quot;: &quot;interactive&quot;,</span></span><br><span class="line"><span class="string">          &quot;card&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;elements&quot;: [</span></span><br><span class="line"><span class="string">              &#123;</span></span><br><span class="line"><span class="string">                &quot;tag&quot;: &quot;div&quot;,</span></span><br><span class="line"><span class="string">                &quot;text&quot;: &#123;</span></span><br><span class="line"><span class="string">                  &quot;content&quot;: &quot;【&#123;&#123; .Status | toUpper &#125;&#125;】&#123;&#123; .CommonLabels.alertname &#125;&#125;&quot;,</span></span><br><span class="line"><span class="string">                  &quot;tag&quot;: &quot;lark_md&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>自定义消息格式</strong>：<br>通过 JSON 或 YAML 格式定义消息内容，支持飞书的交互式卡片（如按钮、跳转链接）。</p>
</li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/LightningJie">GitHub</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus%E5%86%85%E5%AE%B9%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">Prometheus内容详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.1.</span> <span class="toc-text">Prometheus 监控系统的架构图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E6%A8%A1%E5%9D%97"><span class="toc-number">1.1.1.</span> <span class="toc-text">框架模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Short-lived-jobs%EF%BC%88%E7%9F%AD%E6%9C%9F%E4%BD%9C%E4%B8%9A%EF%BC%89"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">Short - lived jobs（短期作业）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pushgateway"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Pushgateway</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service-discovery%EF%BC%88%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%89"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">Service discovery（服务发现）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.1.4.1.</span> <span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.1.4.2.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.1.4.3.</span> <span class="toc-text">关键组件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%97%A5%E5%BF%97"><span class="toc-number">1.1.1.4.4.</span> <span class="toc-text">监控与日志</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.1.4.5.</span> <span class="toc-text">实际应用场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file-sd"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">file_sd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus-server"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">Prometheus server</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Retrieval"><span class="toc-number">1.1.1.6.1.</span> <span class="toc-text">Retrieval</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TSDB%EF%BC%88Time-Series-Database%EF%BC%8C%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89"><span class="toc-number">1.1.1.6.2.</span> <span class="toc-text">TSDB（Time Series Database，时间序列数据库）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HTTP-server"><span class="toc-number">1.1.1.6.3.</span> <span class="toc-text">HTTP server</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exporter"><span class="toc-number">1.1.1.7.</span> <span class="toc-text">Exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">1.1.1.7.1.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.1.1.7.2.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.1.7.3.</span> <span class="toc-text">常见类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Exporter"><span class="toc-number">1.1.1.7.4.</span> <span class="toc-text">自定义 Exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#blackbox-exporter"><span class="toc-number">1.1.1.7.5.</span> <span class="toc-text">blackbox_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#consul-exporter"><span class="toc-number">1.1.1.7.6.</span> <span class="toc-text">consul_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#graphite-exporter"><span class="toc-number">1.1.1.7.7.</span> <span class="toc-text">graphite_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#memcached-exporter"><span class="toc-number">1.1.1.7.8.</span> <span class="toc-text">memcached_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mysqld-exporter"><span class="toc-number">1.1.1.7.9.</span> <span class="toc-text">mysqld_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#node-exporter"><span class="toc-number">1.1.1.7.10.</span> <span class="toc-text">node_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#statsd-exporter"><span class="toc-number">1.1.1.7.11.</span> <span class="toc-text">statsd_exporter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jobs-exporters%EF%BC%88%E4%BD%9C%E4%B8%9A-%E5%AF%BC%E5%87%BA%E5%99%A8%EF%BC%89"><span class="toc-number">1.1.1.8.</span> <span class="toc-text">Jobs&#x2F;exporters（作业 &#x2F; 导出器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node%EF%BC%88%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">1.1.1.9.</span> <span class="toc-text">Node（节点）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus-alerting"><span class="toc-number">1.1.1.10.</span> <span class="toc-text">Prometheus alerting</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AD%A6%E6%8A%A5%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.1.10.1.</span> <span class="toc-text">警报规则配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Alertmanager-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.1.10.2.</span> <span class="toc-text">Alertmanager 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AD%A6%E6%8A%A5%E6%8E%A5%E6%94%B6%E6%96%B9%E5%BC%8F"><span class="toc-number">1.1.1.10.3.</span> <span class="toc-text">警报接收方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PromQL"><span class="toc-number">1.1.1.11.</span> <span class="toc-text">PromQL</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.1.11.1.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.1.11.2.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">1.1.1.11.3.</span> <span class="toc-text">操作符</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.1.11.4.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.1.11.5.</span> <span class="toc-text">查询示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus-web-UI"><span class="toc-number">1.1.1.12.</span> <span class="toc-text">Prometheus web UI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Grafana"><span class="toc-number">1.1.1.13.</span> <span class="toc-text">Grafana</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API-clients%EF%BC%88API-%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89"><span class="toc-number">1.1.1.14.</span> <span class="toc-text">API clients（API 客户端）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8-1"><span class="toc-number">1.1.1.14.1.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84-API-%E5%AE%A2%E6%88%B7%E7%AB%AF8888"><span class="toc-number">1.1.1.14.2.</span> <span class="toc-text">常用的 API 客户端8888</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">1.1.1.14.3.</span> <span class="toc-text">优势</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E6%9D%A1%E9%83%A8%E5%88%86"><span class="toc-number">1.1.2.</span> <span class="toc-text">线条部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">Prometheus的数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E5%90%8D%E7%A7%B0%E5%92%8C%E6%A0%87%E7%AD%BE"><span class="toc-number">1.2.1.</span> <span class="toc-text">指标名称和标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E7%9A%84%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%EF%BC%884%E7%A7%8D%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">Prometheus的指标类型（4种）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Counter"><span class="toc-number">1.3.1.</span> <span class="toc-text">Counter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gauge"><span class="toc-number">1.3.2.</span> <span class="toc-text">Gauge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Histogram"><span class="toc-number">1.3.3.</span> <span class="toc-text">Histogram</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">举例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E8%A7%82%E6%B5%8B%E4%B8%8E%E6%A1%B6%E8%AE%A1%E6%95%B0"><span class="toc-number">1.3.3.1.1.</span> <span class="toc-text">样本观测与桶计数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E6%9A%B4%E9%9C%B2%E7%9A%84%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97"><span class="toc-number">1.3.3.1.2.</span> <span class="toc-text">直方图暴露的时间序列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%B8%B8%E8%A7%81%E7%94%A8%E9%80%94"><span class="toc-number">1.3.3.1.3.</span> <span class="toc-text">直方图的常见用途</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary-1888%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E9%BB%98%E8%AE%A4%E5%80%BC%EF%BC%8C%E3%80%90%E3%80%91"><span class="toc-number">1.3.4.</span> <span class="toc-text">Summary (1888滑动时间默认值，【】)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%98%E8%A6%81%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E7%94%A8%E9%80%94"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">摘要的定义和用途</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%98%E8%A6%81%E6%9A%B4%E9%9C%B2%E7%9A%84%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">摘要暴露的时间序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%CF%86-%E5%88%86%E4%BD%8D%E6%95%B0"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">φ-分位数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%98%E8%A6%81%E4%B8%8E%E7%9B%B4%E6%96%B9%E5%9B%BE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">摘要与直方图的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%91%98%E8%A6%81"><span class="toc-number">1.3.4.5.</span> <span class="toc-text">使用摘要</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AA%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.5.</span> <span class="toc-text">指标类型为什么只在客户端分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%9C%E5%AE%89%E8%A3%85%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%E2%80%9D-%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">“安装指标类型” 的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E6%97%B6%E4%B8%8D%E5%8C%BA%E5%88%86%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">内部存储时不区分指标类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="toc-number">1.4.2.</span> <span class="toc-text">指标类型信息的记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E5%85%B3%E8%81%94"><span class="toc-number">1.4.3.</span> <span class="toc-text">元数据的存储与关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%92%8C%E5%B1%95%E7%A4%BA%E6%97%B6%E5%88%A9%E7%94%A8%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.4.</span> <span class="toc-text">查询和展示时利用类型信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E7%B1%BB%E6%AF%94"><span class="toc-number">1.4.5.</span> <span class="toc-text">过程类比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">Prometheus部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">2.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2prometheus"><span class="toc-number">2.2.</span> <span class="toc-text">安装部署prometheus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsystemd%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.</span> <span class="toc-text">创建systemd服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#systemctl-%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.1.</span> <span class="toc-text">systemctl 命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7Linux%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.4.</span> <span class="toc-text">监控Linux服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.</span> <span class="toc-text">全局配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#evaluation"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">evaluation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%E8%AF%84%E4%BC%B0"><span class="toc-number">2.5.1.1.1.</span> <span class="toc-text">记录规则评估</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E8%AF%84%E4%BC%B0"><span class="toc-number">2.5.1.1.2.</span> <span class="toc-text">告警规则评估</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#external-labels"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">external_labels</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8E-Alertmanager-%E9%80%9A%E4%BF%A1%E6%97%B6%E6%A0%87%E7%AD%BE%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.5.1.2.1.</span> <span class="toc-text">与 Alertmanager 通信时标签的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8E%E8%BF%9C%E7%A8%8B%E5%AD%98%E5%82%A8%E9%80%9A%E4%BF%A1%E6%97%B6%E6%A0%87%E7%AD%BE%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.5.1.2.2.</span> <span class="toc-text">与远程存储通信时标签的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E6%90%BA%E5%B8%A6%E6%A0%87%E7%AD%BE%E9%94%99%E8%AF%AF"><span class="toc-number">2.5.1.2.3.</span> <span class="toc-text">避免携带标签错误</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#query-log-file"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">query_log_file</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#scrape-config-files"><span class="toc-number">2.5.1.4.</span> <span class="toc-text">scrape_config_files</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E5%88%97%E8%A1%A8"><span class="toc-number">2.5.1.4.1.</span> <span class="toc-text">通配符列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%BD%E5%8A%A0%E5%88%B0%E6%8A%93%E5%8F%96%E9%85%8D%E7%BD%AE%E5%88%97%E8%A1%A8"><span class="toc-number">2.5.1.4.2.</span> <span class="toc-text">配置追加到抓取配置列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">2.5.1.4.3.</span> <span class="toc-text">示例说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alerting"><span class="toc-number">2.5.1.5.</span> <span class="toc-text">alerting</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#alert-relabel-configs"><span class="toc-number">2.5.1.5.1.</span> <span class="toc-text">alert_relabel_configs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#alertmanagers"><span class="toc-number">2.5.1.5.2.</span> <span class="toc-text">alertmanagers</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AAalertmanagers"><span class="toc-number">2.5.1.5.3.</span> <span class="toc-text">配置多个alertmanagers</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#storage"><span class="toc-number">2.5.1.6.</span> <span class="toc-text">storage</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#tsdb-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.6.1.</span> <span class="toc-text">tsdb 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#exemplars-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.6.2.</span> <span class="toc-text">exemplars 配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scrape-config"><span class="toc-number">2.5.2.</span> <span class="toc-text">scrape_config</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#params"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">params</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.6.</span> <span class="toc-text">查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0-1"><span class="toc-number">2.6.1.</span> <span class="toc-text">函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">2.7.</span> <span class="toc-text">存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E5%B8%83%E5%B1%80"><span class="toc-number">2.7.1.</span> <span class="toc-text">磁盘布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.7.2.</span> <span class="toc-text">数据目录示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%9D%97%E5%8F%AA%E6%9C%89-meta-json-%E6%96%87%E4%BB%B6%E8%80%8C%E6%97%A0%E5%85%B6%E4%BB%96%E6%96%87%E4%BB%B6%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">2.7.3.</span> <span class="toc-text">部分块只有 meta.json 文件而无其他文件的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8E%8B%E5%AE%9E"><span class="toc-number">2.7.4.</span> <span class="toc-text">数据压实</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.5.</span> <span class="toc-text">本地存储配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F%E5%A4%84%E7%90%86"><span class="toc-number">2.7.6.</span> <span class="toc-text">容量规划与数据损坏处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E7%AD%96%E7%95%A5"><span class="toc-number">2.7.7.</span> <span class="toc-text">保留策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%AD%98%E5%82%A8%E9%9B%86%E6%88%90"><span class="toc-number">2.7.8.</span> <span class="toc-text">远程存储集成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">2.8.</span> <span class="toc-text">服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%88File-Based-SD%EF%BC%89"><span class="toc-number">2.8.1.</span> <span class="toc-text">文件服务发现（File - Based SD）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes-%E5%8F%91%E7%8E%B0"><span class="toc-number">2.8.2.</span> <span class="toc-text">Kubernetes 发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%88HTTP-SD%EF%BC%89"><span class="toc-number">2.8.3.</span> <span class="toc-text">HTTP 服务发现（HTTP SD）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consul%E5%8F%91%E7%8E%B0"><span class="toc-number">2.8.4.</span> <span class="toc-text">consul发现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#relabeling"><span class="toc-number">2.9.</span> <span class="toc-text">relabeling</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.9.1.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.9.2.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E9%87%8D%E6%96%B0%E6%A0%87%E8%AE%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.9.3.</span> <span class="toc-text">常用的重新标记配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.9.4.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prometheus%E5%AE%9E%E6%88%98"><span class="toc-number">3.</span> <span class="toc-text">Prometheus实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%91%E6%8E%A7"><span class="toc-number">3.1.</span> <span class="toc-text">Linux服务器监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85node-exporter"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.服务器安装node_exporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B8%B8%E7%94%A8%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">3.1.2.</span> <span class="toc-text">2.常用监控指标</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E7%9B%91%E6%8E%A7"><span class="toc-number">3.2.</span> <span class="toc-text">mysql监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.1.</span> <span class="toc-text">参数详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">3.2.2.</span> <span class="toc-text">常用监控指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">3.2.3.</span> <span class="toc-text">告警规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7"><span class="toc-number">3.3.</span> <span class="toc-text">黑盒监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-HTTP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.1.</span> <span class="toc-text">1. HTTP 探测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http-2xx%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">http_2xx配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http-post-2xx-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">http_post_2xx 配置示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-TCP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.2.</span> <span class="toc-text">2. TCP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ICMP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.3.</span> <span class="toc-text">3. ICMP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-DNS-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.4.</span> <span class="toc-text">4. DNS 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-SMTP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.5.</span> <span class="toc-text">5. SMTP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-POP3-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.6.</span> <span class="toc-text">6. POP3 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-IMAP-%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.3.7.</span> <span class="toc-text">7. IMAP 探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">3.3.8.</span> <span class="toc-text">部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pushgateway-1"><span class="toc-number">3.4.</span> <span class="toc-text">Pushgateway</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#curl-%E6%8E%A8%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">3.4.1.</span> <span class="toc-text">curl 推送消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python-%E6%8E%A8%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">3.4.2.</span> <span class="toc-text">python  推送消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.</span> <span class="toc-text">告警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%AE%E7%AE%B1%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.1.</span> <span class="toc-text">邮箱告警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.2.</span> <span class="toc-text">企业钉钉告警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.3.</span> <span class="toc-text">企业微信告警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A3%9E%E4%B9%A6%E5%91%8A%E8%AD%A6"><span class="toc-number">3.5.4.</span> <span class="toc-text">飞书告警</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%93%BE%E6%8E%A5%EF%BC%9A"><span class="toc-number">3.5.4.1.</span> <span class="toc-text">项目链接：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">3.5.4.2.</span> <span class="toc-text">使用方式：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%EF%BC%9A"><span class="toc-number">3.5.4.3.</span> <span class="toc-text">特性：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E7%AD%94%EF%BC%9A"><span class="toc-number">3.6.</span> <span class="toc-text">问题解答：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A3%9E%E4%B9%A6%E5%91%8A%E8%AD%A6%E5%B7%A5%E5%85%B7%EF%BC%9Aalertmanager-webhook-feishu"><span class="toc-number">3.6.1.</span> <span class="toc-text">一、飞书告警工具：alertmanager-webhook-feishu</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%93%BE%E6%8E%A5%EF%BC%9A-1"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">项目链接：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A-1"><span class="toc-number">3.6.1.2.</span> <span class="toc-text">使用方式：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%EF%BC%9A-1"><span class="toc-number">3.6.1.3.</span> <span class="toc-text">特性：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E7%9A%84%E5%91%8A%E8%AD%A6%E9%9B%86%E6%88%90%E5%B7%A5%E5%85%B7"><span class="toc-number">3.6.2.</span> <span class="toc-text">二、其他常用软件的告警集成工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%92%89%E9%92%89%EF%BC%9Aprometheus-webhook-dingtalk"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">1. 钉钉：prometheus-webhook-dingtalk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%EF%BC%9Awebhook-wechat"><span class="toc-number">3.6.2.2.</span> <span class="toc-text">2. 企业微信：webhook-wechat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Slack%EF%BC%9A%E5%AE%98%E6%96%B9-Webhook-%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.3.</span> <span class="toc-text">3. Slack：官方 Webhook 集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Microsoft-Teams%EF%BC%9A%E5%AE%98%E6%96%B9-Webhook-%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.4.</span> <span class="toc-text">4. Microsoft Teams：官方 Webhook 集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Email%EF%BC%9AAlertmanager-%E5%86%85%E7%BD%AE%E6%94%AF%E6%8C%81"><span class="toc-number">3.6.2.5.</span> <span class="toc-text">5. Email：Alertmanager 内置支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-PagerDuty%EF%BC%9A%E5%AE%98%E6%96%B9%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.6.</span> <span class="toc-text">6. PagerDuty：官方集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-Opsgenie%EF%BC%9A%E5%AE%98%E6%96%B9%E9%9B%86%E6%88%90"><span class="toc-number">3.6.2.7.</span> <span class="toc-text">7. Opsgenie：官方集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-Telegram%EF%BC%9A%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7-prometheus-alertmanager-telegram"><span class="toc-number">3.6.2.8.</span> <span class="toc-text">8. Telegram：第三方工具 prometheus-alertmanager-telegram</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%80%9A%E7%94%A8%E9%9B%86%E6%88%90%E6%96%B9%E6%A1%88%EF%BC%9AWebhook-%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">3.6.3.</span> <span class="toc-text">三、通用集成方案：Webhook 自定义</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&text=Prometheus内容详解"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&is_video=false&description=Prometheus内容详解"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Prometheus内容详解&body=Check out this article: http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&title=Prometheus内容详解"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&name=Prometheus内容详解&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/12/28/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/Prometheus/&t=Prometheus内容详解"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2025
    LightningJie
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/LightningJie">GitHub</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
